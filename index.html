<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>2026 Flux Timer</title>
    <style>
        :root {
            --bg: #0a0a0a;
            --text: #f5f5f5;
            --accent: #3b82f6;
            --surface: #171717;
            --font-mono: 'SF Mono', 'Menlo', 'Monaco', 'Courier New', monospace;
        }

        body {
            background-color: var(--bg);
            color: var(--text);
            font-family: -apple-system, BlinkMacSystemFont, "Segoe UI", Roboto, sans-serif;
            height: 100vh;
            margin: 0;
            display: grid;
            place-items: center;
            overflow: hidden;
            transition: background 0.3s;
        }

        /* 极简容器 */
        main {
            text-align: center;
            width: 100%;
            max-width: 600px;
            padding: 2rem;
        }

        /* 倒计时显示区 */
        #display {
            font-family: var(--font-mono);
            font-size: clamp(3rem, 15vw, 8rem);
            font-weight: 200;
            letter-spacing: -2px;
            /* 关键：等宽数字，防止秒数变化时抖动 */
            font-variant-numeric: tabular-nums;
            line-height: 1;
            margin-bottom: 2rem;
            opacity: 0; /* 初始隐藏，加载JS后显示 */
            transform: translateY(20px);
            transition: opacity 0.6s ease-out, transform 0.6s ease-out;
        }

        #display.active {
            opacity: 1;
            transform: translateY(0);
        }

        /* 控制区域 */
        .controls {
            display: flex;
            flex-direction: column;
            align-items: center;
            gap: 1.5rem;
        }

        /* 现代化的输入框 */
        .input-group {
            background: var(--surface);
            padding: 1rem 1.5rem;
            border-radius: 20px;
            display: flex;
            align-items: center;
            gap: 1rem;
            box-shadow: 0 4px 20px rgba(0,0,0,0.4);
            transition: transform 0.2s, opacity 0.3s;
        }

        label {
            font-size: 0.9rem;
            opacity: 0.7;
            white-space: nowrap;
        }

        input[type="time"] {
            background: transparent;
            border: none;
            color: var(--text);
            font-size: 1.5rem;
            font-family: inherit;
            outline: none;
            cursor: pointer;
        }

        input[type="time"]::-webkit-calendar-picker-indicator {
            filter: invert(1);
            cursor: pointer;
        }

        /* 按钮样式 */
        button {
            background: var(--text);
            color: var(--bg);
            border: none;
            padding: 1rem 3rem;
            font-size: 1rem;
            font-weight: 600;
            border-radius: 50px;
            cursor: pointer;
            transition: transform 0.1s, opacity 0.2s;
        }

        button:active {
            transform: scale(0.95);
        }

        button.stop-btn {
            background: rgba(255, 99, 71, 0.2);
            color: #ff6347;
            border: 1px solid rgba(255, 99, 71, 0.3);
        }

        /* 状态切换 */
        .hidden {
            display: none !important;
        }

        .fade-in {
            animation: fadeIn 0.5s forwards;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }
    </style>
</head>
<body>

    <main>
        <div id="display" class="active">00:00:00</div>

        <div id="setup-panel" class="controls">
            <div class="input-group">
                <label>设置明天</label>
                <input type="time" id="target-time" value="08:00">
            </div>
            <button onclick="startCountdown()">开始倒计时</button>
        </div>

        <div id="running-panel" class="controls hidden">
            <div style="opacity: 0.5; margin-bottom: 10px; font-size: 0.9rem;">目标: 明天 <span id="target-display"></span></div>
            <button class="stop-btn" onclick="resetTimer()">取消</button>
        </div>
    </main>

    <script>
        const STORAGE_KEY = 'flux_timer_target';
        const displayEl = document.getElementById('display');
        const setupPanel = document.getElementById('setup-panel');
        const runningPanel = document.getElementById('running-panel');
        const targetDisplayEl = document.getElementById('target-display');
        let animationFrameId;

        // 初始化：检查是否有正在进行的倒计时
        (function init() {
            const savedTarget = localStorage.getItem(STORAGE_KEY);
            if (savedTarget) {
                const targetDate = parseInt(savedTarget, 10);
                if (targetDate > Date.now()) {
                    // 恢复倒计时
                    switchUI(true);
                    updateLoop(targetDate);
                    // 显示目标时间文本
                    const dateObj = new Date(targetDate);
                    targetDisplayEl.innerText = formatTimeDisplay(dateObj);
                } else {
                    // 时间已过，清理
                    localStorage.removeItem(STORAGE_KEY);
                    displayEl.innerText = "00:00:00";
                }
            }
        })();

        // 开始倒计时逻辑
        function startCountdown() {
            const timeInput = document.getElementById('target-time').value;
            if (!timeInput) return;

            const now = new Date();
            const [hours, minutes] = timeInput.split(':').map(Number);

            // 创建“明天”的时间对象
            const targetDate = new Date(now);
            targetDate.setDate(now.getDate() + 1); // 加一天
            targetDate.setHours(hours, minutes, 0, 0);

            const targetTimestamp = targetDate.getTime();

            // 持久化存储
            localStorage.setItem(STORAGE_KEY, targetTimestamp);
            
            // 更新UI
            targetDisplayEl.innerText = timeInput;
            switchUI(true);
            
            // 启动循环
            updateLoop(targetTimestamp);
        }

        // 核心循环：使用 requestAnimationFrame 保证流畅
        function updateLoop(targetTimestamp) {
            function step() {
                const now = Date.now();
                const diff = targetTimestamp - now;

                if (diff <= 0) {
                    // 倒计时结束
                    localStorage.removeItem(STORAGE_KEY);
                    displayEl.innerText = "00:00:00";
                    // 可以加入结束时的提示音或震动
                    switchUI(false);
                    return;
                }

                // 计算时分秒
                const h = Math.floor(diff / (1000 * 60 * 60));
                const m = Math.floor((diff % (1000 * 60 * 60)) / (1000 * 60));
                const s = Math.floor((diff % (1000 * 60)) / 1000);
                
                // 毫秒（可选，为了极简和省电，这里只显示到秒，如需毫秒可添加）
                // const ms = Math.floor((diff % 1000) / 10);

                // 格式化输出: 00:00:00
                displayEl.innerText = `${pad(h)}:${pad(m)}:${pad(s)}`;

                animationFrameId = requestAnimationFrame(step);
            }
            step();
        }

        // 重置/取消
        function resetTimer() {
            localStorage.removeItem(STORAGE_KEY);
            cancelAnimationFrame(animationFrameId);
            displayEl.innerText = "00:00:00";
            switchUI(false);
        }

        // UI 切换辅助函数
        function switchUI(isRunning) {
            if (isRunning) {
                setupPanel.classList.add('hidden');
                runningPanel.classList.remove('hidden');
                runningPanel.classList.add('fade-in');
            } else {
                setupPanel.classList.remove('hidden');
                setupPanel.classList.add('fade-in');
                runningPanel.classList.add('hidden');
            }
        }

        // 补零工具
        function pad(num) {
            return num.toString().padStart(2, '0');
        }

        // 格式化时间显示
        function formatTimeDisplay(date) {
            return date.getHours().toString().padStart(2, '0') + ':' + 
                   date.getMinutes().toString().padStart(2, '0');
        }
    </script>
</body>
</html>
