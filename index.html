<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>èŠå¤©</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <script src="https://cdn.tailwindcss.com"></script>
    <link href="https://cdnjs.cloudflare.com/ajax/libs/font-awesome/6.4.0/css/all.min.css" rel="stylesheet">
    <style>
        @import url('https://fonts.googleapis.com/css2?family=Plus+Jakarta+Sans:wght@300;500;700&display=swap');
        
        body { 
            font-family: 'Plus Jakarta Sans', sans-serif; 
            background-color: #0f172a;
            color: white;
            overflow: hidden;
        }

        /* ç£¨ç ‚ç»ç’ƒå®¹å™¨ */
        .glass-panel {
            background: rgba(255, 255, 255, 0.03);
            backdrop-filter: blur(20px);
            -webkit-backdrop-filter: blur(20px);
            border: 1px solid rgba(255, 255, 255, 0.08);
            box-shadow: 0 25px 50px -12px rgba(0, 0, 0, 0.5);
        }

        /* éšè—æ»šåŠ¨æ¡ */
        .scrollbar-hide::-webkit-scrollbar { display: none; }
        .scrollbar-hide { -ms-overflow-style: none; scrollbar-width: none; }

        /* åŠ¨ç”» */
        .fade-enter { opacity: 0; transform: scale(0.95); }
        .fade-enter-active { opacity: 1; transform: scale(1); transition: all 0.4s cubic-bezier(0.4, 0, 0.2, 1); }
        .fade-exit { opacity: 1; transform: scale(1); }
        .fade-exit-active { opacity: 0; transform: scale(0.95); transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1); }

        /* æ¶ˆæ¯æ°”æ³¡æ¸å˜ */
        .msg-gradient { background: linear-gradient(135deg, #3b82f6 0%, #8b5cf6 100%); }
        
        /* åŠ è½½åŠ¨ç”» */
        .loader { border: 3px solid rgba(255,255,255,0.1); border-left-color: #3b82f6; border-radius: 50%; width: 24px; height: 24px; animation: spin 1s linear infinite; }
        @keyframes spin { 0% { transform: rotate(0deg); } 100% { transform: rotate(360deg); } }
    </style>
</head>
<body class="h-screen w-screen relative selection:bg-blue-500 selection:text-white">

    <div class="absolute top-[-20%] left-[-10%] w-[50%] h-[50%] bg-blue-600/20 rounded-full blur-[120px] pointer-events-none"></div>
    <div class="absolute bottom-[-20%] right-[-10%] w-[50%] h-[50%] bg-purple-600/20 rounded-full blur-[120px] pointer-events-none"></div>

    <div id="app" class="relative z-10 w-full h-full flex flex-col items-center justify-center p-4">

        <div id="connect-screen" class="glass-panel w-full max-w-sm p-8 rounded-3xl transition-all duration-500">
            <div class="text-center mb-8">
                <div class="w-16 h-16 bg-gradient-to-tr from-blue-500 to-purple-500 rounded-2xl mx-auto flex items-center justify-center mb-4 shadow-lg shadow-blue-500/30">
                    <i class="fa-solid fa-bolt text-2xl text-white"></i>
                </div>
                <h1 class="text-2xl font-bold tracking-tight">æé€Ÿæµè¿ <span class="text-blue-400">2026</span></h1>
                <p class="text-slate-400 text-sm mt-2">P2P åŠ å¯† â€¢ æ— æœåŠ¡å™¨ä¸­è½¬</p>
            </div>

            <div class="space-y-6">
                <div class="bg-slate-800/50 p-4 rounded-xl border border-white/5 flex justify-between items-center group cursor-pointer hover:bg-slate-800 transition" onclick="copyId()">
                    <div>
                        <p class="text-xs text-slate-400 mb-1">æœ¬æœºè¿æ¥ç </p>
                        <p id="my-id" class="text-2xl font-mono font-bold tracking-wider text-white">------</p>
                    </div>
                    <i class="fa-regular fa-copy text-slate-500 group-hover:text-blue-400 transition"></i>
                </div>

                <div class="relative">
                    <input type="text" id="target-id" maxlength="6" placeholder="è¾“å…¥å¯¹æ–¹ 6 ä½ç " 
                        class="w-full bg-slate-800/50 text-white text-center text-xl font-mono p-4 rounded-xl border border-white/10 focus:border-blue-500 focus:ring-1 focus:ring-blue-500 outline-none transition-all placeholder:text-slate-600">
                </div>

                <button onclick="connectToPeer()" id="connect-btn" class="w-full py-4 bg-blue-600 hover:bg-blue-500 text-white font-semibold rounded-xl transition-all shadow-lg shadow-blue-600/20 active:scale-95 flex items-center justify-center gap-2">
                    <span>å‘èµ·è¿æ¥</span>
                    <i class="fa-solid fa-arrow-right"></i>
                </button>
                
                <p id="status-msg" class="text-center text-xs text-slate-500 h-4"></p>
            </div>
        </div>

        <div id="chat-screen" class="hidden w-full h-full max-w-2xl flex-col glass-panel rounded-2xl overflow-hidden shadow-2xl animate-fade">
            <div class="h-16 border-b border-white/5 flex items-center justify-between px-6 bg-slate-900/30 backdrop-blur-md">
                <div class="flex items-center gap-3">
                    <div class="relative">
                        <div class="w-10 h-10 bg-slate-700 rounded-full flex items-center justify-center">
                            <i class="fa-solid fa-user text-slate-400"></i>
                        </div>
                        <div class="absolute bottom-0 right-0 w-3 h-3 bg-green-500 rounded-full border-2 border-slate-900"></div>
                    </div>
                    <div>
                        <h3 class="font-semibold text-sm">å·²è¿æ¥è®¾å¤‡</h3>
                        <p class="text-xs text-green-400">P2P åŠ å¯†é€šé“æ´»è·ƒ</p>
                    </div>
                </div>
                <button onclick="disconnect()" class="w-8 h-8 rounded-full hover:bg-red-500/20 text-slate-400 hover:text-red-400 transition flex items-center justify-center">
                    <i class="fa-solid fa-power-off"></i>
                </button>
            </div>

            <div id="chat-box" class="flex-1 overflow-y-auto p-4 space-y-4 scrollbar-hide bg-slate-900/20">
                <div class="text-center py-4">
                    <span class="text-xs bg-slate-800/50 text-slate-400 px-3 py-1 rounded-full">é€šé“å·²å»ºç«‹ï¼Œæ‚¨å¯ä»¥å‘é€æ–‡å­—ã€å›¾ç‰‡æˆ–è§†é¢‘</span>
                </div>
            </div>

            <div id="progress-bar-container" class="hidden px-4 py-2 bg-slate-800/90 border-t border-white/5">
                <div class="flex justify-between text-xs text-slate-300 mb-1">
                    <span id="progress-text">æ­£åœ¨å‘é€æ–‡ä»¶...</span>
                    <span id="progress-percent">0%</span>
                </div>
                <div class="w-full bg-slate-700 rounded-full h-1.5">
                    <div id="progress-fill" class="bg-blue-500 h-1.5 rounded-full transition-all duration-300" style="width: 0%"></div>
                </div>
            </div>

            <div class="p-4 bg-slate-900/40 border-t border-white/5">
                <div id="preview-area" class="hidden mb-3 relative inline-block">
                    <img id="img-preview" class="h-20 rounded-lg border border-white/10 shadow-lg object-cover">
                    <div id="file-info-preview" class="hidden h-20 px-4 bg-slate-800 rounded-lg border border-white/10 flex items-center gap-3">
                        <i class="fa-solid fa-file text-blue-400 text-xl"></i>
                        <span id="preview-filename" class="text-sm truncate max-w-[150px]">filename.zip</span>
                    </div>
                    <button onclick="clearFile()" class="absolute -top-2 -right-2 w-5 h-5 bg-red-500 rounded-full text-xs flex items-center justify-center hover:bg-red-600 transition">Ã—</button>
                </div>

                <div class="flex gap-2 items-end">
                    <button onclick="document.getElementById('file-input').click()" class="w-12 h-12 rounded-xl bg-slate-800 hover:bg-slate-700 text-slate-400 hover:text-white transition flex items-center justify-center shrink-0">
                        <i class="fa-solid fa-paperclip"></i>
                    </button>
                    <input type="file" id="file-input" class="hidden" onchange="handleFileSelect(this)">
                    
                    <div class="flex-1 bg-slate-800 rounded-xl flex items-center px-4 min-h-[48px]">
                        <input type="text" id="msg-input" class="w-full bg-transparent border-none outline-none text-white placeholder-slate-500" placeholder="å‘é€æ¶ˆæ¯..." onkeypress="handleEnter(event)">
                    </div>

                    <button onclick="sendMessage()" class="w-12 h-12 rounded-xl bg-blue-600 hover:bg-blue-500 text-white transition shadow-lg shadow-blue-600/20 flex items-center justify-center shrink-0">
                        <i class="fa-solid fa-paper-plane"></i>
                    </button>
                </div>
            </div>
        </div>
    </div>

    <script>
        // --- æ ¸å¿ƒé…ç½® ---
        const PEER_CONFIG = {
            host: '0.peerjs.com', // ä½¿ç”¨ PeerJS å…è´¹å…¬å…±ä¿¡ä»¤æœåŠ¡å™¨
            port: 443,
            secure: true,
            config: {
                iceServers: [
                    { urls: 'stun:stun.l.google.com:19302' }, // Google å…¬å…± STUN (æ‰“æ´)
                    { urls: 'stun:stun1.l.google.com:19302' }
                ]
            }
        };

        // ç”Ÿæˆ 6 ä½éšæœºç  (100000 - 999999)
        const generateId = () => Math.floor(100000 + Math.random() * 900000).toString();
        const myId = generateId();
        
        // --- çŠ¶æ€å˜é‡ ---
        let peer;
        let conn;
        let fileChunks = [];
        let receivingFile = null;

        // --- åˆå§‹åŒ– PeerJS ---
        function initPeer() {
            updateStatus('æ­£åœ¨è¿æ¥å…¬å…±ç½‘ç»œ...', 'text-slate-500');
            
            peer = new Peer(myId, PEER_CONFIG);

            peer.on('open', (id) => {
                document.getElementById('my-id').innerText = id;
                updateStatus('ç½‘ç»œå°±ç»ªï¼Œç­‰å¾…è¿æ¥', 'text-green-500');
            });

            // è¢«åŠ¨è¿æ¥ (ä½œä¸ºæ¥æ”¶æ–¹)
            peer.on('connection', (connection) => {
                conn = connection;
                setupConnection();
                switchToChat();
                // è‡ªåŠ¨å›å¡«å¯¹æ–¹IDæ–¹ä¾¿è¯†åˆ«
                document.getElementById('target-id').value = conn.peer;
            });

            peer.on('error', (err) => {
                console.error(err);
                if(err.type === 'peer-unavailable') {
                    updateStatus('æ‰¾ä¸åˆ°è¯¥ IDï¼Œè¯·æ£€æŸ¥å¯¹æ–¹æ˜¯å¦åœ¨çº¿', 'text-red-500');
                    resetBtn();
                } else {
                    updateStatus('ç½‘ç»œé”™è¯¯ï¼Œè¯·åˆ·æ–°é‡è¯•', 'text-red-500');
                }
            });
        }

        // --- ä¸»åŠ¨è¿æ¥é€»è¾‘ ---
        function connectToPeer() {
            const targetId = document.getElementById('target-id').value;
            if (targetId.length !== 6) {
                updateStatus('è¯·è¾“å…¥ 6 ä½æœ‰æ•ˆè¿æ¥ç ', 'text-yellow-500');
                return;
            }
            if (targetId === myId) {
                updateStatus('ä¸èƒ½è¿æ¥è‡ªå·±', 'text-yellow-500');
                return;
            }

            const btn = document.getElementById('connect-btn');
            btn.innerHTML = '<div class="loader"></div>';
            btn.disabled = true;

            conn = peer.connect(targetId);
            
            // å¿…é¡»ç­‰å¾… open äº‹ä»¶
            conn.on('open', () => {
                setupConnection();
                switchToChat();
            });

            // 3ç§’è¿ä¸ä¸Šåˆ™é‡ç½® (PeerJSæœ‰æ—¶è¶…æ—¶ä¸æŠ¥é”™)
            setTimeout(() => {
                if(!conn.open) {
                    resetBtn();
                    updateStatus('è¿æ¥è¶…æ—¶ï¼Œè¯·é‡è¯•', 'text-red-500');
                }
            }, 5000);
        }

        // --- è¿æ¥å»ºç«‹åçš„é€šç”¨å¤„ç† ---
        function setupConnection() {
            conn.on('data', (data) => {
                if (data.type === 'text') {
                    appendMessage(data.content, false);
                } else if (data.type === 'file-header') {
                    startReceivingFile(data);
                } else if (data.type === 'file-chunk') {
                    receiveChunk(data.content);
                } else if (data.type === 'file-end') {
                    finishReceivingFile();
                }
            });

            conn.on('close', () => {
                alert('å¯¹æ–¹å·²æ–­å¼€è¿æ¥');
                location.reload();
            });
        }

        // --- æ–‡ä»¶ä¼ è¾“é€»è¾‘ (æ ¸å¿ƒéš¾ç‚¹: åˆ‡ç‰‡) ---
        const CHUNK_SIZE = 16 * 1024; // 16KB åˆ‡ç‰‡ (WebRTC æœ€å®‰å…¨çš„å¤§å°)

        async function sendFile(file) {
            if (!conn || !conn.open) return;

            // 1. å‘é€æ–‡ä»¶å¤´
            conn.send({
                type: 'file-header',
                name: file.name,
                size: file.size,
                fileType: file.type
            });

            // æœ¬åœ°æ˜¾ç¤º
            appendFileMessage(URL.createObjectURL(file), file.name, file.type, true);
            showProgress(true);

            // 2. è¯»å–å¹¶åˆ‡ç‰‡å‘é€
            let offset = 0;
            const reader = new FileReader();

            reader.onload = (e) => {
                conn.send({
                    type: 'file-chunk',
                    content: e.target.result
                });

                offset += e.target.result.byteLength;
                updateProgressBar(offset, file.size);

                if (offset < file.size) {
                    readNextChunk();
                } else {
                    conn.send({ type: 'file-end' });
                    showProgress(false);
                    clearFile(); // å‘é€å®Œæˆåæ¸…é™¤è¾“å…¥æ¡†
                }
            };

            const readNextChunk = () => {
                const slice = file.slice(offset, offset + CHUNK_SIZE);
                reader.readAsArrayBuffer(slice);
            };

            readNextChunk();
        }

        // --- æ–‡ä»¶æ¥æ”¶é€»è¾‘ ---
        function startReceivingFile(header) {
            receivingFile = header;
            fileChunks = [];
            appendSystemMessage(`æ­£åœ¨æ¥æ”¶ ${header.name}...`);
        }

        function receiveChunk(buffer) {
            fileChunks.push(buffer);
            // è¿™é‡Œå¯ä»¥æ·»åŠ æ¥æ”¶è¿›åº¦è®¡ç®—ï¼Œæš‚ç•¥ä»¥ä¿æŒä»£ç ç®€æ´
        }

        function finishReceivingFile() {
            const blob = new Blob(fileChunks, { type: receivingFile.fileType });
            const url = URL.createObjectURL(blob);
            appendFileMessage(url, receivingFile.name, receivingFile.fileType, false);
            fileChunks = [];
            receivingFile = null;
        }

        // --- UI æ“ä½œé€»è¾‘ ---
        function sendMessage() {
            const textInput = document.getElementById('msg-input');
            const fileInput = document.getElementById('file-input');
            const text = textInput.value;
            const file = fileInput.files[0];

            if (file) {
                sendFile(file);
            }

            if (text) {
                if(conn && conn.open) {
                    conn.send({ type: 'text', content: text });
                    appendMessage(text, true);
                    textInput.value = '';
                }
            }
        }

        function handleFileSelect(input) {
            const file = input.files[0];
            if (!file) return;

            const previewArea = document.getElementById('preview-area');
            const imgPreview = document.getElementById('img-preview');
            const infoPreview = document.getElementById('file-info-preview');
            const nameSpan = document.getElementById('preview-filename');

            previewArea.classList.remove('hidden');

            if (file.type.startsWith('image/')) {
                imgPreview.src = URL.createObjectURL(file);
                imgPreview.classList.remove('hidden');
                infoPreview.classList.add('hidden');
            } else {
                imgPreview.classList.add('hidden');
                infoPreview.classList.remove('hidden');
                infoPreview.classList.add('flex');
                nameSpan.innerText = file.name;
            }
        }

        function clearFile() {
            document.getElementById('file-input').value = '';
            document.getElementById('preview-area').classList.add('hidden');
        }

        function appendMessage(text, isSelf) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `flex w-full ${isSelf ? 'justify-end' : 'justify-start'} animate-fade`;
            div.innerHTML = `
                <div class="max-w-[80%] px-4 py-3 rounded-2xl text-sm ${isSelf ? 'msg-gradient text-white rounded-tr-sm' : 'bg-slate-800 text-slate-200 rounded-tl-sm'} shadow-md break-words">
                    ${text}
                </div>
            `;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function appendFileMessage(url, name, type, isSelf) {
            const box = document.getElementById('chat-box');
            const div = document.createElement('div');
            div.className = `flex w-full ${isSelf ? 'justify-end' : 'justify-start'} animate-fade`;
            
            let content;
            if (type.startsWith('image/')) {
                content = `<img src="${url}" class="rounded-lg max-h-48 cursor-pointer hover:opacity-90 transition" onclick="window.open('${url}')">`;
            } else if (type.startsWith('video/')) {
                content = `<video src="${url}" controls class="rounded-lg max-h-48 w-full"></video>`;
            } else {
                content = `
                    <div class="flex items-center gap-3 p-2">
                        <div class="w-10 h-10 bg-white/10 rounded-lg flex items-center justify-center text-xl">ğŸ“„</div>
                        <div class="overflow-hidden">
                            <p class="truncate font-medium">${name}</p>
                            ${!isSelf ? `<a href="${url}" download="${name}" class="text-xs text-blue-300 hover:text-white underline mt-1">ç‚¹å‡»ä¸‹è½½</a>` : ''}
                        </div>
                    </div>
                `;
            }

            div.innerHTML = `
                <div class="max-w-[80%] p-2 rounded-2xl ${isSelf ? 'msg-gradient text-white rounded-tr-sm' : 'bg-slate-800 text-slate-200 rounded-tl-sm'} shadow-md">
                    ${content}
                </div>
            `;
            box.appendChild(div);
            box.scrollTop = box.scrollHeight;
        }

        function appendSystemMessage(text) {
            const box = document.getElementById('chat-box');
            box.innerHTML += `<div class="text-center my-2"><span class="text-xs text-slate-600 bg-slate-900/50 px-2 py-1 rounded">${text}</span></div>`;
            box.scrollTop = box.scrollHeight;
        }

        // --- è¾…åŠ©åŠŸèƒ½ ---
        function switchToChat() {
            document.getElementById('connect-screen').classList.add('opacity-0', 'scale-95');
            setTimeout(() => {
                document.getElementById('connect-screen').style.display = 'none';
                document.getElementById('chat-screen').classList.remove('hidden');
                document.getElementById('chat-screen').classList.add('flex');
            }, 500);
        }

        function updateStatus(msg, colorClass) {
            const el = document.getElementById('status-msg');
            el.innerText = msg;
            el.className = `text-center text-xs h-4 ${colorClass}`;
        }

        function resetBtn() {
            const btn = document.getElementById('connect-btn');
            btn.innerHTML = '<span>å‘èµ·è¿æ¥</span><i class="fa-solid fa-arrow-right"></i>';
            btn.disabled = false;
        }

        function copyId() {
            navigator.clipboard.writeText(myId);
            const originalText = document.getElementById('my-id').innerText;
            document.getElementById('my-id').innerText = "å·²å¤åˆ¶!";
            setTimeout(() => document.getElementById('my-id').innerText = originalText, 1500);
        }

        function showProgress(show) {
            document.getElementById('progress-bar-container').classList.toggle('hidden', !show);
        }

        function updateProgressBar(current, total) {
            const percent = Math.floor((current / total) * 100);
            document.getElementById('progress-fill').style.width = percent + '%';
            document.getElementById('progress-percent').innerText = percent + '%';
        }

        function handleEnter(e) {
            if (e.key === 'Enter') sendMessage();
        }

        function disconnect() {
            if(peer) peer.destroy();
            location.reload();
        }

        // å¯åŠ¨
        initPeer();

    </script>
</body>
</html>
