<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, user-scalable=no">
    <meta name="apple-mobile-web-app-capable" content="yes">
    <meta name="mobile-web-app-capable" content="yes">
    <title>æ™ºèƒ½è¿åŠ¨æ£€æµ‹ç³»ç»Ÿ Pro</title>
    <style>
        * {
            margin: 0;
            padding: 0;
            box-sizing: border-box;
        }

        :root {
            --primary-color: #667eea;
            --primary-dark: #5568d3;
            --secondary-color: #764ba2;
            --success-color: #4caf50;
            --warning-color: #ff9800;
            --danger-color: #f44336;
            --info-color: #2196f3;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
            --card-shadow: 0 2px 12px rgba(0, 0, 0, 0.08);
            --card-shadow-hover: 0 4px 20px rgba(0, 0, 0, 0.12);
        }

        body {
            font-family: 'Roboto', -apple-system, BlinkMacSystemFont, 'Segoe UI', sans-serif;
            background: var(--bg-gradient);
            color: #333;
            overflow-x: hidden;
        }

        /* PCç«¯404æç¤º */
        .desktop-warning {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: var(--bg-gradient);
            z-index: 10000;
            justify-content: center;
            align-items: center;
            flex-direction: column;
            color: white;
            text-align: center;
            padding: 20px;
        }

        .desktop-warning h1 {
            font-size: 72px;
            margin-bottom: 20px;
            animation: pulse 2s ease-in-out infinite;
        }

        @keyframes pulse {
            0%, 100% { opacity: 1; }
            50% { opacity: 0.7; }
        }

        /* é¡¶éƒ¨å¯¼èˆªæ  */
        .nav-bar {
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            z-index: 1000;
            box-shadow: 0 2px 16px rgba(0, 0, 0, 0.1);
        }

        .nav-header {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 16px;
            border-bottom: 1px solid rgba(0, 0, 0, 0.05);
        }

        .nav-title {
            font-size: 18px;
            font-weight: 700;
            background: var(--bg-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
        }

        .nav-status {
            display: flex;
            align-items: center;
            gap: 12px;
        }

        .status-badge {
            display: flex;
            align-items: center;
            gap: 6px;
            padding: 6px 12px;
            border-radius: 20px;
            font-size: 12px;
            font-weight: 600;
            background: #f5f5f5;
        }

        .status-badge.active {
            background: linear-gradient(135deg, #4caf5020 0%, #8bc34a20 100%);
            color: var(--success-color);
        }

        .battery-indicator {
            display: flex;
            align-items: center;
            gap: 6px;
            font-size: 14px;
            font-weight: 600;
        }

        /* æ ‡ç­¾é¡µå¯¼èˆª */
        .tab-nav {
            display: flex;
            padding: 0 16px;
            background: white;
            overflow-x: auto;
            -webkit-overflow-scrolling: touch;
        }

        .tab-nav::-webkit-scrollbar {
            display: none;
        }

        .tab-btn {
            flex-shrink: 0;
            padding: 14px 20px;
            border: none;
            background: none;
            font-size: 14px;
            font-weight: 600;
            color: #666;
            cursor: pointer;
            position: relative;
            transition: color 0.3s;
        }

        .tab-btn.active {
            color: var(--primary-color);
        }

        .tab-btn.active::after {
            content: '';
            position: absolute;
            bottom: 0;
            left: 0;
            right: 0;
            height: 3px;
            background: var(--bg-gradient);
            border-radius: 3px 3px 0 0;
        }

        /* ä¸»å®¹å™¨ */
        .container {
            padding: 120px 16px 80px;
            max-width: 600px;
            margin: 0 auto;
        }

        .tab-content {
            display: none;
        }

        .tab-content.active {
            display: block;
            animation: fadeIn 0.3s ease;
        }

        @keyframes fadeIn {
            from { opacity: 0; transform: translateY(10px); }
            to { opacity: 1; transform: translateY(0); }
        }

        /* å¡ç‰‡æ ·å¼ */
        .card {
            background: white;
            border-radius: 16px;
            padding: 20px;
            margin-bottom: 16px;
            box-shadow: var(--card-shadow);
            transition: box-shadow 0.3s;
        }

        .card:active {
            box-shadow: var(--card-shadow-hover);
        }

        .card-title {
            font-size: 16px;
            font-weight: 700;
            margin-bottom: 16px;
            color: #333;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .card-title .icon {
            font-size: 20px;
        }

        /* è§†é¢‘é¢„è§ˆ */
        .video-container {
            position: relative;
            border-radius: 12px;
            overflow: hidden;
            background: #000;
            margin-bottom: 16px;
            box-shadow: 0 4px 20px rgba(0, 0, 0, 0.2);
        }

        #video {
            width: 100%;
            display: block;
        }

        #canvas {
            display: none;
        }

        .detection-box {
            position: absolute;
            border: 3px solid var(--success-color);
            box-shadow: 0 0 20px rgba(76, 175, 80, 0.5);
            transition: all 0.2s;
            pointer-events: none;
        }

        .detection-box.active {
            border-color: var(--danger-color);
            box-shadow: 0 0 30px rgba(244, 67, 54, 0.8);
        }

        .detection-info {
            position: absolute;
            top: 12px;
            left: 12px;
            background: rgba(0, 0, 0, 0.75);
            backdrop-filter: blur(10px);
            color: white;
            padding: 8px 12px;
            border-radius: 8px;
            font-size: 12px;
            font-weight: 600;
            display: flex;
            flex-direction: column;
            gap: 4px;
        }

        .intensity-bar {
            width: 100px;
            height: 4px;
            background: rgba(255, 255, 255, 0.3);
            border-radius: 2px;
            overflow: hidden;
        }

        .intensity-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), var(--danger-color));
            transition: width 0.2s;
        }

        /* æ§åˆ¶æŒ‰é’® */
        .controls {
            display: grid;
            grid-template-columns: 1fr 1fr auto;
            gap: 12px;
            margin-bottom: 16px;
        }

        .btn {
            padding: 14px 20px;
            border: none;
            border-radius: 12px;
            font-size: 15px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            gap: 8px;
            box-shadow: var(--card-shadow);
        }

        .btn-primary {
            background: var(--bg-gradient);
            color: white;
        }

        .btn-primary:active {
            transform: scale(0.96);
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.15);
        }

        .btn-secondary {
            background: white;
            color: #333;
            border: 2px solid #e0e0e0;
        }

        .btn-icon {
            width: 48px;
            height: 48px;
            padding: 0;
        }

        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }

        /* é¢„è®¾æ¨¡å¼ */
        .preset-modes {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 10px;
        }

        .preset-btn {
            padding: 16px 12px;
            border: 2px solid #e8e8e8;
            border-radius: 12px;
            background: white;
            cursor: pointer;
            transition: all 0.3s;
            font-size: 13px;
            text-align: center;
            font-weight: 600;
        }

        .preset-btn:active {
            transform: scale(0.96);
        }

        .preset-btn.active {
            border-color: var(--primary-color);
            background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%);
            color: var(--primary-color);
            box-shadow: 0 0 0 3px rgba(102, 126, 234, 0.1);
        }

        /* æ»‘å—æ§åˆ¶ */
        .slider-group {
            margin-bottom: 20px;
        }

        .slider-label {
            display: flex;
            justify-content: space-between;
            margin-bottom: 10px;
            font-size: 13px;
            font-weight: 600;
            color: #555;
        }

        .slider-value {
            color: var(--primary-color);
            font-size: 14px;
        }

        .slider {
            width: 100%;
            height: 6px;
            border-radius: 3px;
            background: linear-gradient(90deg, #e0e0e0, #f5f5f5);
            outline: none;
            -webkit-appearance: none;
        }

        .slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--bg-gradient);
            cursor: pointer;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
            transition: transform 0.2s;
        }

        .slider::-webkit-slider-thumb:active {
            transform: scale(1.2);
        }

        .slider::-moz-range-thumb {
            width: 22px;
            height: 22px;
            border-radius: 50%;
            background: var(--bg-gradient);
            cursor: pointer;
            border: none;
            box-shadow: 0 2px 8px rgba(0, 0, 0, 0.2);
        }

        /* é«˜çº§è®¾ç½® */
        .advanced-settings {
            max-height: 0;
            overflow: hidden;
            transition: max-height 0.4s ease;
        }

        .advanced-settings.show {
            max-height: 2000px;
        }

        /* ç»Ÿè®¡å¡ç‰‡ */
        .stats-grid {
            display: grid;
            grid-template-columns: repeat(2, 1fr);
            gap: 12px;
        }

        .stat-card {
            background: linear-gradient(135deg, #667eea08 0%, #764ba208 100%);
            padding: 20px;
            border-radius: 12px;
            text-align: center;
            border: 2px solid transparent;
            transition: all 0.3s;
        }

        .stat-card:active {
            border-color: var(--primary-color);
            transform: scale(0.96);
        }

        .stat-icon {
            font-size: 32px;
            margin-bottom: 8px;
        }

        .stat-value {
            font-size: 28px;
            font-weight: 700;
            background: var(--bg-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            display: block;
            margin-bottom: 4px;
        }

        .stat-label {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        /* ç”µæ± ä¿¡æ¯ */
        .battery-card {
            display: flex;
            align-items: center;
            gap: 20px;
            padding: 20px;
            background: linear-gradient(135deg, #667eea10 0%, #764ba210 100%);
            border-radius: 12px;
            margin-bottom: 16px;
        }

        .battery-icon-large {
            font-size: 48px;
        }

        .battery-details {
            flex: 1;
        }

        .battery-percent {
            font-size: 36px;
            font-weight: 700;
            background: var(--bg-gradient);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            margin-bottom: 8px;
        }

        .battery-bar {
            height: 8px;
            background: rgba(0, 0, 0, 0.1);
            border-radius: 4px;
            overflow: hidden;
            margin-bottom: 8px;
        }

        .battery-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--success-color), #8bc34a);
            transition: width 0.3s;
        }

        .battery-fill.low {
            background: linear-gradient(90deg, var(--danger-color), var(--warning-color));
        }

        .battery-text {
            font-size: 12px;
            color: #666;
            font-weight: 500;
        }

        /* æ—¥å¿—ç³»ç»Ÿ */
        .log-container {
            background: #1e1e1e;
            border-radius: 12px;
            overflow: hidden;
            box-shadow: var(--card-shadow);
        }

        .log-header {
            background: #2d2d2d;
            padding: 12px 16px;
            display: flex;
            justify-content: space-between;
            align-items: center;
            border-bottom: 1px solid #3d3d3d;
        }

        .log-title {
            color: #fff;
            font-size: 14px;
            font-weight: 600;
            display: flex;
            align-items: center;
            gap: 8px;
        }

        .log-actions {
            display: flex;
            gap: 8px;
        }

        .log-btn {
            padding: 6px 12px;
            border: none;
            border-radius: 6px;
            background: rgba(255, 255, 255, 0.1);
            color: white;
            font-size: 12px;
            font-weight: 600;
            cursor: pointer;
            transition: background 0.3s;
        }

        .log-btn:active {
            background: rgba(255, 255, 255, 0.2);
        }

        .log-filters {
            background: #252525;
            padding: 12px 16px;
            display: flex;
            gap: 8px;
            overflow-x: auto;
            border-bottom: 1px solid #3d3d3d;
        }

        .log-filters::-webkit-scrollbar {
            height: 4px;
        }

        .log-filters::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 2px;
        }

        .filter-chip {
            flex-shrink: 0;
            padding: 6px 12px;
            border-radius: 16px;
            background: rgba(255, 255, 255, 0.08);
            color: #aaa;
            font-size: 11px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
            border: 1px solid transparent;
        }

        .filter-chip.active {
            background: var(--primary-color);
            color: white;
        }

        .filter-chip.info { border-color: var(--info-color); }
        .filter-chip.success { border-color: var(--success-color); }
        .filter-chip.warning { border-color: var(--warning-color); }
        .filter-chip.error { border-color: var(--danger-color); }

        .log-content {
            max-height: 400px;
            overflow-y: auto;
            font-family: 'Monaco', 'Menlo', 'Courier New', monospace;
            font-size: 11px;
            line-height: 1.6;
            padding: 12px;
            background: #1e1e1e;
        }

        .log-content::-webkit-scrollbar {
            width: 6px;
        }

        .log-content::-webkit-scrollbar-thumb {
            background: #444;
            border-radius: 3px;
        }

        .log-entry {
            display: flex;
            gap: 8px;
            padding: 6px 8px;
            border-radius: 4px;
            margin-bottom: 2px;
            animation: slideIn 0.3s ease;
        }

        @keyframes slideIn {
            from {
                opacity: 0;
                transform: translateX(-10px);
            }
            to {
                opacity: 1;
                transform: translateX(0);
            }
        }

        .log-entry:hover {
            background: rgba(255, 255, 255, 0.05);
        }

        .log-time {
            color: #666;
            flex-shrink: 0;
            width: 70px;
        }

        .log-level {
            flex-shrink: 0;
            width: 60px;
            font-weight: 700;
            text-transform: uppercase;
        }

        .log-level.info { color: var(--info-color); }
        .log-level.success { color: var(--success-color); }
        .log-level.warning { color: var(--warning-color); }
        .log-level.error { color: var(--danger-color); }

        .log-message {
            color: #ddd;
            flex: 1;
            word-break: break-word;
        }

        .log-detail {
            color: #888;
            font-size: 10px;
        }

        .log-empty {
            text-align: center;
            padding: 40px 20px;
            color: #666;
        }

        .log-stats {
            background: #252525;
            padding: 12px 16px;
            display: flex;
            justify-content: space-around;
            border-top: 1px solid #3d3d3d;
        }

        .log-stat-item {
            text-align: center;
        }

        .log-stat-value {
            font-size: 18px;
            font-weight: 700;
            color: white;
        }

        .log-stat-label {
            font-size: 10px;
            color: #888;
            margin-top: 2px;
        }

        /* æç¤ºä¿¡æ¯ */
        .toast {
            position: fixed;
            bottom: 90px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 12px 24px;
            border-radius: 24px;
            font-size: 13px;
            font-weight: 600;
            z-index: 3000;
            opacity: 0;
            transition: opacity 0.3s;
            pointer-events: none;
            max-width: 90%;
            text-align: center;
            box-shadow: 0 4px 16px rgba(0, 0, 0, 0.3);
        }

        .toast.show {
            opacity: 1;
        }

        /* çœç”µé®ç½© */
        .dim-overlay {
            display: none;
            position: fixed;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background: rgba(0, 0, 0, 0.7);
            z-index: 999;
            pointer-events: none;
            transition: opacity 0.5s;
        }

        /* å¼€å…³æŒ‰é’® */
        .switch-row {
            display: flex;
            justify-content: space-between;
            align-items: center;
            padding: 12px 0;
            border-bottom: 1px solid #f0f0f0;
        }

        .switch-row:last-child {
            border-bottom: none;
        }

        .switch-label {
            font-size: 14px;
            font-weight: 600;
            color: #555;
        }

        .switch {
            position: relative;
            width: 48px;
            height: 28px;
        }

        .switch input {
            opacity: 0;
            width: 0;
            height: 0;
        }

        .switch-slider {
            position: absolute;
            cursor: pointer;
            top: 0;
            left: 0;
            right: 0;
            bottom: 0;
            background-color: #ddd;
            transition: 0.4s;
            border-radius: 28px;
        }

        .switch-slider:before {
            position: absolute;
            content: "";
            height: 22px;
            width: 22px;
            left: 3px;
            bottom: 3px;
            background-color: white;
            transition: 0.4s;
            border-radius: 50%;
            box-shadow: 0 2px 4px rgba(0, 0, 0, 0.2);
        }

        input:checked + .switch-slider {
            background: var(--bg-gradient);
        }

        input:checked + .switch-slider:before {
            transform: translateX(20px);
        }

        /* åº•éƒ¨æ“ä½œæ  */
        .bottom-bar {
            position: fixed;
            bottom: 0;
            left: 0;
            right: 0;
            background: rgba(255, 255, 255, 0.98);
            backdrop-filter: blur(20px);
            padding: 12px 16px;
            box-shadow: 0 -2px 16px rgba(0, 0, 0, 0.1);
            z-index: 1000;
        }

        .quick-actions {
            display: flex;
            gap: 8px;
        }

        .quick-btn {
            flex: 1;
            padding: 12px;
            border: none;
            border-radius: 10px;
            background: linear-gradient(135deg, #667eea15 0%, #764ba215 100%);
            color: var(--primary-color);
            font-size: 13px;
            font-weight: 600;
            cursor: pointer;
            transition: all 0.3s;
        }

        .quick-btn:active {
            transform: scale(0.95);
            background: linear-gradient(135deg, #667eea25 0%, #764ba225 100%);
        }

        /* å“åº”å¼ */
        @media (min-width: 768px) {
            .desktop-warning {
                display: flex !important;
            }

            .container, .nav-bar, .bottom-bar {
                display: none;
            }
        }
    </style>
</head>
<body>
    <!-- PCç«¯è­¦å‘Š -->
    <div class="desktop-warning">
        <h1>404</h1>
        <p>âš ï¸ æœ¬åº”ç”¨ä»…æ”¯æŒç§»åŠ¨è®¾å¤‡è®¿é—®</p>
        <p style="margin-top: 20px; font-size: 18px;">è¯·ä½¿ç”¨æ‰‹æœºæˆ–å¹³æ¿è®¾å¤‡æ‰«æäºŒç»´ç è®¿é—®</p>
    </div>

    <!-- é¡¶éƒ¨å¯¼èˆªæ  -->
    <div class="nav-bar">
        <div class="nav-header">
            <div class="nav-title">ğŸ¯ æ™ºèƒ½æ£€æµ‹ç³»ç»Ÿ Pro</div>
            <div class="nav-status">
                <div class="status-badge" id="statusBadge">
                    <span id="statusIcon">â¸ï¸</span>
                    <span id="statusText">å°±ç»ª</span>
                </div>
                <div class="battery-indicator">
                    <span id="batteryIcon">ğŸ”‹</span>
                    <span id="batteryStatus">--</span>
                </div>
            </div>
        </div>
        <div class="tab-nav">
            <button class="tab-btn active" data-tab="monitor">ğŸ“¹ ç›‘æ§</button>
            <button class="tab-btn" data-tab="settings">âš™ï¸ è®¾ç½®</button>
            <button class="tab-btn" data-tab="logs">ğŸ“ æ—¥å¿—</button>
            <button class="tab-btn" data-tab="stats">ğŸ“Š ç»Ÿè®¡</button>
        </div>
    </div>

    <!-- çœç”µé®ç½© -->
    <div class="dim-overlay" id="dimOverlay"></div>

    <!-- ä¸»å®¹å™¨ -->
    <div class="container">
        <!-- ç›‘æ§æ ‡ç­¾é¡µ -->
        <div class="tab-content active" data-tab="monitor">
            <!-- è§†é¢‘é¢„è§ˆ -->
            <div class="card">
                <div class="video-container">
                    <video id="video" autoplay playsinline muted></video>
                    <div class="detection-box" id="detectionBox"></div>
                    <div class="detection-info" id="detectionInfo">
                        <span>è¿åŠ¨å¼ºåº¦: <span id="intensityText">0%</span></span>
                        <div class="intensity-bar">
                            <div class="intensity-fill" id="intensityFill" style="width: 0%"></div>
                        </div>
                    </div>
                </div>
                <div class="controls">
                    <button class="btn btn-primary" id="startBtn">
                        <span>â–¶ï¸</span>
                        <span>å¼€å§‹æ£€æµ‹</span>
                    </button>
                    <button class="btn btn-secondary" id="pauseBtn" disabled>
                        <span>â¸ï¸</span>
                        <span>æš‚åœ</span>
                    </button>
                    <button class="btn btn-icon btn-secondary" id="switchCameraBtn">
                        <span>ğŸ”„</span>
                    </button>
                </div>
            </div>

            <!-- é¢„è®¾æ¨¡å¼ -->
            <div class="card">
                <div class="card-title">
                    <span class="icon">âš¡</span>
                    <span>å¿«é€Ÿæ¨¡å¼</span>
                </div>
                <div class="preset-modes">
                    <button class="preset-btn active" data-preset="balanced">âš–ï¸ å¹³è¡¡æ¨¡å¼</button>
                    <button class="preset-btn" data-preset="sensitive">ğŸ” é«˜çµæ•åº¦</button>
                    <button class="preset-btn" data-preset="eco">ğŸ”‹ çœç”µæ¨¡å¼</button>
                    <button class="preset-btn" data-preset="security">ğŸ”’ å®‰é˜²æ¨¡å¼</button>
                    <button class="preset-btn" data-preset="silent">ğŸ”‡ é™éŸ³æ¨¡å¼</button>
                    <button class="preset-btn" data-preset="custom">âš™ï¸ è‡ªå®šä¹‰</button>
                </div>
            </div>

            <!-- å¿«é€Ÿè°ƒèŠ‚ -->
            <div class="card">
                <div class="card-title">
                    <span class="icon">ğŸ›ï¸</span>
                    <span>å¿«é€Ÿè°ƒèŠ‚</span>
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>æ£€æµ‹åŒºåŸŸå¤§å°</span>
                        <span class="slider-value" id="detectionAreaValue">60%</span>
                    </div>
                    <input type="range" class="slider" id="detectionArea" min="30" max="100" value="60">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>æ£€æµ‹çµæ•åº¦</span>
                        <span class="slider-value" id="sensitivityValue">50</span>
                    </div>
                    <input type="range" class="slider" id="sensitivity" min="10" max="90" value="50">
                </div>
            </div>
        </div>

        <!-- è®¾ç½®æ ‡ç­¾é¡µ -->
        <div class="tab-content" data-tab="settings">
            <!-- æ£€æµ‹å‚æ•° -->
            <div class="card">
                <div class="card-title">
                    <span class="icon">ğŸ¯</span>
                    <span>æ£€æµ‹å‚æ•°</span>
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>éœ‡åŠ¨è§¦å‘é˜ˆå€¼</span>
                        <span class="slider-value" id="vibrateThresholdValue">50%</span>
                    </div>
                    <input type="range" class="slider" id="vibrateThreshold" min="10" max="100" value="50">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>é€šçŸ¥è§¦å‘é˜ˆå€¼</span>
                        <span class="slider-value" id="notificationThresholdValue">60%</span>
                    </div>
                    <input type="range" class="slider" id="notificationThreshold" min="10" max="100" value="60">
                </div>
            </div>

            <!-- é«˜çº§å‚æ•° -->
            <div class="card">
                <div class="card-title">
                    <span class="icon">âš™ï¸</span>
                    <span>é«˜çº§å‚æ•°</span>
                </div>
                <div class="advanced-settings" id="advancedSettings">
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>åƒç´ å˜åŒ–é˜ˆå€¼</span>
                            <span class="slider-value" id="pixelThresholdValue">40</span>
                        </div>
                        <input type="range" class="slider" id="pixelThreshold" min="10" max="100" value="40">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>æ£€æµ‹é¢‘ç‡ (å¸§/ç§’)</span>
                            <span class="slider-value" id="frameRateValue">15</span>
                        </div>
                        <input type="range" class="slider" id="frameRate" min="5" max="30" value="15">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>æœ€å°æŒç»­æ—¶é—´ (ms)</span>
                            <span class="slider-value" id="minDurationValue">500</span>
                        </div>
                        <input type="range" class="slider" id="minDuration" min="100" max="2000" step="100" value="500">
                    </div>
                    <div class="slider-group">
                        <div class="slider-label">
                            <span>é‡‡æ ·æ­¥è¿› (åƒç´ )</span>
                            <span class="slider-value" id="sampleStepValue">4</span>
                        </div>
                        <input type="range" class="slider" id="sampleStep" min="2" max="10" value="4">
                    </div>
                </div>
            </div>

            <!-- åé¦ˆè®¾ç½® -->
            <div class="card">
                <div class="card-title">
                    <span class="icon">ğŸ””</span>
                    <span>åé¦ˆè®¾ç½®</span>
                </div>
                <div class="switch-row">
                    <span class="switch-label">å¯ç”¨éœ‡åŠ¨åé¦ˆ</span>
                    <label class="switch">
                        <input type="checkbox" id="vibrateEnabled" checked>
                        <span class="switch-slider"></span>
                    </label>
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>éœ‡åŠ¨é—´éš” (ç§’)</span>
                        <span class="slider-value" id="vibrateIntervalValue">2.0</span>
                    </div>
                    <input type="range" class="slider" id="vibrateInterval" min="0.5" max="5" step="0.5" value="2">
                </div>
                <div class="switch-row">
                    <span class="switch-label">å¯ç”¨éŸ³é¢‘æç¤º</span>
                    <label class="switch">
                        <input type="checkbox" id="audioEnabled" checked>
                        <span class="switch-slider"></span>
                    </label>
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>éŸ³é‡</span>
                        <span class="slider-value" id="volumeValue">50%</span>
                    </div>
                    <input type="range" class="slider" id="volume" min="0" max="100" value="50">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>é€šçŸ¥é—´éš” (ç§’)</span>
                        <span class="slider-value" id="notificationIntervalValue">10</span>
                    </div>
                    <input type="range" class="slider" id="notificationInterval" min="3" max="30" value="10">
                </div>
                <div class="switch-row">
                    <span class="switch-label">æŒç»­ç›‘æ§æ¨¡å¼</span>
                    <label class="switch">
                        <input type="checkbox" id="continuousMode" checked>
                        <span class="switch-slider"></span>
                    </label>
                </div>
            </div>

            <!-- ç”µæºç®¡ç† -->
            <div class="card">
                <div class="card-title">
                    <span class="icon">ğŸ”‹</span>
                    <span>ç”µæºç®¡ç†</span>
                </div>
                <div class="battery-card">
                    <span class="battery-icon-large" id="batteryIconLarge">ğŸ”‹</span>
                    <div class="battery-details">
                        <div class="battery-percent" id="batteryPercent">--</div>
                        <div class="battery-bar">
                            <div class="battery-fill" id="batteryFill" style="width: 0%"></div>
                        </div>
                        <div class="battery-text" id="batteryCharging">æ£€æµ‹ä¸­...</div>
                        <div class="battery-text" id="batteryTime">--</div>
                    </div>
                </div>
                <div class="switch-row">
                    <span class="switch-label">è‡ªåŠ¨å˜æš— (çœç”µ)</span>
                    <label class="switch">
                        <input type="checkbox" id="autoDimEnabled" checked>
                        <span class="switch-slider"></span>
                    </label>
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>å˜æš—è§¦å‘æ—¶é—´ (ç§’)</span>
                        <span class="slider-value" id="dimTimeoutValue">30</span>
                    </div>
                    <input type="range" class="slider" id="dimTimeout" min="10" max="120" step="10" value="30">
                </div>
                <div class="slider-group">
                    <div class="slider-label">
                        <span>äº®åº¦é™ä½ç¨‹åº¦</span>
                        <span class="slider-value" id="dimLevelValue">70%</span>
                    </div>
                    <input type="range" class="slider" id="dimLevel" min="30" max="90" value="70">
                </div>
            </div>
        </div>

        <!-- æ—¥å¿—æ ‡ç­¾é¡µ -->
        <div class="tab-content" data-tab="logs">
            <div class="card" style="padding: 0; overflow: hidden;">
                <div class="log-container">
                    <div class="log-header">
                        <div class="log-title">
                            <span>ğŸ“</span>
                            <span>å®æ—¶æ—¥å¿—</span>
                            <span style="margin-left: 8px; color: #666; font-size: 12px;" id="logCount">(0)</span>
                        </div>
                        <div class="log-actions">
                            <button class="log-btn" id="clearLogsBtn">æ¸…ç©º</button>
                            <button class="log-btn" id="exportLogsBtn">å¯¼å‡ºCSV</button>
                        </div>
                    </div>
                    <div class="log-filters">
                        <div class="filter-chip active" data-filter="all">å…¨éƒ¨</div>
                        <div class="filter-chip info" data-filter="info">â„¹ï¸ ä¿¡æ¯</div>
                        <div class="filter-chip success" data-filter="success">âœ… æˆåŠŸ</div>
                        <div class="filter-chip warning" data-filter="warning">âš ï¸ è­¦å‘Š</div>
                        <div class="filter-chip error" data-filter="error">âŒ é”™è¯¯</div>
                    </div>
                    <div class="log-content" id="logContent">
                        <div class="log-empty">ğŸ“ æš‚æ— æ—¥å¿—è®°å½•</div>
                    </div>
                    <div class="log-stats">
                        <div class="log-stat-item">
                            <div class="log-stat-value" id="logInfoCount">0</div>
                            <div class="log-stat-label">ä¿¡æ¯</div>
                        </div>
                        <div class="log-stat-item">
                            <div class="log-stat-value" id="logSuccessCount">0</div>
                            <div class="log-stat-label">æˆåŠŸ</div>
                        </div>
                        <div class="log-stat-item">
                            <div class="log-stat-value" id="logWarningCount">0</div>
                            <div class="log-stat-label">è­¦å‘Š</div>
                        </div>
                        <div class="log-stat-item">
                            <div class="log-stat-value" id="logErrorCount">0</div>
                            <div class="log-stat-label">é”™è¯¯</div>
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <!-- ç»Ÿè®¡æ ‡ç­¾é¡µ -->
        <div class="tab-content" data-tab="stats">
            <div class="card">
                <div class="card-title">
                    <span class="icon">ğŸ“Š</span>
                    <span>è¿è¡Œç»Ÿè®¡</span>
                </div>
                <div class="stats-grid">
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ¯</div>
                        <span class="stat-value" id="detectionCount">0</span>
                        <span class="stat-label">æ£€æµ‹æ¬¡æ•°</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ“³</div>
                        <span class="stat-value" id="vibrateCount">0</span>
                        <span class="stat-label">éœ‡åŠ¨æ¬¡æ•°</span>
                    </div>
                    <div class="stat-card">
                        <div class="stat-icon">ğŸ””</div>
                        <span class="stat-value" id="notificationCount">0</span>
                        <span class="stat-label">é€šçŸ¥æ¬¡æ•°</span>
                    </div>
                </div>
            </div>

            <div class="card">
                <div class="card-title">
                    <span class="icon">â±ï¸</span>
                    <span>è¿è¡Œæ—¶é—´</span>
                </div>
                <div style="text-align: center; padding: 20px;">
                    <div style="font-size: 48px; font-weight: 700; background: var(--bg-gradient); -webkit-background-clip: text; -webkit-text-fill-color: transparent; background-clip: text;" id="runningTime">00:00:00</div>
                    <div style="color: #666; margin-top: 8px; font-size: 14px;">ç´¯è®¡è¿è¡Œæ—¶é•¿</div>
                </div>
            </div>

            <div class="card">
                <button class="btn btn-secondary" id="resetStatsBtn" style="width: 100%;">
                    <span>ğŸ”„</span>
                    <span>é‡ç½®ç»Ÿè®¡æ•°æ®</span>
                </button>
            </div>
        </div>
    </div>

    <!-- åº•éƒ¨æ“ä½œæ  -->
    <div class="bottom-bar">
        <div class="quick-actions">
            <button class="quick-btn" id="quickVibrate">ğŸ“³ æµ‹è¯•éœ‡åŠ¨</button>
            <button class="quick-btn" id="quickNotify">ğŸ”” æµ‹è¯•é€šçŸ¥</button>
        </div>
    </div>

    <!-- æç¤ºä¿¡æ¯ -->
    <div class="toast" id="toast"></div>

    <!-- éšè—çš„Canvas -->
    <canvas id="canvas"></canvas>

    <script>
        // ============ å…¨å±€å˜é‡ ============
        let video, canvas, ctx;
        let isDetecting = false;
        let isPaused = false;
        let previousImageData = null;
        let currentCamera = 'user';
        let wakeLock = null;
        let detectionInterval = null;
        let audioContext = null;
        let runningStartTime = null;
        let runningTimeInterval = null;

        // ç»Ÿè®¡æ•°æ®
        let stats = {
            detections: 0,
            vibrations: 0,
            notifications: 0
        };

        // é…ç½®å‚æ•°
        let config = {
            detectionArea: 60,
            vibrateEnabled: true,
            vibrateThreshold: 50,
            notificationThreshold: 60,
            sensitivity: 50,
            pixelThreshold: 40,
            frameRate: 15,
            minDuration: 500,
            sampleStep: 4,
            volume: 50,
            audioEnabled: true,
            vibrateInterval: 2,
            notificationInterval: 10,
            continuousMode: true,
            autoDimEnabled: true,
            dimTimeout: 30,
            dimLevel: 70
        };

        // æ—¶é—´æˆ³æ§åˆ¶
        let lastVibrateTime = 0;
        let lastNotificationTime = 0;
        let motionStartTime = 0;
        let isInMotion = false;
        let currentIntensity = 0;

        // æ—¥å¿—ç³»ç»Ÿ
        let logs = [];
        let currentLogFilter = 'all';
        const MAX_LOGS = 500;
        let logStats = { info: 0, success: 0, warning: 0, error: 0 };

        // é¢„è®¾é…ç½®
        const presets = {
            balanced: {
                sensitivity: 50, pixelThreshold: 40, frameRate: 15, minDuration: 500, sampleStep: 4,
                vibrateThreshold: 50, notificationThreshold: 60
            },
            sensitive: {
                sensitivity: 80, pixelThreshold: 20, frameRate: 25, minDuration: 200, sampleStep: 2,
                vibrateThreshold: 30, notificationThreshold: 40
            },
            eco: {
                sensitivity: 30, pixelThreshold: 60, frameRate: 8, minDuration: 1000, sampleStep: 8,
                vibrateThreshold: 70, notificationThreshold: 80
            },
            security: {
                sensitivity: 90, pixelThreshold: 15, frameRate: 30, minDuration: 100, sampleStep: 2,
                vibrateThreshold: 20, notificationThreshold: 25
            },
            silent: {
                sensitivity: 50, pixelThreshold: 40, frameRate: 15, minDuration: 500, sampleStep: 4,
                vibrateThreshold: 100, notificationThreshold: 100
            }
        };

        // çœç”µæ¨¡å¼
        let dimTimer = null;
        let isDimmed = false;

        // ç”µæ± ç›‘æ§
        let batteryChargeHistory = [];

        // ============ æ—¥å¿—ç³»ç»Ÿå‡½æ•° ============
        function addLog(level, message, detail = '') {
            const timestamp = new Date();
            const timeStr = timestamp.toLocaleTimeString('zh-CN');
            
            const log = {
                id: Date.now() + Math.random(),
                time: timeStr,
                timestamp: timestamp.getTime(),
                level: level,
                message: message,
                detail: detail
            };
            
            logs.unshift(log);
            logStats[level]++;
            
            if (logs.length > MAX_LOGS) {
                const removed = logs.pop();
                logStats[removed.level]--;
            }
            
            updateLogDisplay();
            updateLogStats();
        }

        function updateLogDisplay() {
            const logContent = document.getElementById('logContent');
            const filteredLogs = currentLogFilter === 'all' 
                ? logs 
                : logs.filter(log => log.level === currentLogFilter);
            
            if (filteredLogs.length === 0) {
                logContent.innerHTML = '<div class="log-empty">ğŸ“ æš‚æ— æ—¥å¿—è®°å½•</div>';
                return;
            }
            
            logContent.innerHTML = filteredLogs.map(log => `
                <div class="log-entry">
                    <span class="log-time">${log.time}</span>
                    <span class="log-level ${log.level}">${log.level}</span>
                    <span class="log-message">
                        ${log.message}
                        ${log.detail ? `<div class="log-detail">${log.detail}</div>` : ''}
                    </span>
                </div>
            `).join('');
            
            document.getElementById('logCount').textContent = `(${logs.length})`;
            logContent.scrollTop = 0;
        }

        function updateLogStats() {
            document.getElementById('logInfoCount').textContent = logStats.info;
            document.getElementById('logSuccessCount').textContent = logStats.success;
            document.getElementById('logWarningCount').textContent = logStats.warning;
            document.getElementById('logErrorCount').textContent = logStats.error;
        }

        function clearLogs() {
            if (logs.length === 0) return;
            
            if (confirm('ç¡®å®šè¦æ¸…ç©ºæ‰€æœ‰æ—¥å¿—å—?')) {
                logs = [];
                logStats = { info: 0, success: 0, warning: 0, error: 0 };
                updateLogDisplay();
                updateLogStats();
                showToast('ğŸ—‘ï¸ å·²æ¸…ç©ºæ‰€æœ‰æ—¥å¿—');
            }
        }

        function exportLogs() {
            if (logs.length === 0) {
                showToast('âš ï¸ æ²¡æœ‰å¯å¯¼å‡ºçš„æ—¥å¿—');
                return;
            }
            
            const headers = ['æ—¶é—´æˆ³', 'æ—¶é—´', 'çº§åˆ«', 'æ¶ˆæ¯', 'è¯¦ç»†ä¿¡æ¯'];
            const csvRows = [headers.join(',')];
            
            const sortedLogs = [...logs].reverse();
            
            sortedLogs.forEach(log => {
                const row = [
                    log.timestamp,
                    `"${log.time}"`,
                    log.level.toUpperCase(),
                    `"${log.message.replace(/"/g, '""')}"`,
                    `"${log.detail.replace(/"/g, '""')}"`
                ];
                csvRows.push(row.join(','));
            });
            
            const csv = csvRows.join('\n');
            const BOM = '\uFEFF';
            const blob = new Blob([BOM + csv], { type: 'text/csv;charset=utf-8;' });
            const url = URL.createObjectURL(blob);
            
            const timestamp = new Date().toISOString().replace(/[:.]/g, '-').slice(0, -5);
            const filename = `motion-detector-logs-${timestamp}.csv`;
            
            const a = document.createElement('a');
            a.href = url;
            a.download = filename;
            a.click();
            
            URL.revokeObjectURL(url);
            
            addLog('success', 'æ—¥å¿—å¯¼å‡ºæˆåŠŸ', `æ–‡ä»¶å: ${filename}, å…± ${logs.length} æ¡è®°å½•`);
            showToast('âœ… æ—¥å¿—å·²å¯¼å‡ºä¸ºCSVæ–‡ä»¶');
        }

        // ============ åˆå§‹åŒ– ============
        document.addEventListener('DOMContentLoaded', () => {
            initElements();
            initEventListeners();
            loadSettings();
            checkDeviceType();
            initBatteryMonitor();
            requestNotificationPermission();
            showWelcomeToast();
            initUserActivityTracking();
            
            addLog('info', 'ç³»ç»Ÿåˆå§‹åŒ–å®Œæˆ', 'è¿åŠ¨æ£€æµ‹ç³»ç»Ÿå·²å°±ç»ª');
        });

        function initElements() {
            video = document.getElementById('video');
            canvas = document.getElementById('canvas');
            ctx = canvas.getContext('2d', { willReadFrequently: true });
        }

        function initEventListeners() {
            // æ ‡ç­¾é¡µåˆ‡æ¢
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    const targetTab = e.target.dataset.tab;
                    switchTab(targetTab);
                });
            });

            // æ§åˆ¶æŒ‰é’®
            document.getElementById('startBtn').addEventListener('click', toggleDetection);
            document.getElementById('pauseBtn').addEventListener('click', togglePause);
            document.getElementById('switchCameraBtn').addEventListener('click', switchCamera);
            document.getElementById('resetStatsBtn').addEventListener('click', resetStats);

            // æ—¥å¿—æŒ‰é’®
            document.getElementById('clearLogsBtn').addEventListener('click', clearLogs);
            document.getElementById('exportLogsBtn').addEventListener('click', exportLogs);

            // æ—¥å¿—è¿‡æ»¤
            document.querySelectorAll('.filter-chip').forEach(chip => {
                chip.addEventListener('click', (e) => {
                    document.querySelectorAll('.filter-chip').forEach(c => c.classList.remove('active'));
                    e.target.classList.add('active');
                    currentLogFilter = e.target.dataset.filter;
                    updateLogDisplay();
                });
            });

            // å¿«é€Ÿæ“ä½œ
            document.getElementById('quickVibrate').addEventListener('click', () => {
                if (!config.vibrateEnabled) {
                    showToast('âš ï¸ éœ‡åŠ¨åé¦ˆå·²ç¦ç”¨ï¼Œè¯·åœ¨è®¾ç½®ä¸­å¯ç”¨');
                    addLog('warning', 'éœ‡åŠ¨æµ‹è¯•å¤±è´¥', 'éœ‡åŠ¨åŠŸèƒ½å·²è¢«ç¦ç”¨');
                    return;
                }
                
                if ('vibrate' in navigator) {
                    navigator.vibrate(200);
                    showToast('ğŸ“³ éœ‡åŠ¨æµ‹è¯•å®Œæˆ');
                    addLog('info', 'æ‰§è¡Œéœ‡åŠ¨æµ‹è¯•');
                } else {
                    showToast('âš ï¸ è®¾å¤‡ä¸æ”¯æŒéœ‡åŠ¨');
                    addLog('error', 'éœ‡åŠ¨æµ‹è¯•å¤±è´¥', 'è®¾å¤‡ä¸æ”¯æŒéœ‡åŠ¨API');
                }
            });

            document.getElementById('quickNotify').addEventListener('click', () => {
                sendNotification(75);
                addLog('info', 'å‘é€æµ‹è¯•é€šçŸ¥');
            });

            // é¢„è®¾æ¨¡å¼
            document.querySelectorAll('.preset-btn').forEach(btn => {
                btn.addEventListener('click', (e) => {
                    document.querySelectorAll('.preset-btn').forEach(b => b.classList.remove('active'));
                    e.target.classList.add('active');
                    applyPreset(e.target.dataset.preset);
                });
            });

            // æ»‘å—äº‹ä»¶
            const sliders = ['detectionArea', 'vibrateThreshold', 'notificationThreshold', 
                            'sensitivity', 'pixelThreshold', 'frameRate', 'minDuration', 
                            'sampleStep', 'volume', 'vibrateInterval', 'notificationInterval',
                            'dimTimeout', 'dimLevel'];
            
            sliders.forEach(id => {
                const element = document.getElementById(id);
                element.addEventListener('input', (e) => {
                    updateSliderValue(id, e.target.value);
                });
            });

            // å¼€å…³
            document.getElementById('vibrateEnabled').addEventListener('change', (e) => {
                config.vibrateEnabled = e.target.checked;
                saveSettings();
                addLog('info', `éœ‡åŠ¨åé¦ˆ${e.target.checked ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
                if (e.target.checked) {
                    showToast('âœ… éœ‡åŠ¨åé¦ˆå·²å¯ç”¨');
                } else {
                    showToast('ğŸ”‡ éœ‡åŠ¨åé¦ˆå·²ç¦ç”¨');
                }
            });

            document.getElementById('audioEnabled').addEventListener('change', (e) => {
                config.audioEnabled = e.target.checked;
                saveSettings();
                addLog('info', `éŸ³é¢‘æç¤º${e.target.checked ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
            });

            document.getElementById('continuousMode').addEventListener('change', (e) => {
                config.continuousMode = e.target.checked;
                saveSettings();
                addLog('info', `æŒç»­ç›‘æ§æ¨¡å¼${e.target.checked ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
            });

            document.getElementById('autoDimEnabled').addEventListener('change', (e) => {
                config.autoDimEnabled = e.target.checked;
                saveSettings();
                if (!e.target.checked) {
                    clearDimTimer();
                    restoreBrightness();
                } else if (isDetecting) {
                    startDimTimer();
                }
                addLog('info', `è‡ªåŠ¨å˜æš—${e.target.checked ? 'å¯ç”¨' : 'ç¦ç”¨'}`);
            });

            document.getElementById('detectionArea').addEventListener('input', updateDetectionBox);
            document.addEventListener('visibilitychange', handleVisibilityChange);
        }

        function switchTab(tabName) {
            document.querySelectorAll('.tab-btn').forEach(btn => {
                btn.classList.toggle('active', btn.dataset.tab === tabName);
            });

            document.querySelectorAll('.tab-content').forEach(content => {
                content.classList.toggle('active', content.dataset.tab === tabName);
            });

            addLog('info', `åˆ‡æ¢åˆ°${tabName}æ ‡ç­¾é¡µ`);
        }

        function updateSliderValue(id, value) {
            const numValue = parseFloat(value);
            config[id] = numValue;
            
            let displayValue = numValue;
            let suffix = '';
            
            if (id.includes('Threshold') || id.includes('Level')) {
                suffix = '%';
            } else if (id.includes('Interval') || id.includes('Timeout')) {
                suffix = 'ç§’';
                if (id === 'vibrateInterval') displayValue = numValue.toFixed(1);
            } else if (id === 'volume') {
                suffix = '%';
            }
            
            document.getElementById(id + 'Value').textContent = displayValue + suffix;
            
            if (id === 'detectionArea') {
                updateDetectionBox();
            }
            
            if (isDetecting && id === 'frameRate') {
                restartDetection();
            }
            
            saveSettings();
        }

        function applyPreset(presetName) {
            if (presetName === 'custom') {
                document.getElementById('advancedSettings').classList.add('show');
                addLog('info', 'åˆ‡æ¢åˆ°è‡ªå®šä¹‰æ¨¡å¼');
            } else {
                document.getElementById('advancedSettings').classList.remove('show');
                const preset = presets[presetName];
                if (preset) {
                    Object.keys(preset).forEach(key => {
                        config[key] = preset[key];
                        const element = document.getElementById(key);
                        if (element) {
                            element.value = preset[key];
                            updateSliderValue(key, preset[key]);
                        }
                    });
                    addLog('success', `åº”ç”¨é¢„è®¾: ${presetName}æ¨¡å¼`);
                }
            }
            saveSettings();
        }

        // ============ æ‘„åƒå¤´æ§åˆ¶ ============
        async function startCamera() {
            try {
                addLog('info', 'æ­£åœ¨è¯·æ±‚æ‘„åƒå¤´æƒé™...');
                
                const constraints = {
                    video: {
                        facingMode: currentCamera,
                        width: { ideal: 1280 },
                        height: { ideal: 720 }
                    }
                };
                
                const stream = await navigator.mediaDevices.getUserMedia(constraints);
                video.srcObject = stream;
                
                video.onloadedmetadata = () => {
                    canvas.width = video.videoWidth;
                    canvas.height = video.videoHeight;
                    updateDetectionBox();
                    addLog('success', 'æ‘„åƒå¤´å¯åŠ¨æˆåŠŸ', `åˆ†è¾¨ç‡: ${video.videoWidth}x${video.videoHeight}`);
                };
                
                return true;
            } catch (error) {
                showToast('âŒ æ‘„åƒå¤´è®¿é—®å¤±è´¥: ' + error.message);
                addLog('error', 'æ‘„åƒå¤´è®¿é—®å¤±è´¥', error.message);
                return false;
            }
        }

        function stopCamera() {
            if (video.srcObject) {
                video.srcObject.getTracks().forEach(track => track.stop());
                video.srcObject = null;
                addLog('info', 'æ‘„åƒå¤´å·²å…³é—­');
            }
        }

        async function switchCamera() {
            currentCamera = currentCamera === 'user' ? 'environment' : 'user';
            addLog('info', `åˆ‡æ¢åˆ°${currentCamera === 'user' ? 'å‰ç½®' : 'åç½®'}æ‘„åƒå¤´`);
            
            if (isDetecting) {
                stopDetection();
                await startCamera();
                startDetection();
            }
        }

        // ============ è¿åŠ¨æ£€æµ‹ ============
        async function toggleDetection() {
            if (isDetecting) {
                stopDetection();
            } else {
                await startDetection();
            }
        }

        function togglePause() {
            isPaused = !isPaused;
            const pauseBtn = document.getElementById('pauseBtn');
            
            if (isPaused) {
                pauseBtn.innerHTML = '<span>â–¶ï¸</span><span>ç»§ç»­</span>';
                document.getElementById('statusText').textContent = 'å·²æš‚åœ';
                document.getElementById('statusIcon').textContent = 'â¸ï¸';
                addLog('warning', 'æ£€æµ‹å·²æš‚åœ');
                showToast('â¸ï¸ æ£€æµ‹å·²æš‚åœ');
            } else {
                pauseBtn.innerHTML = '<span>â¸ï¸</span><span>æš‚åœ</span>';
                document.getElementById('statusText').textContent = 'è¿è¡Œä¸­';
                document.getElementById('statusIcon').textContent = 'â–¶ï¸';
                addLog('success', 'æ£€æµ‹å·²ç»§ç»­');
                showToast('â–¶ï¸ æ£€æµ‹å·²ç»§ç»­');
            }
        }

        async function startDetection() {
            const cameraStarted = await startCamera();
            if (!cameraStarted) return;
            
            isDetecting = true;
            isPaused = false;
            runningStartTime = Date.now();
            
            document.getElementById('startBtn').innerHTML = '<span>â¹ï¸</span><span>åœæ­¢æ£€æµ‹</span>';
            document.getElementById('pauseBtn').disabled = false;
            document.getElementById('statusBadge').classList.add('active');
            document.getElementById('statusText').textContent = 'è¿è¡Œä¸­';
            document.getElementById('statusIcon').textContent = 'â–¶ï¸';
            
            await requestWakeLock();
            
            previousImageData = null;
            const interval = 1000 / config.frameRate;
            detectionInterval = setInterval(detectMotion, interval);
            
            runningTimeInterval = setInterval(updateRunningTime, 1000);
            
            if (config.autoDimEnabled) {
                startDimTimer();
            }
            
            addLog('success', 'æ£€æµ‹å·²å¯åŠ¨', `å¸§ç‡: ${config.frameRate}fps, çµæ•åº¦: ${config.sensitivity}`);
            showToast('âœ… æ£€æµ‹å·²å¯åŠ¨');
            
            setTimeout(() => {
                if (isDetecting) {
                    showToast('âš ï¸ è¯·å‹¿é”å±,å¦åˆ™æ£€æµ‹å°†æš‚åœ', 5000);
                    addLog('warning', 'é”å±æç¤º', 'è¯·ä¿æŒå±å¹•å¸¸äº®ä»¥ç»§ç»­æ£€æµ‹');
                }
            }, 5000);
        }

        function stopDetection() {
            isDetecting = false;
            isPaused = false;
            
            document.getElementById('startBtn').innerHTML = '<span>â–¶ï¸</span><span>å¼€å§‹æ£€æµ‹</span>';
            document.getElementById('pauseBtn').innerHTML = '<span>â¸ï¸</span><span>æš‚åœ</span>';
            document.getElementById('pauseBtn').disabled = true;
            document.getElementById('statusBadge').classList.remove('active');
            document.getElementById('statusText').textContent = 'å·²åœæ­¢';
            document.getElementById('statusIcon').textContent = 'â¸ï¸';
            
            if (detectionInterval) {
                clearInterval(detectionInterval);
                detectionInterval = null;
            }
            
            if (runningTimeInterval) {
                clearInterval(runningTimeInterval);
                runningTimeInterval = null;
            }
            
            releaseWakeLock();
            stopCamera();
            clearDimTimer();
            restoreBrightness();
            
            document.getElementById('detectionBox').classList.remove('active');
            document.getElementById('intensityText').textContent = '0%';
            document.getElementById('intensityFill').style.width = '0%';
            
            const runTime = formatRunningTime(Date.now() - runningStartTime);
            addLog('info', 'æ£€æµ‹å·²åœæ­¢', `æœ¬æ¬¡è¿è¡Œæ—¶é•¿: ${runTime}`);
            showToast('â¹ï¸ æ£€æµ‹å·²åœæ­¢');
        }

        function restartDetection() {
            if (isDetecting) {
                addLog('info', 'é‡å¯æ£€æµ‹ä¸­...');
                stopDetection();
                setTimeout(() => startDetection(), 100);
            }
        }

        function detectMotion() {
            if (!video.readyState === video.HAVE_ENOUGH_DATA || isPaused) return;
            
            ctx.drawImage(video, 0, 0, canvas.width, canvas.height);
            
            const detectionSize = config.detectionArea / 100;
            const detectionWidth = Math.floor(canvas.width * detectionSize);
            const detectionHeight = Math.floor(canvas.height * detectionSize);
            const startX = Math.floor((canvas.width - detectionWidth) / 2);
            const startY = Math.floor((canvas.height - detectionHeight) / 2);
            
            const currentImageData = ctx.getImageData(startX, startY, detectionWidth, detectionHeight);
            
            if (previousImageData) {
                const motionIntensity = compareFrames(currentImageData, previousImageData);
                currentIntensity = motionIntensity;
                
                document.getElementById('intensityText').textContent = motionIntensity.toFixed(1) + '%';
                document.getElementById('intensityFill').style.width = Math.min(motionIntensity, 100) + '%';
                
                if (motionIntensity > config.sensitivity) {
                    handleMotionDetected(motionIntensity);
                } else {
                    handleNoMotion();
                }
            }
            
            previousImageData = currentImageData;
        }

        function compareFrames(current, previous) {
            const data1 = current.data;
            const data2 = previous.data;
            let diffPixels = 0;
            const step = config.sampleStep * 4;
            
            for (let i = 0; i < data1.length; i += step) {
                const diff = Math.abs(data1[i] - data2[i]) +
                            Math.abs(data1[i+1] - data2[i+1]) +
                            Math.abs(data1[i+2] - data2[i+2]);
                
                if (diff > config.pixelThreshold) {
                    diffPixels++;
                }
            }
            
            const totalPixels = data1.length / (step * 3);
            return (diffPixels / totalPixels) * 100;
        }

        function handleMotionDetected(intensity) {
            const now = Date.now();
            
            if (!isInMotion) {
                isInMotion = true;
                motionStartTime = now;
                addLog('info', 'æ£€æµ‹åˆ°è¿åŠ¨', `å¼ºåº¦: ${intensity.toFixed(1)}%`);
            }
            
            const motionDuration = now - motionStartTime;
            
            if (motionDuration >= config.minDuration || config.continuousMode) {
                stats.detections++;
                document.getElementById('detectionCount').textContent = stats.detections;
                document.getElementById('detectionBox').classList.add('active');
                
                if (intensity >= config.vibrateThreshold && 
                    now - lastVibrateTime >= config.vibrateInterval * 1000) {
                    triggerVibration();
                    lastVibrateTime = now;
                }
                
                if (intensity >= config.notificationThreshold && 
                    now - lastNotificationTime >= config.notificationInterval * 1000) {
                    sendNotification(intensity);
                    lastNotificationTime = now;
                }
                
                if (config.audioEnabled && intensity >= config.vibrateThreshold) {
                    playBeep();
                }
            }
        }

        function handleNoMotion() {
            if (isInMotion) {
                isInMotion = false;
                motionStartTime = 0;
                document.getElementById('detectionBox').classList.remove('active');
            }
        }

        // ============ åé¦ˆåŠŸèƒ½ ============
        function triggerVibration() {
            if (!config.vibrateEnabled) return;
            
            if ('vibrate' in navigator) {
                navigator.vibrate(200);
                stats.vibrations++;
                document.getElementById('vibrateCount').textContent = stats.vibrations;
                addLog('success', 'è§¦å‘éœ‡åŠ¨åé¦ˆ');
            }
        }

        async function sendNotification(intensity) {
            if ('Notification' in window && Notification.permission === 'granted') {
                new Notification('ğŸš¨ æ£€æµ‹åˆ°è¿åŠ¨!', {
                    body: `è¿åŠ¨å¼ºåº¦: ${intensity.toFixed(1)}%\næ—¶é—´: ${new Date().toLocaleTimeString('zh-CN')}`,
                    icon: '/icon.png',
                    badge: '/badge.png',
                    vibrate: [200, 100, 200]
                });
                
                stats.notifications++;
                document.getElementById('notificationCount').textContent = stats.notifications;
                addLog('success', 'å‘é€é€šçŸ¥', `å¼ºåº¦: ${intensity.toFixed(1)}%`);
            }
        }

        function playBeep() {
            if (!audioContext) {
                audioContext = new (window.AudioContext || window.webkitAudioContext)();
            }
            
            const oscillator = audioContext.createOscillator();
            const gainNode = audioContext.createGain();
            
            oscillator.connect(gainNode);
            gainNode.connect(audioContext.destination);
            
            oscillator.frequency.value = 800;
            oscillator.type = 'sine';
            
            const volume = config.volume / 100;
            gainNode.gain.setValueAtTime(volume, audioContext.currentTime);
            gainNode.gain.exponentialRampToValueAtTime(0.01, audioContext.currentTime + 0.2);
            
            oscillator.start(audioContext.currentTime);
            oscillator.stop(audioContext.currentTime + 0.2);
        }

        // ============ ç”µæºç®¡ç† ============
        async function requestWakeLock() {
            try {
                if ('wakeLock' in navigator) {
                    wakeLock = await navigator.wakeLock.request('screen');
                    wakeLock.addEventListener('release', () => {
                        addLog('warning', 'Wake Lockå·²é‡Šæ”¾');
                    });
                    addLog('success', 'Wake Lockå·²æ¿€æ´»', 'å±å¹•å°†ä¿æŒå¸¸äº®');
                }
            } catch (err) {
                addLog('error', 'Wake Lockè¯·æ±‚å¤±è´¥', err.message);
            }
        }

        function releaseWakeLock() {
            if (wakeLock) {
                wakeLock.release();
                wakeLock = null;
            }
        }

        function startDimTimer() {
            clearDimTimer();
            dimTimer = setTimeout(() => {
                if (isDetecting && !isDimmed) {
                    dimScreen();
                }
            }, config.dimTimeout * 1000);
        }

        function clearDimTimer() {
            if (dimTimer) {
                clearTimeout(dimTimer);
                dimTimer = null;
            }
        }

        function dimScreen() {
            const overlay = document.getElementById('dimOverlay');
            overlay.style.opacity = config.dimLevel / 100;
            overlay.style.display = 'block';
            isDimmed = true;
            addLog('info', 'è¿›å…¥çœç”µæ¨¡å¼', `äº®åº¦é™ä½ ${config.dimLevel}%`);
            showToast('ğŸ’¤ å·²è¿›å…¥çœç”µæ¨¡å¼', 3000);
        }

        function restoreBrightness() {
            const overlay = document.getElementById('dimOverlay');
            overlay.style.display = 'none';
            isDimmed = false;
        }

        function initUserActivityTracking() {
            const events = ['touchstart', 'touchmove', 'touchend', 'click', 'scroll'];
            
            events.forEach(event => {
                document.addEventListener(event, () => {
                    if (isDimmed) {
                        restoreBrightness();
                        addLog('info', 'æ¢å¤æ­£å¸¸äº®åº¦', 'æ£€æµ‹åˆ°ç”¨æˆ·æ´»åŠ¨');
                    }
                    
                    if (isDetecting && config.autoDimEnabled) {
                        startDimTimer();
                    }
                }, { passive: true });
            });
        }

        function handleVisibilityChange() {
            if (document.hidden) {
                if (isDetecting) {
                    addLog('warning', 'é¡µé¢å·²éšè—', 'æ£€æµ‹å¯èƒ½æš‚åœ');
                }
                clearDimTimer();
            } else {
                addLog('info', 'é¡µé¢å·²æ˜¾ç¤º');
                if (isDetecting && config.autoDimEnabled) {
                    startDimTimer();
                }
            }
        }

        // ============ ç”µæ± ç›‘æ§ ============
        async function initBatteryMonitor() {
            try {
                if ('getBattery' in navigator) {
                    const battery = await navigator.getBattery();
                    updateBatteryInfo(battery);
                    
                    battery.addEventListener('levelchange', () => updateBatteryInfo(battery));
                    battery.addEventListener('chargingchange', () => updateBatteryInfo(battery));
                    battery.addEventListener('chargingtimechange', () => updateBatteryInfo(battery));
                    battery.addEventListener('dischargingtimechange', () => updateBatteryInfo(battery));
                    
                    addLog('success', 'ç”µæ± ç›‘æ§å·²å¯åŠ¨');
                } else {
                    document.getElementById('batteryPercent').textContent = 'N/A';
                    document.getElementById('batteryCharging').textContent = 'ä¸æ”¯æŒç”µæ± API';
                    addLog('warning', 'è®¾å¤‡ä¸æ”¯æŒç”µæ± API');
                }
            } catch (error) {
                addLog('error', 'ç”µæ± APIåˆå§‹åŒ–å¤±è´¥', error.message);
            }
        }

        function updateBatteryInfo(battery) {
            const level = Math.round(battery.level * 100);
            
            document.getElementById('batteryPercent').textContent = level + '%';
            document.getElementById('batteryStatus').textContent = level + '%';
            document.getElementById('batteryFill').style.width = level + '%';
            
            let icon = 'ğŸ”‹';
            if (battery.charging) {
                icon = 'âš¡';
            } else if (level <= 20) {
                icon = 'ğŸª«';
            }
            document.getElementById('batteryIcon').textContent = icon;
            document.getElementById('batteryIconLarge').textContent = icon;
            
            if (battery.charging) {
                document.getElementById('batteryCharging').textContent = 'âš¡ å……ç”µä¸­';
                document.getElementById('batteryFill').classList.remove('low');
                
                recordBatteryLevel(level, true);
                const chargeSpeed = calculateChargeSpeed();
                
                if (chargeSpeed > 0) {
                    const remainingPercent = 100 - level;
                    const hoursToFull = remainingPercent / chargeSpeed;
                    document.getElementById('batteryTime').textContent = 
                        `é¢„è®¡ ${formatTime(hoursToFull)} å……æ»¡`;
                } else if (battery.chargingTime && battery.chargingTime !== Infinity) {
                    document.getElementById('batteryTime').textContent = 
                        `é¢„è®¡ ${formatTime(battery.chargingTime / 3600)} å……æ»¡`;
                } else {
                    document.getElementById('batteryTime').textContent = 'è®¡ç®—ä¸­...';
                }
            } else {
                document.getElementById('batteryCharging').textContent = 'ğŸ”‹ æœªå……ç”µ';
                
                if (level <= 20) {
                    document.getElementById('batteryFill').classList.add('low');
                    if (level <= 10 && isDetecting) {
                        addLog('warning', 'ç”µé‡ä¸¥é‡ä¸è¶³', `å½“å‰ç”µé‡: ${level}%`);
                    }
                }
                
                if (battery.dischargingTime && battery.dischargingTime !== Infinity) {
                    document.getElementById('batteryTime').textContent = 
                        `å¯ç”¨ ${formatTime(battery.dischargingTime / 3600)}`;
                } else {
                    document.getElementById('batteryTime').textContent = 'è®¡ç®—å‰©ä½™æ—¶é—´...';
                }
            }
        }

        function recordBatteryLevel(level, charging) {
            const now = Date.now();
            batteryChargeHistory.push({ level, time: now, charging });
            
            const fiveMinutesAgo = now - 5 * 60 * 1000;
            batteryChargeHistory = batteryChargeHistory.filter(record => record.time > fiveMinutesAgo);
        }

        function calculateChargeSpeed() {
            if (batteryChargeHistory.length < 2) return 0;
            
            const first = batteryChargeHistory[0];
            const last = batteryChargeHistory[batteryChargeHistory.length - 1];
            
            const timeDiff = (last.time - first.time) / 1000 / 3600;
            const levelDiff = last.level - first.level;
            
            if (timeDiff > 0 && levelDiff > 0) {
                return levelDiff / timeDiff;
            }
            
            return 0;
        }

        function formatTime(hours) {
            if (hours < 1) {
                return `${Math.round(hours * 60)} åˆ†é’Ÿ`;
            } else {
                const h = Math.floor(hours);
                const m = Math.round((hours - h) * 60);
                return m > 0 ? `${h} å°æ—¶ ${m} åˆ†é’Ÿ` : `${h} å°æ—¶`;
            }
        }

        // ============ è¿è¡Œæ—¶é—´ ============
        function updateRunningTime() {
            if (!runningStartTime) return;
            
            const elapsed = Date.now() - runningStartTime;
            const formatted = formatRunningTime(elapsed);
            document.getElementById('runningTime').textContent = formatted;
        }

        function formatRunningTime(ms) {
            const seconds = Math.floor(ms / 1000);
            const h = Math.floor(seconds / 3600);
            const m = Math.floor((seconds % 3600) / 60);
            const s = seconds % 60;
            
            return `${String(h).padStart(2, '0')}:${String(m).padStart(2, '0')}:${String(s).padStart(2, '0')}`;
        }

        // ============ UI æ›´æ–° ============
        function updateDetectionBox() {
            const box = document.getElementById('detectionBox');
            const size = config.detectionArea;
            box.style.width = size + '%';
            box.style.height = size + '%';
            box.style.left = ((100 - size) / 2) + '%';
            box.style.top = ((100 - size) / 2) + '%';
        }

        // ============ ç»Ÿè®¡åŠŸèƒ½ ============
        function resetStats() {
            if (confirm('ç¡®å®šè¦é‡ç½®æ‰€æœ‰ç»Ÿè®¡æ•°æ®å—?')) {
                stats = {
                    detections: 0,
                    vibrations: 0,
                    notifications: 0
                };
                
                document.getElementById('detectionCount').textContent = '0';
                document.getElementById('vibrateCount').textContent = '0';
                document.getElementById('notificationCount').textContent = '0';
                document.getElementById('runningTime').textContent = '00:00:00';
                
                runningStartTime = null;
                
                addLog('warning', 'ç»Ÿè®¡æ•°æ®å·²é‡ç½®');
                showToast('ğŸ”„ ç»Ÿè®¡æ•°æ®å·²é‡ç½®');
                saveSettings();
            }
        }

        // ============ é€šçŸ¥æƒé™ ============
        async function requestNotificationPermission() {
            if ('Notification' in window && Notification.permission === 'default') {
                setTimeout(async () => {
                    const permission = await Notification.requestPermission();
                    if (permission === 'granted') {
                        showToast('âœ… é€šçŸ¥æƒé™å·²æˆäºˆ');
                        addLog('success', 'é€šçŸ¥æƒé™å·²æˆäºˆ');
                    } else {
                        addLog('warning', 'é€šçŸ¥æƒé™è¢«æ‹’ç»');
                    }
                }, 2000);
            }
        }

        // ============ è®¾å¤‡æ£€æµ‹ ============
        function checkDeviceType() {
            const isMobile = /Android|webOS|iPhone|iPad|iPod|BlackBerry|IEMobile|Opera Mini/i.test(navigator.userAgent);
            
            if (!isMobile) {
                document.querySelector('.desktop-warning').style.display = 'flex';
                addLog('error', 'æ£€æµ‹åˆ°PCç«¯è®¿é—®', 'æœ¬åº”ç”¨ä»…æ”¯æŒç§»åŠ¨è®¾å¤‡');
            } else {
                addLog('info', 'è®¾å¤‡ç±»å‹æ£€æµ‹é€šè¿‡', navigator.userAgent);
            }
        }

        // ============ æç¤ºä¿¡æ¯ ============
        function showToast(message, duration = 3000) {
            const toast = document.getElementById('toast');
            toast.textContent = message;
            toast.classList.add('show');
            
            setTimeout(() => {
                toast.classList.remove('show');
            }, duration);
        }

        function showWelcomeToast() {
            setTimeout(() => {
                showToast('ğŸ‘‹ æ¬¢è¿ä½¿ç”¨æ™ºèƒ½è¿åŠ¨æ£€æµ‹ç³»ç»Ÿ Pro', 5000);
            }, 500);
        }

        // ============ è®¾ç½®æŒä¹…åŒ– ============
        function saveSettings() {
            localStorage.setItem('motionDetectorConfig', JSON.stringify(config));
            localStorage.setItem('motionDetectorStats', JSON.stringify(stats));
        }

        function loadSettings() {
            const savedConfig = localStorage.getItem('motionDetectorConfig');
            const savedStats = localStorage.getItem('motionDetectorStats');
            
            if (savedConfig) {
                config = { ...config, ...JSON.parse(savedConfig) };
                
                Object.keys(config).forEach(key => {
                    const element = document.getElementById(key);
                    if (element) {
                        if (element.type === 'checkbox') {
                            element.checked = config[key];
                        } else if (element.type === 'range') {
                            element.value = config[key];
                            updateSliderValue(key, config[key]);
                        }
                    }
                });
                
                addLog('info', 'é…ç½®å·²åŠ è½½', 'ä»æœ¬åœ°å­˜å‚¨æ¢å¤è®¾ç½®');
            }
            
            if (savedStats) {
                stats = JSON.parse(savedStats);
                document.getElementById('detectionCount').textContent = stats.detections;
                document.getElementById('vibrateCount').textContent = stats.vibrations;
                document.getElementById('notificationCount').textContent = stats.notifications;
            }
            
            updateDetectionBox();
        }
<script>
(function() {
    console.log("ğŸ’ æ­£åœ¨åŠ è½½æ™ºèƒ½è¿åŠ¨æ£€æµ‹ç³»ç»Ÿå¢å¼ºè¡¥ä¸...");

    // ==========================================
    // 1. å®‰å…¨ä¿®å¤: é˜²æ­¢ XSS æ”»å‡» (Log System)
    // ==========================================
    const originalAddLog = window.addLog;
    
    // HTML è½¬ä¹‰å·¥å…·
    const escapeHTML = (str) => {
        if (typeof str !== 'string') return str;
        return str.replace(/[&<>'"]/g, 
            tag => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                "'": '&#39;',
                '"': '&quot;'
            }[tag]));
    };

    // åŠ«æŒ addLog å‡½æ•°
    window.addLog = function(level, message, detail = '') {
        // åœ¨å­˜å…¥ logs æ•°ç»„å‰æ¸…æ´—æ•°æ®ï¼Œå½»åº•é˜»æ–­ HTML æ³¨å…¥
        const safeMessage = escapeHTML(message);
        const safeDetail = escapeHTML(detail);
        return originalAddLog.call(this, level, safeMessage, safeDetail);
    };

    // ==========================================
    // 2. ç¨³å®šæ€§ä¿®å¤: èµ„æºæ¸…ç†ä¸å†…å­˜ä¿æŠ¤
    // ==========================================
    const originalStart = window.startDetection;
    const originalStop = window.stopDetection;

    window.stopDetection = function() {
        // æ‰§è¡ŒåŸå‡½æ•°
        originalStop.call(this);
        
        // å¢å¼ºæ¸…ç†ï¼šç¡®ä¿æ‰€æœ‰è½¨é“å®Œå…¨åœæ­¢ï¼Œé˜²æ­¢æŸäº›ç§»åŠ¨ç«¯æµè§ˆå™¨å³ä½¿ srcObject=null ä»å ç”¨ç›¸æœº
        if (window.video && window.video.srcObject) {
            const tracks = window.video.srcObject.getTracks();
            tracks.forEach(track => track.stop());
            window.video.srcObject = null;
        }
        
        // å¼ºåˆ¶åƒåœ¾å›æ”¶å»ºè®® (è§£é™¤å¤§å¯¹è±¡å¼•ç”¨)
        window.previousImageData = null;
    };

    // ==========================================
    // 3. æ¸¸æˆæ‰‹æŸ„æ§åˆ¶ç³»ç»Ÿ (Gamepad System)
    // ==========================================
    
    // æ ·å¼æ³¨å…¥
    const style = document.createElement('style');
    style.innerHTML = `
        #gamepad-cursor {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(0,0,0,0.4);
            pointer-events: none;
            z-index: 99999;
            transform: translate(-50%, -50%);
            display: none;
            transition: opacity 0.2s;
            mix-blend-mode: hard-light;
        }
        #gamepad-cursor::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background: var(--danger-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        #gamepad-cursor.active {
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--primary-color);
            border-color: white;
        }
        /* ç‚¹å‡»æ³¢çº¹ç‰¹æ•ˆ */
        .cursor-ripple {
            position: fixed;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.4);
            transform: scale(0);
            animation: ripple 0.5s ease-out;
            pointer-events: none;
            z-index: 99998;
        }
        @keyframes ripple {
            to { transform: scale(3); opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    // åˆ›å»ºå…‰æ ‡å…ƒç´ 
    const cursor = document.createElement('div');
    cursor.id = 'gamepad-cursor';
    document.body.appendChild(cursor);

    // çŠ¶æ€å˜é‡
    let cursorX = window.innerWidth / 2;
    let cursorY = window.innerHeight / 2;
    let isCursorVisible = false;
    let lastAF = null;
    let lastButtonState = false; // Aé”®çŠ¶æ€
    
    // é…ç½®
    const DEAD_ZONE = 0.15;
    const CURSOR_SPEED = 12;
    const SCROLL_SPEED = 15;

    // è¾…åŠ©ï¼šæ¨¡æ‹Ÿç‚¹å‡»äº‹ä»¶
    function simulateClick(x, y) {
        // åˆ›å»ºæ³¢çº¹
        const ripple = document.createElement('div');
        ripple.className = 'cursor-ripple';
        ripple.style.left = (x - 25) + 'px';
        ripple.style.top = (y - 25) + 'px';
        ripple.style.width = '50px';
        ripple.style.height = '50px';
        document.body.appendChild(ripple);
        setTimeout(() => ripple.remove(), 550);

        // è·å–ç›®æ ‡å…ƒç´ 
        const element = document.elementFromPoint(x, y);
        if (element) {
            // ä¼˜å…ˆè§¦å‘ click
            element.click();
            
            // é’ˆå¯¹ range input (æ»‘å—) çš„ç‰¹æ®Šå¤„ç†
            if (element.tagName === 'INPUT' && element.type === 'range') {
                element.focus();
                // å°è¯•è§¦å‘ input äº‹ä»¶æ›´æ–°æ»‘å— UI
                // æ³¨æ„ï¼šç”±äºå®‰å…¨é™åˆ¶ï¼Œå®Œå…¨æ¨¡æ‹Ÿæ‹–æ‹½å¾ˆéš¾ï¼Œè¿™é‡Œä»…åšç‚¹å‡»è§¦å‘
                element.dispatchEvent(new Event('input', { bubbles: true }));
                element.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
    }

    // æ ¸å¿ƒå¾ªç¯
    function gameLoop() {
        const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
        const gp = gamepads[0] || gamepads[1] || gamepads[2] || gamepads[3]; // éå†å¯»æ‰¾ä»»æ„è¿æ¥çš„æ‰‹æŸ„

        if (gp) {
            // 1. å¤„ç†å…‰æ ‡æ˜¾éšï¼šåªæœ‰åŠ¨äº†æ‰æ˜¾ç¤º
            const hasInput = Math.abs(gp.axes[0]) > DEAD_ZONE || Math.abs(gp.axes[1]) > DEAD_ZONE || gp.buttons.some(b => b.pressed);
            
            if (!isCursorVisible && hasInput) {
                isCursorVisible = true;
                cursor.style.display = 'block';
                // åˆå§‹ä½ç½®é‡ç½®åˆ°å±å¹•ä¸­å¿ƒ
                cursorX = window.innerWidth / 2;
                cursorY = window.innerHeight / 2;
            }

            if (isCursorVisible) {
                // 2. å·¦æ‘‡æ†æ§åˆ¶å…‰æ ‡ç§»åŠ¨ (Axes 0, 1)
                const axisX = gp.axes[0];
                const axisY = gp.axes[1];

                if (Math.abs(axisX) > DEAD_ZONE) cursorX += axisX * CURSOR_SPEED;
                if (Math.abs(axisY) > DEAD_ZONE) cursorY += axisY * CURSOR_SPEED;

                // è¾¹ç•Œé™åˆ¶
                cursorX = Math.max(0, Math.min(window.innerWidth, cursorX));
                cursorY = Math.max(0, Math.min(window.innerHeight, cursorY));

                // æ›´æ–°è§†è§‰
                cursor.style.left = cursorX + 'px';
                cursor.style.top = cursorY + 'px';

                // 3. Aé”®ç‚¹å‡» (Button 0 - Xbox A / PS X)
                const btnA = gp.buttons[0];
                if (btnA.pressed && !lastButtonState) {
                    cursor.classList.add('active');
                    simulateClick(cursorX, cursorY);
                } else if (!btnA.pressed && lastButtonState) {
                    cursor.classList.remove('active');
                }
                lastButtonState = btnA.pressed;

                // 4. RT ç¼“æ…¢å‘ä¸Šç¿»é¡µ (Button 7 / Axis)
                // Xbox: RT is Button 7 (Analog). PS: R2 is Button 7.
                const btnRT = gp.buttons[7];
                const rtValue = (typeof btnRT === 'object') ? btnRT.value : btnRT;
                
                if (btnRT && (btnRT.pressed || rtValue > 0.1)) {
                    window.scrollBy({
                        top: -SCROLL_SPEED * (rtValue || 0.5),
                        behavior: 'auto'
                    });
                }

                // 5. RB ç¼“æ…¢å¾€ä¸‹ç¿»é¡µ (Button 5 - RB / R1)
                const btnRB = gp.buttons[5];
                if (btnRB && btnRB.pressed) {
                    window.scrollBy({
                        top: SCROLL_SPEED,
                        behavior: 'auto'
                    });
                }
            }
        }

        lastAF = requestAnimationFrame(gameLoop);
    }

    // å¯åŠ¨ç›‘å¬
    window.addEventListener("gamepadconnected", (e) => {
        addLog('success', 'å¤–éƒ¨è®¾å¤‡å·²è¿æ¥', `æ£€æµ‹åˆ°æ¸¸æˆæ‰‹æŸ„: ${e.gamepad.id}`);
        showToast('ğŸ® æ‰‹æŸ„å·²è¿æ¥');
        // ç¡®ä¿å¾ªç¯åªå¯åŠ¨ä¸€æ¬¡
        if (!lastAF) gameLoop();
    });

    window.addEventListener("gamepaddisconnected", (e) => {
        addLog('warning', 'å¤–éƒ¨è®¾å¤‡æ–­å¼€', 'æ¸¸æˆæ‰‹æŸ„è¿æ¥ä¸¢å¤±');
        showToast('ğŸš« æ‰‹æŸ„å·²æ–­å¼€');
        // å¯é€‰ï¼šæ–­å¼€åéšè—å…‰æ ‡
        cursor.style.display = 'none';
        isCursorVisible = false;
    });

    // é¡µé¢åŠ è½½æ—¶è‹¥å·²æœ‰æ‰‹æŸ„è¿æ¥ï¼Œç›´æ¥å¯åŠ¨
    if (navigator.getGamepads && (navigator.getGamepads()[0] || navigator.getGamepads()[1])) {
        gameLoop();
    }

})();
</script>
</body>
</html>
