<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>WebRTC ç©¿é€ä¼ è¾“ (LocalSend ç½‘é¡µç‰ˆåŸç†)</title>
    <script src="https://unpkg.com/peerjs@1.5.2/dist/peerjs.min.js"></script>
    <style>
        :root { --primary: #007bff; --bg: #f4f7f6; --card: #ffffff; }
        body { font-family: 'Segoe UI', sans-serif; background: var(--bg); color: #333; margin: 0; padding: 20px; display: flex; justify-content: center; }
        .container { width: 100%; max-width: 600px; background: var(--card); padding: 30px; border-radius: 16px; box-shadow: 0 10px 25px rgba(0,0,0,0.05); }
        h2 { text-align: center; color: var(--primary); margin-top: 0; }
        .status-box { text-align: center; padding: 15px; margin-bottom: 20px; border-radius: 8px; background: #e9ecef; }
        .my-id { font-size: 24px; font-weight: bold; color: var(--primary); letter-spacing: 1px; margin: 10px 0; word-break: break-all; }
        .input-group { display: flex; gap: 10px; margin-bottom: 20px; }
        input[type="text"] { flex: 1; padding: 12px; border: 1px solid #ddd; border-radius: 8px; outline: none; transition: 0.3s; }
        input[type="text"]:focus { border-color: var(--primary); }
        button { padding: 12px 24px; background: var(--primary); color: white; border: none; border-radius: 8px; cursor: pointer; font-weight: bold; transition: 0.2s; }
        button:hover { opacity: 0.9; }
        button:disabled { background: #ccc; cursor: not-allowed; }
        
        .chat-area { border: 1px solid #eee; height: 200px; overflow-y: auto; padding: 10px; border-radius: 8px; margin-bottom: 15px; background: #fafafa; font-size: 14px; }
        .log-item { margin-bottom: 5px; padding: 5px; border-radius: 4px; }
        .log-sys { color: #888; font-style: italic; font-size: 12px; }
        .log-in { background: #e3f2fd; color: #0d47a1; }
        .log-out { background: #e8f5e9; color: #1b5e20; text-align: right; }

        .file-controls { border-top: 1px solid #eee; padding-top: 20px; display: none; }
        .file-label { display: block; margin-bottom: 10px; font-weight: bold; }
        
        /* åŠ¨ç”»æç¤º */
        @keyframes pulse { 0% { opacity: 0.5; } 50% { opacity: 1; } 100% { opacity: 0.5; } }
        .connecting { animation: pulse 1.5s infinite; color: orange; }
    </style>
</head>
<body>

<div class="container">
    <h2>ğŸš€ WebRTC è¿œç¨‹/å±€åŸŸç½‘å¿«ä¼ </h2>
    
    <div class="status-box">
        <div>æˆ‘çš„è¿æ¥ ID (åˆ†äº«ç»™å¯¹æ–¹):</div>
        <div class="my-id" id="myId">æ­£åœ¨è¿æ¥å…¬å…±æœåŠ¡å™¨...</div>
        <div style="font-size: 12px; color: #666;">çŠ¶æ€: <span id="statusText">åˆå§‹åŒ–ä¸­...</span></div>
    </div>

    <div class="input-group" id="connectBox">
        <input type="text" id="targetId" placeholder="è¾“å…¥å¯¹æ–¹çš„ ID">
        <button onclick="connectToPeer()">è¿æ¥å¯¹æ–¹</button>
    </div>

    <div class="file-controls" id="transferArea">
        <div class="chat-area" id="logs"></div>
        
        <div style="display: flex; gap: 10px; align-items: center;">
            <input type="file" id="fileInput" style="flex: 1;">
            <button onclick="sendFile()">å‘é€æ–‡ä»¶</button>
        </div>
        <p style="font-size: 12px; color: #999; margin-top: 5px;">*æ–‡ä»¶ç›´è¿ä¼ è¾“ï¼Œä¸ç»è¿‡æœåŠ¡å™¨ï¼Œå¤§å°æ— é™åˆ¶ã€‚</p>
    </div>
</div>

<script>
    let peer;
    let conn;
    
    // åˆå§‹åŒ– PeerJS (ä½¿ç”¨å®˜æ–¹å…è´¹çš„å…¬å…±ä¿¡ä»¤æœåŠ¡å™¨)
    // è¿™é‡Œçš„ config åŒ…å«äº† Google çš„å…è´¹ STUN æœåŠ¡å™¨ï¼Œç”¨äºç©¿é€ NAT
    function init() {
        // åˆ›å»ºä¸€ä¸ªéšæœº IDï¼Œä¹Ÿå¯ä»¥åœ¨ new Peer('è‡ªå®šä¹‰ID') æŒ‡å®š
        peer = new Peer(null, {
            debug: 2,
            config: {
                'iceServers': [
                    { url: 'stun:stun.l.google.com:19302' },
                    { url: 'stun:stun1.l.google.com:19302' }
                ]
            }
        });

        // 1. æˆåŠŸè¿æ¥åˆ°ä¿¡ä»¤æœåŠ¡å™¨ï¼Œæ‹¿åˆ°è‡ªå·±çš„ ID
        peer.on('open', (id) => {
            document.getElementById('myId').innerText = id;
            updateStatus('âœ… åœ¨çº¿ (å…¬å…±æœåŠ¡å™¨)', 'green');
        });

        // 2. è¢«åŠ¨æ¥æ”¶è¿æ¥ (å½“åˆ«äººè¿æ¥æˆ‘æ—¶)
        peer.on('connection', (connection) => {
            handleConnection(connection);
        });

        peer.on('error', (err) => {
            updateStatus('âŒ é”™è¯¯: ' + err.type, 'red');
            console.error(err);
        });
        
        peer.on('disconnected', () => {
            updateStatus('âš ï¸ ä¸æœåŠ¡å™¨æ–­å¼€', 'orange');
            // å¯ä»¥å°è¯• peer.reconnect()
        });
    }

    // ä¸»åŠ¨å‘èµ·è¿æ¥
    function connectToPeer() {
        const targetId = document.getElementById('targetId').value.trim();
        if (!targetId) return alert('è¯·è¾“å…¥å¯¹æ–¹ ID');
        
        updateStatus('ğŸ”„ æ­£åœ¨ç©¿é€è¿æ¥...', 'orange');
        const connection = peer.connect(targetId, {
            reliable: true // å¯ç”¨å¯é ä¼ è¾“æ¨¡å¼
        });
        handleConnection(connection);
    }

    // å¤„ç†è¿æ¥é€»è¾‘ (æ— è®ºæ˜¯ä¸»åŠ¨è¿˜æ˜¯è¢«åŠ¨)
    function handleConnection(connection) {
        conn = connection;

        conn.on('open', () => {
            updateStatus('ğŸš€ P2P é€šé“å·²å»ºç«‹!', 'green');
            document.getElementById('connectBox').style.display = 'none'; // éšè—è¿æ¥æ¡†
            document.getElementById('transferArea').style.display = 'block'; // æ˜¾ç¤ºä¼ è¾“åŒº
            addLog('sys', 'åŒæ–¹å·²è¿æ¥ï¼Œå¯ä»¥å¼€å§‹å‘é€æ–‡ä»¶ã€‚');
        });

        // æ¥æ”¶æ•°æ®
        conn.on('data', (data) => {
            if (data.type === 'file') {
                // æ¥æ”¶åˆ°æ–‡ä»¶
                addLog('in', `æ”¶åˆ°æ–‡ä»¶: ${data.fileName} (${formatSize(data.fileSize)})`);
                receiveFile(data);
            } else if (data.type === 'msg') {
                // æ¥æ”¶åˆ°æ–‡å­—æ¶ˆæ¯
                addLog('in', data.content);
            }
        });

        conn.on('close', () => {
            updateStatus('ğŸš« è¿æ¥å·²æ–­å¼€', 'red');
            document.getElementById('connectBox').style.display = 'flex';
            document.getElementById('transferArea').style.display = 'none';
        });
    }

    // å‘é€æ–‡ä»¶
    function sendFile() {
        const fileInput = document.getElementById('fileInput');
        const file = fileInput.files[0];
        if (!file) return alert('è¯·é€‰æ‹©æ–‡ä»¶');

        addLog('out', `æ­£åœ¨å‘é€: ${file.name}...`);

        // å°†æ–‡ä»¶è½¬æ¢ä¸º Blob å‘é€
        // æ³¨æ„: å¤§æ–‡ä»¶åœ¨çœŸå®ç”Ÿäº§ç¯å¢ƒä¸­éœ€è¦åˆ‡ç‰‡(Chunking)ï¼Œè¿™é‡Œä¸ºäº†æ¼”ç¤ºä»£ç ç®€æ´ï¼Œç›´æ¥å‘é€ Blob
        // PeerJS ä¼šè‡ªåŠ¨å¤„ç†äºŒè¿›åˆ¶åˆ†åŒ…ï¼Œä½†è¿‡å¤§çš„æ–‡ä»¶(>å‡ ç™¾MB)å¯èƒ½ä¼šå¡é¡¿æµè§ˆå™¨
        const blob = new Blob([file], { type: file.type });
        
        conn.send({
            type: 'file',
            file: blob,
            fileName: file.name,
            fileSize: file.size,
            fileType: file.type
        });
        
        addLog('sys', 'æ–‡ä»¶å‘é€æŒ‡ä»¤å·²å‘å‡º');
    }

    // å¤„ç†æ¥æ”¶åˆ°çš„æ–‡ä»¶å¹¶è§¦å‘ä¸‹è½½
    function receiveFile(data) {
        const blob = new Blob([data.file], { type: data.fileType });
        const url = URL.createObjectURL(blob);
        
        // åˆ›å»ºä¸€ä¸ªåŠ¨æ€ä¸‹è½½é“¾æ¥
        const a = document.createElement('a');
        a.href = url;
        a.download = data.fileName;
        a.textContent = `â¬‡ï¸ ç‚¹å‡»ä¸‹è½½: ${data.fileName}`;
        a.style.display = 'block';
        a.style.marginTop = '5px';
        a.style.fontWeight = 'bold';
        
        const logDiv = document.getElementById('logs');
        const item = document.createElement('div');
        item.className = 'log-item log-in';
        item.appendChild(a);
        logDiv.appendChild(item);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    // è¾…åŠ©åŠŸèƒ½
    function updateStatus(text, color) {
        const el = document.getElementById('statusText');
        el.innerText = text;
        el.style.color = color || 'black';
    }

    function addLog(type, msg) {
        const logDiv = document.getElementById('logs');
        const item = document.createElement('div');
        item.className = `log-item log-${type}`;
        item.innerText = msg;
        logDiv.appendChild(item);
        logDiv.scrollTop = logDiv.scrollHeight;
    }

    function formatSize(bytes) {
        if (bytes === 0) return '0 B';
        const k = 1024;
        const sizes = ['B', 'KB', 'MB', 'GB'];
        const i = Math.floor(Math.log(bytes) / Math.log(k));
        return parseFloat((bytes / Math.pow(k, i)).toFixed(2)) + ' ' + sizes[i];
    }

    // å¯åŠ¨
    init();
</script>

</body>
</html>
