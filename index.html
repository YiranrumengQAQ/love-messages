<!DOCTYPE html>
<html lang="zh-CN">
<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>ÁæéÊôØÈöè‰∫´ - Á≤æÁæéÈ£éÊôØÂõæÁâáÈõÜ</title>
    <link href="https://fonts.googleapis.com/css2?family=Poppins:wght@300;400;500;600;700&display=swap" rel="stylesheet">
    <style>
        :root {
            --primary: #ff1493;
            --primary-light: #ff69b4;
            --secondary: #667eea;
            --success: #48bb78;
            --warning: #ed8936;
            --danger: #f56565;
            --bg-gradient: linear-gradient(135deg, #667eea 0%, #764ba2 50%, #f093fb 100%);
            --card-bg: rgba(255, 255, 255, 0.95);
            --shadow: 0 20px 60px rgba(0,0,0,0.15);
            --radius: 20px;
            --transition: all 0.3s cubic-bezier(0.4, 0, 0.2, 1);
        }
        
        * { 
            margin: 0; 
            padding: 0; 
            box-sizing: border-box;
            -webkit-user-select: none;
            -moz-user-select: none;
            -ms-user-select: none;
            user-select: none;
        }
        
        body {
            font-family: 'Poppins', sans-serif;
            background: #f5f5f5;
            overflow-x: hidden;
            -webkit-touch-callout: none;
        }
        
        /* ‰∏ãËΩΩÊåâÈíÆÊ†∑Âºè */
        .download-btn {
            position: absolute;
            top: 15px;
            right: 15px;
            width: 45px;
            height: 45px;
            border-radius: 50%;
            background: linear-gradient(135deg, rgba(72, 187, 120, 0.95), rgba(56, 161, 105, 0.95));
            backdrop-filter: blur(10px);
            border: none;
            color: white;
            font-size: 1.3em;
            cursor: pointer;
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 10;
            box-shadow: 0 4px 15px rgba(72, 187, 120, 0.4);
            transition: all 0.3s ease;
            opacity: 0;
            transform: scale(0.8);
        }
        
        .download-btn.show {
            display: flex;
            animation: downloadBtnAppear 0.4s ease forwards;
        }
        
        @keyframes downloadBtnAppear {
            to {
                opacity: 1;
                transform: scale(1);
            }
        }
        
        .download-btn:hover {
            transform: scale(1.1);
            box-shadow: 0 6px 20px rgba(72, 187, 120, 0.6);
            background: linear-gradient(135deg, rgba(56, 161, 105, 0.95), rgba(34, 139, 87, 0.95));
        }
        
        .download-btn:active {
            transform: scale(0.95);
        }
        
        .download-btn.downloading {
            animation: downloadPulse 1s infinite;
            pointer-events: none;
        }
        
        @keyframes downloadPulse {
            0%, 100% { transform: scale(1); }
            50% { transform: scale(1.1); }
        }
        
        /* ÈáçËØïÊèêÁ§∫Âä®Áîª */
        @keyframes retry-pulse {
            0%, 100% { transform: scale(1); opacity: 1; }
            50% { transform: scale(1.1); opacity: 0.8; }
        }
        
        .image-loading.retrying {
            animation: retry-pulse 1s infinite;
            color: #ed8936;
        }
        
        .retry-info {
            position: absolute;
            bottom: 10px;
            left: 50%;
            transform: translateX(-50%);
            background: rgba(237, 137, 54, 0.9);
            color: white;
            padding: 4px 12px;
            border-radius: 12px;
            font-size: 0.75em;
            font-weight: 600;
            z-index: 10;
            animation: slideUp 0.3s ease;
        }
        
        @keyframes slideUp {
            from { transform: translateX(-50%) translateY(20px); opacity: 0; }
            to { transform: translateX(-50%) translateY(0); opacity: 1; }
        }
        
        #gamepadCursor {
            position: fixed;
            width: 30px;
            height: 30px;
            background: radial-gradient(circle, rgba(102, 126, 234, 0.8), rgba(118, 75, 162, 0.6));
            border: 3px solid rgba(255, 255, 255, 0.9);
            border-radius: 50%;
            pointer-events: none;
            z-index: 99999;
            display: none;
            box-shadow: 0 0 20px rgba(102, 126, 234, 0.6), 0 0 40px rgba(118, 75, 162, 0.4);
            transition: transform 0.05s ease;
        }
        
        #gamepadCursor.active {
            display: block;
        }
        
        #gamepadCursor::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            width: 8px;
            height: 8px;
            background: white;
            border-radius: 50%;
        }
        
        .gamepad-toast {
            position: fixed;
            top: 20px;
            right: 20px;
            background: rgba(0, 0, 0, 0.9);
            color: white;
            padding: 15px 25px;
            border-radius: 12px;
            z-index: 100000;
            display: none;
            animation: slideInRight 0.3s ease;
            box-shadow: 0 10px 30px rgba(0,0,0,0.5);
        }
        
        .gamepad-toast.show {
            display: block;
        }
        
        @keyframes slideInRight {
            from {
                transform: translateX(400px);
                opacity: 0;
            }
            to {
                transform: translateX(0);
                opacity: 1;
            }
        }
        
        #landscapeView {
            min-height: 100vh;
            background: linear-gradient(135deg, #667eea 0%, #764ba2 100%);
        }
        
        .landscape-header {
            background: rgba(255, 255, 255, 0.95);
            backdrop-filter: blur(10px);
            padding: 20px;
            box-shadow: 0 2px 20px rgba(0,0,0,0.1);
            position: sticky;
            top: 0;
            z-index: 100;
        }
        
        .landscape-title {
            text-align: center;
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(45deg, #667eea, #764ba2);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            letter-spacing: 2px;
        }
        
        .landscape-subtitle {
            text-align: center;
            color: #718096;
            margin-top: 8px;
            font-size: 1em;
        }
        
        .landscape-container {
            max-width: 1400px;
            margin: 0 auto;
            padding: 40px 20px;
        }
        
        .gallery-grid {
            display: grid;
            grid-template-columns: repeat(auto-fill, minmax(350px, 1fr));
            gap: 30px;
            margin-top: 30px;
        }
        
        .image-card {
            background: white;
            border-radius: 15px;
            overflow: hidden;
            box-shadow: 0 10px 30px rgba(0,0,0,0.1);
            transition: transform 0.3s, box-shadow 0.3s;
            cursor: pointer;
        }
        
        .image-card:hover, .image-card.gamepad-hover {
            transform: translateY(-10px);
            box-shadow: 0 20px 50px rgba(0,0,0,0.2);
        }
        
        .image-wrapper {
            position: relative;
            width: 100%;
            height: 300px;
            overflow: hidden;
            background: #e2e8f0;
        }
        
        .image-wrapper img {
            width: 100%;
            height: 100%;
            object-fit: cover;
            transition: transform 0.3s;
        }
        
        .image-card:hover img {
            transform: scale(1.1);
        }
        
        .image-loading {
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: #cbd5e0;
            font-size: 1.2em;
        }
        
        .image-info {
            padding: 20px;
        }
        
        .image-author {
            font-weight: 600;
            color: #2d3748;
            margin-bottom: 8px;
        }
        
        .image-dimensions {
            color: #718096;
            font-size: 0.9em;
        }
        
        .refresh-btn {
            position: fixed;
            bottom: 40px;
            right: 40px;
            width: 60px;
            height: 60px;
            border-radius: 50%;
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
            border: none;
            font-size: 1.8em;
            cursor: pointer;
            box-shadow: 0 10px 30px rgba(102, 126, 234, 0.4);
            transition: all 0.3s;
            display: flex;
            align-items: center;
            justify-content: center;
            z-index: 50;
        }
        
        .refresh-btn:hover, .refresh-btn.gamepad-hover {
            transform: rotate(180deg) scale(1.1);
            box-shadow: 0 15px 40px rgba(102, 126, 234, 0.6);
        }
        
        .landscape-footer {
            background: rgba(255, 255, 255, 0.95);
            padding: 30px;
            text-align: center;
            color: #718096;
            margin-top: 60px;
        }
        
        #secretTrigger {
            cursor: default;
        }
        
        .stone-modal {
            position: fixed;
            top: 0;
            left: 0;
            width: 100%;
            height: 100%;
            background: rgba(0, 0, 0, 0.7);
            display: none;
            align-items: center;
            justify-content: center;
            z-index: 9999;
            animation: fadeIn 0.3s ease;
        }
        
        .stone-modal.active {
            display: flex;
        }
        
        @keyframes fadeIn {
            from { opacity: 0; }
            to { opacity: 1; }
        }
        
        .stone-drop {
            font-size: 8em;
            animation: stoneDrop 1s ease-out;
        }
        
        @keyframes stoneDrop {
            0% {
                transform: translateY(-500px) rotate(0deg);
                opacity: 0;
            }
            60% {
                transform: translateY(0) rotate(360deg);
                opacity: 1;
            }
            70% {
                transform: translateY(-50px) rotate(380deg);
            }
            80% {
                transform: translateY(0) rotate(360deg);
            }
            90% {
                transform: translateY(-20px) rotate(370deg);
            }
            100% {
                transform: translateY(0) rotate(360deg);
                opacity: 1;
            }
        }
        
        .hidden-stone {
            position: fixed;
            bottom: 120px;
            right: 40px;
            width: 50px;
            height: 50px;
            font-size: 2.5em;
            cursor: pointer;
            z-index: 60;
            display: none;
            animation: fadeIn 0.5s ease;
        }
        
        .hidden-stone.visible {
            display: block;
        }
        
        #appView {
            display: none;
        }
        
        #appView.active {
            display: block;
        }
        
        body.app-mode {
            background: var(--bg-gradient);
            padding: 20px;
            color: #2d3748;
        }
        
        .exit-btn {
            position: fixed;
            top: 20px;
            right: 20px;
            padding: 12px 24px;
            background: linear-gradient(135deg, #fc8181, #f56565);
            color: white;
            border: none;
            border-radius: 25px;
            font-weight: 600;
            cursor: pointer;
            z-index: 1000;
            box-shadow: 0 4px 15px rgba(245, 101, 101, 0.4);
            transition: all 0.3s;
        }
        
        .exit-btn:hover, .exit-btn.gamepad-hover {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(245, 101, 101, 0.6);
        }
        
        .app-container {
            max-width: 1200px;
            margin: 0 auto;
            display: grid;
            grid-template-columns: 1fr 1fr;
            gap: 20px;
        }
        
        .card {
            background: var(--card-bg);
            backdrop-filter: blur(20px);
            border-radius: var(--radius);
            padding: 30px;
            box-shadow: var(--shadow);
            transition: var(--transition);
        }
        
        .card:hover {
            transform: translateY(-5px);
            box-shadow: 0 25px 70px rgba(0,0,0,0.2);
        }
        
        .full-width { grid-column: 1 / -1; }
        
        header {
            text-align: center;
            margin-bottom: 10px;
        }
        
        .logo {
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(45deg, #667eea, #764ba2, #f093fb);
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            background-clip: text;
            letter-spacing: 2px;
            animation: shimmer 3s infinite;
        }
        
        @keyframes shimmer {
            0%, 100% { filter: hue-rotate(0deg); }
            50% { filter: hue-rotate(20deg); }
        }
        
        .version {
            color: #718096;
            font-size: 0.9em;
            margin-top: 5px;
        }
        
        .form-group {
            margin-bottom: 20px;
        }
        
        label {
            display: block;
            font-weight: 500;
            margin-bottom: 8px;
            color: #4a5568;
            font-size: 0.95em;
        }
        
        .input-wrapper {
            position: relative;
            display: flex;
            align-items: center;
        }
        
        input[type="number"], select {
            width: 100%;
            padding: 14px 18px;
            border: 2px solid #e2e8f0;
            border-radius: 12px;
            font-size: 1em;
            font-family: 'Poppins', sans-serif;
            transition: var(--transition);
            background: white;
        }
        
        input[type="number"]:focus, select:focus, 
        input[type="number"].gamepad-focus, select.gamepad-focus {
            outline: none;
            border-color: var(--primary-light);
            box-shadow: 0 0 0 4px rgba(255, 105, 180, 0.1);
            transform: scale(1.02);
        }
        
        .input-unit {
            position: absolute;
            right: 15px;
            color: #a0aec0;
            font-size: 0.9em;
            pointer-events: none;
        }
        
        .range-slider {
            width: 100%;
            height: 8px;
            border-radius: 4px;
            background: linear-gradient(to right, #48bb78, #ecc94b, #f56565);
            outline: none;
            -webkit-appearance: none;
            margin-top: 10px;
        }
        
        .range-slider::-webkit-slider-thumb {
            -webkit-appearance: none;
            width: 20px;
            height: 20px;
            border-radius: 50%;
            background: white;
            box-shadow: 0 2px 8px rgba(0,0,0,0.2);
            cursor: pointer;
            transition: var(--transition);
        }
        
        .range-slider::-webkit-slider-thumb:hover {
            transform: scale(1.2);
        }
        
        .toggle-section {
            background: linear-gradient(135deg, #e0f2fe, #bae6fd);
            border: 2px solid #7dd3fc;
            border-radius: 15px;
            padding: 20px;
            margin-bottom: 20px;
            transition: var(--transition);
        }
        
        .toggle-section.active {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border-color: var(--success);
        }
        
        .checkbox-wrapper {
            display: flex;
            align-items: center;
            gap: 15px;
            cursor: pointer;
            flex: 1;
        }
        
        .checkbox-wrapper input[type="checkbox"] {
            width: 24px;
            height: 24px;
            cursor: pointer;
            position: relative;
            appearance: none;
            background: white;
            border: 3px solid #cbd5e0;
            border-radius: 6px;
            transition: var(--transition);
            flex-shrink: 0;
        }
        
        .checkbox-wrapper input[type="checkbox"]:hover,
        .checkbox-wrapper input[type="checkbox"].gamepad-hover {
            border-color: var(--primary-light);
            transform: scale(1.1);
        }
        
        .checkbox-wrapper input[type="checkbox"]:checked {
            background: linear-gradient(135deg, var(--success), #38a169);
            border-color: var(--success);
        }
        
        .checkbox-wrapper input[type="checkbox"]:checked::before {
            content: '‚úì';
            position: absolute;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            color: white;
            font-size: 16px;
            font-weight: bold;
        }
        
        .checkbox-label {
            display: flex;
            align-items: center;
            gap: 10px;
            font-size: 1.05em;
            font-weight: 600;
            color: #0c4a6e;
        }
        
        .toggle-icon {
            font-size: 1.8em;
        }
        
        .toggle-status {
            font-size: 0.85em;
            color: #64748b;
            margin-top: 8px;
            padding: 8px 12px;
            background: rgba(255,255,255,0.6);
            border-radius: 8px;
        }
        
        .toggle-status.enabled {
            color: #065f46;
            background: rgba(167, 243, 208, 0.5);
        }
        
        .settings-history {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 2px solid #f59e0b;
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            max-height: 200px;
            overflow-y: auto;
        }
        
        .settings-history h4 {
            color: #92400e;
            margin-bottom: 10px;
            font-size: 0.95em;
        }
        
        .history-item {
            background: rgba(255,255,255,0.7);
            padding: 10px;
            border-radius: 8px;
            margin-bottom: 8px;
            font-size: 0.85em;
            display: flex;
            justify-content: space-between;
            align-items: center;
        }
        
        .history-timestamp {
            color: #78350f;
            font-size: 0.8em;
        }
        
        .history-actions {
            display: flex;
            gap: 5px;
        }
        
        .btn-mini {
            padding: 4px 10px;
            font-size: 0.75em;
            border-radius: 6px;
            border: none;
            cursor: pointer;
            transition: var(--transition);
            font-weight: 600;
        }
        
        .btn-restore {
            background: linear-gradient(135deg, #60a5fa, #3b82f6);
            color: white;
        }
        
        .btn-delete {
            background: linear-gradient(135deg, #fca5a5, #f87171);
            color: white;
        }
        
        .btn {
            padding: 14px 28px;
            border: none;
            border-radius: 12px;
            font-size: 1em;
            font-weight: 600;
            cursor: pointer;
            transition: var(--transition);
            font-family: 'Poppins', sans-serif;
            display: inline-flex;
            align-items: center;
            gap: 8px;
            justify-content: center;
        }
        
        .btn-primary {
            background: linear-gradient(135deg, var(--primary-light), var(--primary));
            color: white;
            box-shadow: 0 4px 15px rgba(255, 20, 147, 0.3);
        }
        
        .btn-primary:hover:not(:disabled),
        .btn-primary.gamepad-hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(255, 20, 147, 0.4);
        }
        
        .btn-secondary {
            background: linear-gradient(135deg, #667eea, #764ba2);
            color: white;
        }
        
        .btn-secondary:hover:not(:disabled),
        .btn-secondary.gamepad-hover:not(:disabled) {
            transform: translateY(-2px);
            box-shadow: 0 6px 20px rgba(102, 126, 234, 0.4);
        }
        
        .btn-danger {
            background: linear-gradient(135deg, #fc8181, #f56565);
            color: white;
        }
        
        .btn:disabled {
            opacity: 0.5;
            cursor: not-allowed;
        }
        
        .btn-group {
            display: flex;
            gap: 10px;
            flex-wrap: wrap;
        }
        
        .stat-card {
            background: linear-gradient(135deg, rgba(255,255,255,0.9), rgba(255,255,255,0.7));
            border-radius: 15px;
            padding: 20px;
            text-align: center;
            border: 2px solid rgba(255, 105, 180, 0.2);
        }
        
        .stat-value {
            font-size: 2.5em;
            font-weight: 700;
            background: linear-gradient(45deg, var(--primary-light), var(--primary));
            -webkit-background-clip: text;
            -webkit-text-fill-color: transparent;
            margin: 10px 0;
        }
        
        .stat-label {
            color: #718096;
            font-size: 0.9em;
            text-transform: uppercase;
            letter-spacing: 1px;
        }
        
        .progress-container {
            margin: 20px 0;
        }
        
        .progress-bar {
            height: 12px;
            background: #e2e8f0;
            border-radius: 6px;
            overflow: hidden;
            position: relative;
        }
        
        .progress-fill {
            height: 100%;
            background: linear-gradient(90deg, var(--primary-light), var(--primary));
            width: 0%;
            transition: width 0.5s ease;
            position: relative;
            overflow: hidden;
        }
        
        .progress-fill::after {
            content: '';
            position: absolute;
            top: 0;
            left: 0;
            bottom: 0;
            right: 0;
            background: linear-gradient(90deg, transparent, rgba(255,255,255,0.3), transparent);
            animation: shimmer-progress 2s infinite;
        }
        
        @keyframes shimmer-progress {
            0% { transform: translateX(-100%); }
            100% { transform: translateX(100%); }
        }
        
        .log-container {
            height: 400px;
            overflow-y: auto;
            background: #f7fafc;
            border-radius: 12px;
            padding: 15px;
            font-family: 'Courier New', monospace;
            font-size: 0.85em;
            border: 2px solid #e2e8f0;
        }
        
        .log-entry {
            padding: 10px;
            margin-bottom: 8px;
            border-radius: 8px;
            animation: slideIn 0.3s ease;
            display: flex;
            align-items: center;
            gap: 10px;
        }
        
        @keyframes slideIn {
            from { opacity: 0; transform: translateX(-20px); }
            to { opacity: 1; transform: translateX(0); }
        }
        
        .log-icon {
            font-size: 1.2em;
        }
        
        .log-insert {
            background: linear-gradient(135deg, #fed7d7, #feb2b2);
            border-left: 4px solid #f56565;
        }
        
        .log-withdraw {
            background: linear-gradient(135deg, #bee3f8, #90cdf4);
            border-left: 4px solid #4299e1;
        }
        
        .log-info {
            background: linear-gradient(135deg, #feebc8, #fbd38d);
            border-left: 4px solid #ed8936;
        }
        
        .log-success {
            background: linear-gradient(135deg, #c6f6d5, #9ae6b4);
            border-left: 4px solid #48bb78;
        }
        
        .log-motivation {
            background: linear-gradient(135deg, #e0e7ff, #c7d2fe);
            border-left: 4px solid #6366f1;
        }
        
        .safety-alert {
            border: 2px solid;
            border-radius: 12px;
            padding: 15px;
            margin-top: 15px;
            display: flex;
            align-items: center;
            gap: 12px;
            animation: slideDown 0.3s ease;
        }
        
        @keyframes slideDown {
            from { opacity: 0; transform: translateY(-10px); }
            to { opacity: 1; transform: translateY(0); }
        }
        
        .safety-alert.high {
            background: linear-gradient(135deg, #d1fae5, #a7f3d0);
            border-color: var(--success);
        }
        
        .safety-alert.medium {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border-color: var(--warning);
        }
        
        .safety-alert.low {
            background: linear-gradient(135deg, #fed7d7, #fecaca);
            border-color: var(--danger);
        }
        
        .safety-icon {
            font-size: 1.5em;
        }
        
        .calculation-result {
            background: linear-gradient(135deg, #e6fffa, #b2f5ea);
            border: 2px solid #4fd1c5;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .result-item {
            display: flex;
            justify-content: space-between;
            padding: 8px 0;
            border-bottom: 1px solid rgba(79, 209, 197, 0.3);
        }
        
        .result-item:last-child {
            border-bottom: none;
        }
        
        .result-value {
            font-weight: 600;
            color: var(--primary);
        }
        
        .chart-container {
            height: 200px;
            display: flex;
            align-items: flex-end;
            gap: 5px;
            padding: 10px;
            background: #f7fafc;
            border-radius: 12px;
        }
        
        .chart-bar {
            flex: 1;
            background: linear-gradient(to top, var(--primary-light), var(--primary));
            border-radius: 4px 4px 0 0;
            transition: var(--transition);
            position: relative;
        }
        
        .chart-bar:hover {
            opacity: 0.8;
            transform: scaleY(1.05);
        }
        
        .health-report {
            background: linear-gradient(135deg, #fef3c7, #fde68a);
            border: 3px solid #f59e0b;
            border-radius: 15px;
            padding: 25px;
            margin-top: 20px;
            animation: slideDown 0.5s ease;
        }
        
        .health-report h3 {
            color: #92400e;
            margin-bottom: 15px;
            font-size: 1.3em;
        }
        
        .health-item {
            background: rgba(255,255,255,0.7);
            padding: 12px;
            border-radius: 10px;
            margin-bottom: 10px;
            border-left: 4px solid #f59e0b;
        }
        
        .health-item strong {
            color: #92400e;
        }
        
        .care-tips {
            background: linear-gradient(135deg, #dbeafe, #bfdbfe);
            border: 2px solid #3b82f6;
            border-radius: 12px;
            padding: 20px;
            margin-top: 15px;
        }
        
        .care-tips h4 {
            color: #1e40af;
            margin-bottom: 12px;
        }
        
        .care-tips ul {
            list-style: none;
            padding: 0;
        }
        
        .care-tips li {
            padding: 8px 0;
            padding-left: 25px;
            position: relative;
        }
        
        .care-tips li::before {
            content: '‚úì';
            position: absolute;
            left: 0;
            color: #3b82f6;
            font-weight: bold;
        }
        
        .hidden { display: none !important; }
        
        .celebration {
            position: fixed;
            top: 50%;
            left: 50%;
            transform: translate(-50%, -50%);
            font-size: 5em;
            animation: celebrate 1s ease-out;
            pointer-events: none;
            z-index: 1000;
        }
        
        @keyframes celebrate {
            0% { transform: translate(-50%, -50%) scale(0); opacity: 0; }
            50% { transform: translate(-50%, -50%) scale(1.2); opacity: 1; }
            100% { transform: translate(-50%, -50%) scale(1); opacity: 0; }
        }
        
        @keyframes spin {
            to { transform: rotate(360deg); }
        }
        
        .spinner {
            animation: spin 1s linear infinite;
        }
        
        @media (max-width: 1024px) {
            .app-container {
                grid-template-columns: 1fr;
            }
            
            .gallery-grid {
                grid-template-columns: repeat(auto-fill, minmax(280px, 1fr));
                gap: 20px;
            }
            
            .landscape-title {
                font-size: 2em;
            }
            
            .logo {
                font-size: 2em;
            }
        }
        
        @media (max-width: 768px) {
            body.app-mode {
                padding: 10px;
            }
            
            .app-container {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .card {
                padding: 20px;
            }
            
            .logo {
                font-size: 1.8em;
            }
            
            .gallery-grid {
                grid-template-columns: 1fr;
                gap: 15px;
            }
            
            .landscape-title {
                font-size: 1.8em;
            }
            
            .landscape-container {
                padding: 20px 10px;
            }
            
            .refresh-btn {
                width: 50px;
                height: 50px;
                bottom: 20px;
                right: 20px;
                font-size: 1.5em;
            }
            
            .hidden-stone {
                bottom: 90px;
                right: 20px;
                font-size: 2em;
            }
            
            .exit-btn {
                top: 10px;
                right: 10px;
                padding: 10px 20px;
                font-size: 0.9em;
            }
            
            .stat-card {
                padding: 15px;
            }
            
            .stat-value {
                font-size: 2em;
            }
            
            .log-container {
                height: 300px;
                font-size: 0.8em;
            }
            
            .gamepad-toast {
                top: 10px;
                right: 10px;
                left: 10px;
                padding: 12px 20px;
                font-size: 0.9em;
            }
            
            #gamepadCursor {
                width: 40px;
                height: 40px;
                border-width: 4px;
            }
            
            .download-btn {
                width: 40px;
                height: 40px;
                font-size: 1.1em;
                top: 10px;
                right: 10px;
            }
        }
        
        @media (max-width: 480px) {
            .landscape-title {
                font-size: 1.5em;
            }
            
            .logo {
                font-size: 1.5em;
            }
            
            .btn {
                padding: 12px 20px;
                font-size: 0.9em;
            }
            
            .form-group label {
                font-size: 0.9em;
            }
            
            input[type="number"], select {
                padding: 12px 15px;
                font-size: 0.95em;
            }
        }
    </style>
</head>
<body>
    <div id="gamepadCursor"></div>
    <div class="gamepad-toast" id="gamepadToast"></div>
    <div class="stone-modal" id="stoneModal">
        <div class="stone-drop">ü™®</div>
    </div>
    <div class="hidden-stone" id="hiddenStone">ü™®</div>
    
    <div id="landscapeView">
        <div class="landscape-header">
            <h1 class="landscape-title">üåÑ ÁæéÊôØÈöè‰∫´</h1>
            <p class="landscape-subtitle">ÂèëÁé∞‰∏ñÁïåÂêÑÂú∞ÁöÑÁ≤æÁæéÈ£éÊôØÁÖßÁâá</p>
        </div>
        
        <div class="landscape-container">
            <div class="gallery-grid" id="gallery"></div>
        </div>
        
        <button class="refresh-btn" onclick="refreshGallery()" title="Âà∑Êñ∞ÂõæÁâá">
            üîÑ
        </button>
        
        <div class="landscape-footer">
            <p>ÂõæÁâáÊù•Ê∫ê: Lorem Picsum | ÊØèÊ¨°Âà∑Êñ∞ÈÉΩÊúâÊñ∞ÊÉäÂñú</p>
            <p style="margin-top: 10px; font-size: 0.9em;">¬© 2025 ÁæéÊôØÈöè‰∫´. All <span id="secretTrigger">r</span>ights reserved.</p>
        </div>
    </div>

    <div id="appView">
        <button class="exit-btn" onclick="exitApp()">‚Üê ËøîÂõûÈ£éÊôØ</button>
        
        <div class="app-container">
            <div class="card full-width">
                <header>
                    <div class="logo">‚ô• PLEASURE ANALYTICS PRO ‚ô•</div>
                    <div class="version">Version 5.0 - Êô∫ËÉΩËÆ°ÁÆó | ËÆæÁΩÆËÆ∞ÂøÜ | ÂÅ•Â∫∑ÁõëÊµã</div>
                </header>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px; color: var(--primary);">‚öôÔ∏è ÂèÇÊï∞ËÆæÁΩÆ</h2>
                
                <div class="toggle-section" id="lubeSection">
                    <div class="toggle-row">
                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="useLube" onchange="toggleLube()">
                            <div class="checkbox-label">
                                <span class="toggle-icon">üíß</span>
                                <span>‰ΩøÁî®Ê∂¶ÊªëÂâÇ</span>
                            </div>
                        </label>
                    </div>
                    <div class="toggle-status" id="lubeStatus">Êú™‰ΩøÁî®Ê∂¶ÊªëÂâÇ</div>
                </div>
                
                <div class="toggle-section" id="tipsSection">
                    <div class="toggle-row">
                        <label class="checkbox-wrapper">
                            <input type="checkbox" id="showMotivation" checked onchange="toggleMotivation()">
                            <div class="checkbox-label">
                                <span class="toggle-icon">üí¨</span>
                                <span>‰∏≠ÈÄîÈºìÂä±ÊèêÁ§∫</span>
                            </div>
                        </label>
                    </div>
                    <div class="toggle-status enabled" id="motivationStatus">Â∑≤ÂºÄÂêØ</div>
                </div>
                
                <div class="form-group">
                    <label>Áé©ÂÖ∑ÈïøÂ∫¶ (cm)</label>
                    <div class="input-wrapper">
                        <input type="number" id="toyLength" min="1" max="150" step="0.1" value="15" onchange="saveSettings()">
                        <span class="input-unit">cm</span>
                    </div>
                    <input type="range" class="range-slider" id="lengthSlider" min="1" max="150" step="0.1" value="15">
                </div>
                
                <div class="form-group">
                    <label>Áé©ÂÖ∑Áõ¥ÂæÑ (cm)</label>
                    <div class="input-wrapper">
                        <input type="number" id="toyDiameter" min="0.5" max="10" step="0.1" value="3" onchange="saveSettings()">
                        <span class="input-unit">cm</span>
                    </div>
                    <input type="range" class="range-slider" id="diameterSlider" min="0.5" max="10" step="0.1" value="3">
                </div>
                
                <div class="form-group">
                    <label>‰ΩøÁî®Ê¨°Êï∞</label>
                    <div class="input-wrapper">
                        <input type="number" id="totalCount" min="2" max="100" step="2" value="10" onchange="saveSettings()">
                        <span class="input-unit">Ê¨°</span>
                    </div>
                </div>
                
                <div class="form-group">
                    <label>‰ΩøÁî®ÁªèÈ™å</label>
                    <select id="experience" onchange="saveSettings()">
                        <option value="beginner">ÂàùÂ≠¶ËÄÖ</option>
                        <option value="intermediate" selected>‰∏≠Á∫ßËÄÖ</option>
                        <option value="advanced">È´òÁ∫ßËÄÖ</option>
                        <option value="expert">‰∏ìÂÆ∂Á∫ß</option>
                    </select>
                </div>
                
                <div class="btn-group">
                    <button class="btn btn-secondary" onclick="calculateParams()">
                        üßÆ Êô∫ËÉΩËÆ°ÁÆó
                    </button>
                    <button class="btn btn-primary" id="startBtn" onclick="startSession()" disabled>
                        ‚ñ∂Ô∏è ÂºÄÂßã‰ºöËØù
                    </button>
                </div>
                
                <div id="calculationResult" class="hidden"></div>
                <div id="safetyAlert" class="hidden"></div>
                
                <div class="settings-history hidden" id="settingsHistory">
                    <h4>üìã ÊúÄËøëËÆæÁΩÆËÆ∞ÂΩï</h4>
                    <div id="historyList"></div>
                    <div style="text-align: center; margin-top: 10px;">
                        <button class="btn-mini" style="background: #64748b; color: white;" onclick="clearAllHistory()">
                            Ê∏ÖÁ©∫ÊâÄÊúâËÆ∞ÂΩï
                        </button>
                    </div>
                </div>
            </div>

            <div class="card">
                <h2 style="margin-bottom: 20px; color: var(--primary);">üìä ÂÆûÊó∂ÁªüËÆ°</h2>
                
                <div style="display: grid; grid-template-columns: 1fr 1fr; gap: 15px; margin-bottom: 20px;">
                    <div class="stat-card">
                        <div class="stat-label">ËøêË°åÊó∂Èó¥</div>
                        <div class="stat-value" id="timer">00:00:00</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ÂÆåÊàêËøõÂ∫¶</div>
                        <div class="stat-value" id="progress">0%</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">ÊèíÂÖ•Ê¨°Êï∞</div>
                        <div class="stat-value" id="insertCount">0</div>
                    </div>
                    <div class="stat-card">
                        <div class="stat-label">Ââ©‰ΩôÊó∂Èó¥</div>
                        <div class="stat-value" id="remaining">--:--</div>
                    </div>
                </div>
                
                <div class="progress-container">
                    <div class="progress-bar">
                        <div class="progress-fill" id="progressBar"></div>
                    </div>
                </div>
                
                <div class="btn-group hidden" id="controlButtons">
                    <button class="btn btn-secondary" onclick="pauseSession()">
                        ‚è∏Ô∏è <span id="pauseText">ÊöÇÂÅú</span>
                    </button>
                    <button class="btn btn-danger" onclick="stopSession()">
                        ‚èπÔ∏è ÂÅúÊ≠¢
                    </button>
                </div>
                
                <div style="margin-top: 20px;">
                    <h3 style="font-size: 1em; color: #4a5568; margin-bottom: 10px;">‰ºöËØùÂéÜÂè≤</h3>
                    <div class="chart-container" id="historyChart">
                        <div style="text-align: center; width: 100%; color: #a0aec0;">ÊöÇÊó†Êï∞ÊçÆ</div>
                    </div>
                </div>
            </div>

            <div class="card full-width">
                <h2 style="margin-bottom: 15px; color: var(--primary);">üìù Ê¥ªÂä®Êó•Âøó</h2>
                <div class="log-container" id="logContainer">
                    <div class="log-entry log-info">
                        <span class="log-icon">‚ÑπÔ∏è</span>
                        <span>Á≥ªÁªüÂ∞±Áª™ - ÊÇ®ÁöÑËÆæÁΩÆ‰ºöËá™Âä®‰øùÂ≠ò</span>
                    </div>
                </div>
                
                <div id="healthReport" class="hidden"></div>
            </div>
        </div>
    </div>

    <script>
        document.addEventListener('contextmenu', (e) => e.preventDefault());
        document.addEventListener('copy', (e) => e.preventDefault());
        document.addEventListener('cut', (e) => e.preventDefault());
        document.addEventListener('keydown', (e) => {
            if ((e.ctrlKey || e.metaKey) && (e.key === 'c' || e.key === 'C' || e.key === 'x' || e.key === 'X' || e.key === 'a' || e.key === 'A')) {
                e.preventDefault();
            }
        });
        
        // ========== ÂõæÁâáÂä†ËΩΩÁÆ°ÁêÜÂô®ÔºàÂ∏¶Ëá™Âä®ÈáçËØïÂíå‰∏ãËΩΩÂäüËÉΩÔºâ ==========
        const ImageLoadManager = {
            maxRetries: 3,
            retryDelay: 2000,
            retryingImages: new Map(),
            
            createImageCardWithRetry(id, container) {
                const card = document.createElement('div');
                card.className = 'image-card';
                card.dataset.imageId = id;
                
                const wrapper = document.createElement('div');
                wrapper.className = 'image-wrapper';
                
                const loading = document.createElement('div');
                loading.className = 'image-loading spinner';
                loading.textContent = '‚è≥';
                wrapper.appendChild(loading);
                
                const downloadBtn = document.createElement('button');
                downloadBtn.className = 'download-btn';
                downloadBtn.innerHTML = '‚¨áÔ∏è';
                downloadBtn.title = '‰∏ãËΩΩÂõæÁâá';
                downloadBtn.onclick = (e) => {
                    e.stopPropagation();
                    this.downloadImage(img, id);
                };
                wrapper.appendChild(downloadBtn);
                
                const img = document.createElement('img');
                img.src = `https://picsum.photos/id/${id}/400/300`;
                img.alt = 'È£éÊôØÁÖßÁâá';
                img.style.display = 'none';
                
                img.onload = () => {
                    loading.style.display = 'none';
                    img.style.display = 'block';
                    this.retryingImages.delete(id);
                    
                    setTimeout(() => {
                        downloadBtn.classList.add('show');
                    }, 300);
                };
                
                img.onerror = () => {
                    this.handleImageError(img, loading, id, 1, downloadBtn);
                };
                
                wrapper.appendChild(img);
                card.appendChild(wrapper);
                
                const info = document.createElement('div');
                info.className = 'image-info';
                info.innerHTML = `
                    <div class="image-author">Image #${id}</div>
                    <div class="image-dimensions">400 √ó 300 px</div>
                `;
                card.appendChild(info);
                
                container.appendChild(card);
            },
            
            handleImageError(img, loading, originalId, attemptNumber, downloadBtn) {
                downloadBtn.classList.remove('show');
                
                if (attemptNumber > this.maxRetries) {
                    loading.textContent = '‚ùå';
                    loading.classList.remove('spinner', 'retrying');
                    this.retryingImages.delete(originalId);
                    
                    setTimeout(() => {
                        const newId = Math.floor(Math.random() * 1000);
                        this.retryWithNewId(img, loading, newId, downloadBtn);
                    }, 5000);
                    return;
                }
                
                loading.classList.remove('spinner');
                loading.classList.add('retrying');
                loading.textContent = 'üîÑ';
                
                const wrapper = img.parentElement;
                let retryInfo = wrapper.querySelector('.retry-info');
                if (!retryInfo) {
                    retryInfo = document.createElement('div');
                    retryInfo.className = 'retry-info';
                    wrapper.appendChild(retryInfo);
                }
                retryInfo.textContent = `ÈáçËØï‰∏≠ ${attemptNumber}/${this.maxRetries}`;
                
                this.retryingImages.set(originalId, attemptNumber);
                
                setTimeout(() => {
                    const newId = Math.floor(Math.random() * 1000);
                    img.src = `https://picsum.photos/id/${newId}/400/300?t=${Date.now()}`;
                    
                    img.onerror = () => {
                        this.handleImageError(img, loading, originalId, attemptNumber + 1, downloadBtn);
                    };
                    
                    img.onload = () => {
                        loading.style.display = 'none';
                        img.style.display = 'block';
                        if (retryInfo) {
                            retryInfo.remove();
                        }
                        this.retryingImages.delete(originalId);
                        
                        setTimeout(() => {
                            downloadBtn.classList.add('show');
                        }, 300);
                        
                        const card = img.closest('.image-card');
                        const author = card.querySelector('.image-author');
                        if (author) {
                            author.textContent = `Image #${newId}`;
                        }
                        card.dataset.imageId = newId;
                    };
                }, this.retryDelay);
            },
            
            retryWithNewId(img, loading, newId, downloadBtn) {
                loading.classList.add('spinner');
                loading.classList.remove('retrying');
                loading.textContent = '‚è≥';
                img.style.display = 'none';
                downloadBtn.classList.remove('show');
                
                const wrapper = img.parentElement;
                const retryInfo = wrapper.querySelector('.retry-info');
                if (retryInfo) {
                    retryInfo.textContent = 'ÈáçÊñ∞Âä†ËΩΩ...';
                }
                
                img.src = `https://picsum.photos/id/${newId}/400/300?t=${Date.now()}`;
                
                img.onload = () => {
                    loading.style.display = 'none';
                    img.style.display = 'block';
                    if (retryInfo) {
                        retryInfo.remove();
                    }
                    
                    setTimeout(() => {
                        downloadBtn.classList.add('show');
                    }, 300);
                    
                    const card = img.closest('.image-card');
                    const author = card.querySelector('.image-author');
                    if (author) {
                        author.textContent = `Image #${newId}`;
                    }
                    card.dataset.imageId = newId;
                };
                
                img.onerror = () => {
                    this.handleImageError(img, loading, newId, 1, downloadBtn);
                };
            },
            
            async downloadImage(img, imageId) {
                const downloadBtn = img.parentElement.querySelector('.download-btn');
                
                downloadBtn.classList.add('downloading');
                downloadBtn.innerHTML = '‚è≥';
                
                try {
                    const response = await fetch(img.src);
                    const blob = await response.blob();
                    
                    const url = window.URL.createObjectURL(blob);
                    const a = document.createElement('a');
                    a.href = url;
                    a.download = `landscape-${imageId}-${Date.now()}.jpg`;
                    document.body.appendChild(a);
                    a.click();
                    
                    setTimeout(() => {
                        document.body.removeChild(a);
                        window.URL.revokeObjectURL(url);
                        
                        downloadBtn.classList.remove('downloading');
                        downloadBtn.innerHTML = '‚úÖ';
                        
                        setTimeout(() => {
                            downloadBtn.innerHTML = '‚¨áÔ∏è';
                        }, 2000);
                    }, 100);
                    
                } catch (error) {
                    console.error('‰∏ãËΩΩÂ§±Ë¥•:', error);
                    downloadBtn.classList.remove('downloading');
                    downloadBtn.innerHTML = '‚ùå';
                    
                    setTimeout(() => {
                        downloadBtn.innerHTML = '‚¨áÔ∏è';
                    }, 2000);
                }
            }
        };
        
        // ========== ÊâãÊüÑÊéßÂà∂Á≥ªÁªü ==========
        const GamepadController = {
            connected: false,
            gamepad: null,
            cursorX: window.innerWidth / 2,
            cursorY: window.innerHeight / 2,
            lastButtons: [],
            scrollSpeed: 20,
            cursorSpeed: 8,
            deadzone: 0.15,
            updateInterval: null,
            
            init() {
                window.addEventListener('gamepadconnected', (e) => this.onConnect(e));
                window.addEventListener('gamepaddisconnected', (e) => this.onDisconnect(e));
                this.checkGamepads();
            },
            
            checkGamepads() {
                const gamepads = navigator.getGamepads();
                if (gamepads && gamepads[0]) {
                    if (!this.connected) {
                        this.onConnect({ gamepad: gamepads[0] });
                    }
                }
            },
            
            onConnect(e) {
                this.connected = true;
                this.gamepad = e.gamepad;
                this.showToast(`üéÆ ÊâãÊüÑÂ∑≤ËøûÊé•: ${e.gamepad.id}`);
                this.showCursor();
                this.startUpdate();
            },
            
            onDisconnect(e) {
                this.connected = false;
                this.showToast('‚ùå ÊâãÊüÑÂ∑≤Êñ≠ÂºÄ');
                this.hideCursor();
                this.stopUpdate();
            },
            
            showToast(message) {
                const toast = document.getElementById('gamepadToast');
                toast.textContent = message;
                toast.classList.add('show');
                setTimeout(() => {
                    toast.classList.remove('show');
                }, 3000);
            },
            
            showCursor() {
                const cursor = document.getElementById('gamepadCursor');
                cursor.classList.add('active');
                cursor.style.left = this.cursorX + 'px';
                cursor.style.top = this.cursorY + 'px';
            },
            
            hideCursor() {
                document.getElementById('gamepadCursor').classList.remove('active');
            },
            
            startUpdate() {
                if (this.updateInterval) return;
                this.updateInterval = setInterval(() => this.update(), 16);
            },
            
            stopUpdate() {
                if (this.updateInterval) {
                    clearInterval(this.updateInterval);
                    this.updateInterval = null;
                }
            },
            
            update() {
                const gamepads = navigator.getGamepads();
                if (!gamepads || !gamepads[0]) return;
                
                const gp = gamepads[0];
                
                const leftX = this.applyDeadzone(gp.axes[0]);
                const leftY = this.applyDeadzone(gp.axes[1]);
                
                if (leftX !== 0 || leftY !== 0) {
                    this.cursorX += leftX * this.cursorSpeed;
                    this.cursorY += leftY * this.cursorSpeed;
                    
                    this.cursorX = Math.max(0, Math.min(window.innerWidth, this.cursorX));
                    this.cursorY = Math.max(0, Math.min(window.innerHeight, this.cursorY));
                    
                    const cursor = document.getElementById('gamepadCursor');
                    cursor.style.left = this.cursorX + 'px';
                    cursor.style.top = this.cursorY + 'px';
                    
                    this.updateHoverElement();
                }
                
                const rightY = this.applyDeadzone(gp.axes[3]);
                if (Math.abs(rightY) > 0) {
                    window.scrollBy(0, rightY * this.scrollSpeed);
                }
                
                this.handleButtons(gp);
            },
            
            applyDeadzone(value) {
                return Math.abs(value) < this.deadzone ? 0 : value;
            },
            
            updateHoverElement() {
                const element = document.elementFromPoint(this.cursorX, this.cursorY);
                
                document.querySelectorAll('.gamepad-hover').forEach(el => {
                    el.classList.remove('gamepad-hover');
                });
                
                if (element) {
                    if (element.matches('button, a, input, select, .image-card, .btn-mini, .download-btn')) {
                        element.classList.add('gamepad-hover');
                    }
                }
            },
            
            handleButtons(gp) {
                const buttons = gp.buttons;
                
                if (this.isButtonPressed(buttons[0], 0)) {
                    this.simulateClick();
                }
                
                if (this.isButtonPressed(buttons[1], 1)) {
                    if (document.getElementById('appView').classList.contains('active')) {
                        exitApp();
                    }
                }
                
                if (this.isButtonPressed(buttons[2], 2)) {
                    location.reload();
                }
                
                if (this.isButtonPressed(buttons[7], 7)) {
                    if (document.getElementById('appView').classList.contains('active')) {
                        const startBtn = document.getElementById('startBtn');
                        if (!startBtn.disabled) {
                            startSession();
                        }
                    }
                }
                
                if (this.isButtonPressed(buttons[5], 5)) {
                    if (document.getElementById('appView').classList.contains('active')) {
                        if (session.isRunning) {
                            stopSession();
                        }
                    }
                }
                
                this.lastButtons = buttons.map(b => b.pressed);
            },
            
            isButtonPressed(button, index) {
                const pressed = button.pressed;
                const wasPressed = this.lastButtons[index] || false;
                return pressed && !wasPressed;
            },
            
            simulateClick() {
                const element = document.elementFromPoint(this.cursorX, this.cursorY);
                if (element) {
                    element.click();
                }
            }
        };
        
        // ========== ÁßòÂØÜËß¶ÂèëÊú∫Âà∂ ==========
        let triggerClickCount = 0;
        let stoneClickCount = 0;
        let stoneVisible = false;
        
        document.getElementById('secretTrigger').addEventListener('click', function(e) {
            e.stopPropagation();
            triggerClickCount++;
            
            if (triggerClickCount >= 10) {
                showStoneModal();
                triggerClickCount = 0;
            }
        });
        
        function showStoneModal() {
            const modal = document.getElementById('stoneModal');
            modal.classList.add('active');
            
            setTimeout(() => {
                modal.classList.remove('active');
                showHiddenStone();
            }, 2000);
        }
        
        function showHiddenStone() {
            const stone = document.getElementById('hiddenStone');
            stone.classList.add('visible');
            stoneVisible = true;
        }
        
        document.getElementById('hiddenStone').addEventListener('click', function(e) {
            e.stopPropagation();
            if (!stoneVisible) return;
            
            stoneClickCount++;
            
            if (stoneClickCount >= 10) {
                enterApp();
                stoneClickCount = 0;
                this.classList.remove('visible');
                stoneVisible = false;
            }
        });
        
        // ========== È£éÊôØÁïåÈù¢ÈÄªËæë ==========
        function loadGallery() {
            const gallery = document.getElementById('gallery');
            gallery.innerHTML = '';
            
            for (let i = 0; i < 12; i++) {
                const randomId = Math.floor(Math.random() * 1000);
                ImageLoadManager.createImageCardWithRetry(randomId, gallery);
            }
        }
        
        function refreshGallery() {
            loadGallery();
        }
        
        function enterApp() {
            document.getElementById('landscapeView').style.display = 'none';
            document.getElementById('appView').classList.add('active');
            document.body.classList.add('app-mode');
            loadSettings();
            loadSessionHistory();
            displaySettingsHistory();
        }
        
        function exitApp() {
            document.getElementById('landscapeView').style.display = 'block';
            document.getElementById('appView').classList.remove('active');
            document.body.classList.remove('app-mode');
            
            triggerClickCount = 0;
            stoneClickCount = 0;
            document.getElementById('hiddenStone').classList.remove('visible');
            stoneVisible = false;
        }
        
        window.addEventListener('DOMContentLoaded', () => {
            loadGallery();
            GamepadController.init();
        });
        
        // ========== ÂäüËÉΩÁïåÈù¢ÂÆåÊï¥‰ª£Á†Å ==========
        const StorageManager = {
            KEYS: {
                CURRENT_SETTINGS: 'pleasureAnalytics_currentSettings',
                SETTINGS_HISTORY: 'pleasureAnalytics_settingsHistory',
                SESSION_HISTORY: 'pleasureAnalytics_sessionHistory'
            },
            
            isAvailable() {
                try {
                    const test = '__storage_test__';
                    localStorage.setItem(test, test);
                    localStorage.removeItem(test);
                    return true;
                } catch(e) {
                    return false;
                }
            },
            
            saveCurrentSettings(settings) {
                if (!this.isAvailable()) return false;
                try {
                    localStorage.setItem(this.KEYS.CURRENT_SETTINGS, JSON.stringify(settings));
                    return true;
                } catch(e) {
                    return false;
                }
            },
            
            loadCurrentSettings() {
                if (!this.isAvailable()) return null;
                try {
                    const data = localStorage.getItem(this.KEYS.CURRENT_SETTINGS);
                    return data ? JSON.parse(data) : null;
                } catch(e) {
                    return null;
                }
            },
            
            addToHistory(settings) {
                if (!this.isAvailable()) return false;
                try {
                    let history = this.getSettingsHistory();
                    const newEntry = {
                        ...settings,
                        timestamp: new Date().toISOString(),
                        id: Date.now()
                    };
                    
                    history.unshift(newEntry);
                    
                    if (history.length > 10) {
                        history = history.slice(0, 10);
                    }
                    
                    localStorage.setItem(this.KEYS.SETTINGS_HISTORY, JSON.stringify(history));
                    return true;
                } catch(e) {
                    return false;
                }
            },
            
            getSettingsHistory() {
                if (!this.isAvailable()) return [];
                try {
                    const data = localStorage.getItem(this.KEYS.SETTINGS_HISTORY);
                    return data ? JSON.parse(data) : [];
                } catch(e) {
                    return [];
                }
            },
            
            deleteHistoryItem(id) {
                if (!this.isAvailable()) return false;
                try {
                    let history = this.getSettingsHistory();
                    history = history.filter(item => item.id !== id);
                    localStorage.setItem(this.KEYS.SETTINGS_HISTORY, JSON.stringify(history));
                    return true;
                } catch(e) {
                    return false;
                }
            },
            
            clearHistory() {
                if (!this.isAvailable()) return false;
                try {
                    localStorage.removeItem(this.KEYS.SETTINGS_HISTORY);
                    return true;
                } catch(e) {
                    return false;
                }
            },
            
            saveSessionHistory(history) {
                if (!this.isAvailable()) return false;
                try {
                    localStorage.setItem(this.KEYS.SESSION_HISTORY, JSON.stringify(history));
                    return true;
                } catch(e) {
                    return false;
                }
            },
            
            loadSessionHistory() {
                if (!this.isAvailable()) return [];
                try {
                    const data = localStorage.getItem(this.KEYS.SESSION_HISTORY);
                    return data ? JSON.parse(data) : [];
                } catch(e) {
                    return [];
                }
            }
        };
        
        let config = {
            length: 15,
            diameter: 3,
            useLube: false,
            showMotivation: true,
            totalCount: 10,
            experience: 'intermediate',
            actionDelay: 0,
            safetyScore: 100,
            originalDelay: 0
        };
        
        let session = {
            isRunning: false,
            isPaused: false,
            currentCycle: 0,
            insertions: 0,
            startTime: 0,
            pauseTime: 0,
            totalPauseTime: 0,
            intervalId: null,
            timerInterval: null,
            motivationShown: 0
        };
        
        let history = [];
        
        const EXP_MULTIPLIER = {
            beginner: 1.5,
            intermediate: 1.0,
            advanced: 0.7,
            expert: 0.5
        };
        
        const MOTIVATION_MESSAGES = [
            'üí™ ÂÅöÂæóÂæàÂ•ΩÔºÅÁªßÁª≠‰øùÊåÅÊ∏©ÊüîÁöÑËäÇÂ•è',
            'üåü ‰Ω†Ê≠£Âú®‰∫´ÂèóÁæéÂ•ΩÁöÑÊó∂ÂÖâÔºåÊîæÊùæË∫´ÂøÉ',
            '‚ú® Ê≥®ÊÑèÂëºÂê∏ÔºåËÆ©Ë∫´‰ΩìËá™ÁÑ∂ÊîæÊùæ',
            'üíñ ÊÑüÂèóÊØè‰∏ÄÊ¨°ÊÑâÊÇ¶Ôºå‰∫´ÂèóÂΩì‰∏ã',
            'üéØ ËäÇÂ•èÂæàÊ£íÔºÅÁªßÁª≠‰øùÊåÅËøô‰∏™Áä∂ÊÄÅ',
            'üåà ‰Ω†ÂÅöÂæóÈùûÂ∏∏Â•ΩÔºåË∫´‰ΩìÊ≠£Âú®ÈÄÇÂ∫î',
            'üí´ ÊîæÊùæËÇåËÇâÔºåËÆ©‰∏ÄÂàáËá™ÁÑ∂ÊµÅÂä®',
            'ü¶ã Ê∏©ÊüîËÄåÂÖÖÊª°ËÄêÂøÉÔºåËøôÂæàÂÆåÁæé',
            'üå∏ ‰Ω†Ê≠£Âú®ÁÖßÈ°æÂ•ΩËá™Â∑±ÁöÑË∫´‰Ωì',
            '‚≠ê ÁªßÁª≠‰øùÊåÅÔºå‰Ω†ÂÅöÂæóÂæàÊ£íÔºÅ'
        ];
        
        function loadSettings() {
            const saved = StorageManager.loadCurrentSettings();
            if (saved) {
                config = { ...config, ...saved };
                
                document.getElementById('toyLength').value = config.length;
                document.getElementById('lengthSlider').value = config.length;
                document.getElementById('toyDiameter').value = config.diameter;
                document.getElementById('diameterSlider').value = config.diameter;
                document.getElementById('totalCount').value = config.totalCount;
                document.getElementById('experience').value = config.experience;
                document.getElementById('useLube').checked = config.useLube;
                document.getElementById('showMotivation').checked = config.showMotivation;
                
                toggleLube();
                toggleMotivation();
            }
        }
        
        function saveSettings() {
            config.length = parseFloat(document.getElementById('toyLength').value);
            config.diameter = parseFloat(document.getElementById('toyDiameter').value);
            config.totalCount = parseInt(document.getElementById('totalCount').value);
            config.experience = document.getElementById('experience').value;
            
            StorageManager.saveCurrentSettings(config);
        }
        
        function saveToHistory() {
            const settingsSnapshot = {
                length: config.length,
                diameter: config.diameter,
                totalCount: config.totalCount,
                experience: config.experience,
                useLube: config.useLube,
                showMotivation: config.showMotivation
            };
            
            StorageManager.addToHistory(settingsSnapshot);
            displaySettingsHistory();
            showLog('üíæ ÂΩìÂâçËÆæÁΩÆÂ∑≤‰øùÂ≠òÂà∞ÂéÜÂè≤ËÆ∞ÂΩï', 'success');
        }
        
        function displaySettingsHistory() {
            const historyList = document.getElementById('historyList');
            const historySection = document.getElementById('settingsHistory');
            const settingsHistory = StorageManager.getSettingsHistory();
            
            if (settingsHistory.length === 0) {
                historySection.classList.add('hidden');
                return;
            }
            
            historySection.classList.remove('hidden');
            historyList.innerHTML = '';
            
            settingsHistory.forEach(item => {
                const div = document.createElement('div');
                div.className = 'history-item';
                
                const date = new Date(item.timestamp);
                const timeStr = date.toLocaleString('zh-CN', {
                    month: '2-digit',
                    day: '2-digit',
                    hour: '2-digit',
                    minute: '2-digit'
                });
                
                div.innerHTML = `
                    <div>
                        <div>${item.length}cm √ó ${item.diameter}cm | ${item.totalCount}Ê¨° | ${getExpText(item.experience)}</div>
                        <div>
                            ${item.useLube ? 'üíß' : '‚ùå'} 
                            ${item.showMotivation ? 'üí¨' : 'üîá'}
                        </div>
                        <div class="history-timestamp">${timeStr}</div>
                    </div>
                    <div class="history-actions">
                        <button class="btn-mini btn-restore" onclick="restoreSettings(${item.id})">ÊÅ¢Â§ç</button>
                        <button class="btn-mini btn-delete" onclick="deleteHistoryItem(${item.id})">Âà†Èô§</button>
                    </div>
                `;
                
                historyList.appendChild(div);
            });
        }
        
        function restoreSettings(id) {
            const settingsHistory = StorageManager.getSettingsHistory();
            const item = settingsHistory.find(s => s.id === id);
            
            if (item) {
                config = { ...config, ...item };
                
                document.getElementById('toyLength').value = config.length;
                document.getElementById('lengthSlider').value = config.length;
                document.getElementById('toyDiameter').value = config.diameter;
                document.getElementById('diameterSlider').value = config.diameter;
                document.getElementById('totalCount').value = config.totalCount;
                document.getElementById('experience').value = config.experience;
                document.getElementById('useLube').checked = config.useLube;
                document.getElementById('showMotivation').checked = config.showMotivation;
                
                toggleLube();
                toggleMotivation();
                
                saveSettings();
                showLog('üîÑ ËÆæÁΩÆÂ∑≤ÊÅ¢Â§ç', 'success');
            }
        }
        
        function deleteHistoryItem(id) {
            if (confirm('Á°ÆÂÆöË¶ÅÂà†Èô§ËøôÊù°ËÆ∞ÂΩïÂêóÔºü')) {
                StorageManager.deleteHistoryItem(id);
                displaySettingsHistory();
                showLog('üóëÔ∏è ËÆ∞ÂΩïÂ∑≤Âà†Èô§', 'info');
            }
        }
        
        function clearAllHistory() {
            if (confirm('Á°ÆÂÆöË¶ÅÊ∏ÖÁ©∫ÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩïÂêóÔºüÊ≠§Êìç‰Ωú‰∏çÂèØÊÅ¢Â§ç„ÄÇ')) {
                StorageManager.clearHistory();
                displaySettingsHistory();
                showLog('üóëÔ∏è ÊâÄÊúâÂéÜÂè≤ËÆ∞ÂΩïÂ∑≤Ê∏ÖÁ©∫', 'info');
            }
        }
        
        function loadSessionHistory() {
            history = StorageManager.loadSessionHistory();
            if (history.length > 0) {
                updateHistoryChart();
            }
        }
        
        function saveSessionHistory() {
            StorageManager.saveSessionHistory(history);
        }
        
        function getExpText(exp) {
            const texts = {
                beginner: 'ÂàùÂ≠¶',
                intermediate: '‰∏≠Á∫ß',
                advanced: 'È´òÁ∫ß',
                expert: '‰∏ìÂÆ∂'
            };
            return texts[exp] || exp;
        }
        
        document.getElementById('lengthSlider').addEventListener('input', (e) => {
            document.getElementById('toyLength').value = e.target.value;
            saveSettings();
        });
        
        document.getElementById('toyLength').addEventListener('input', (e) => {
            document.getElementById('lengthSlider').value = e.target.value;
        });
        
        document.getElementById('diameterSlider').addEventListener('input', (e) => {
            document.getElementById('toyDiameter').value = e.target.value;
            saveSettings();
        });
        
        document.getElementById('toyDiameter').addEventListener('input', (e) => {
            document.getElementById('diameterSlider').value = e.target.value;
        });
        
        function toggleLube() {
            config.useLube = document.getElementById('useLube').checked;
            const status = document.getElementById('lubeStatus');
            const section = document.getElementById('lubeSection');
            
            if (config.useLube) {
                status.textContent = '‚úÖ Â∑≤‰ΩøÁî®Ê∂¶ÊªëÂâÇ - Êë©Êì¶ÂäõÈôç‰Ωé30%';
                status.classList.add('enabled');
                section.classList.add('active');
            } else {
                status.textContent = 'Êú™‰ΩøÁî®Ê∂¶ÊªëÂâÇ';
                status.classList.remove('enabled');
                section.classList.remove('active');
            }
            
            saveSettings();
        }
        
        function toggleMotivation() {
            config.showMotivation = document.getElementById('showMotivation').checked;
            const status = document.getElementById('motivationStatus');
            const section = document.getElementById('tipsSection');
            
            if (config.showMotivation) {
                status.textContent = 'Â∑≤ÂºÄÂêØ - ‰ºöÊòæÁ§∫ÈºìÂä±ÊèêÁ§∫';
                status.classList.add('enabled');
                section.classList.add('active');
            } else {
                status.textContent = 'Â∑≤ÂÖ≥Èó≠';
                status.classList.remove('enabled');
                section.classList.remove('active');
            }
            
            saveSettings();
        }
        
        function calculateParams() {
            config.length = parseFloat(document.getElementById('toyLength').value);
            config.diameter = parseFloat(document.getElementById('toyDiameter').value);
            config.totalCount = parseInt(document.getElementById('totalCount').value);
            config.experience = document.getElementById('experience').value;
            
            if (config.length < 1 || config.length > 150) {
                showLog('‚ùå ÈïøÂ∫¶ÂøÖÈ°ªÂú® 1-150cm ‰πãÈó¥', 'info');
                return;
            }
            
            if (config.diameter < 0.5 || config.diameter > 10) {
                showLog('‚ùå Áõ¥ÂæÑÂøÖÈ°ªÂú® 0.5-10cm ‰πãÈó¥', 'info');
                return;
            }
            
            if (config.totalCount % 2 !== 0) {
                config.totalCount++;
                document.getElementById('totalCount').value = config.totalCount;
            }
            
            const expMultiplier = EXP_MULTIPLIER[config.experience];
            
            let baseDelay = (config.length / 30) + (config.diameter / 3) + 1.2;
            baseDelay *= expMultiplier;
            config.originalDelay = baseDelay;
            
            if (config.useLube) {
                config.actionDelay = baseDelay * 0.70;
                showLog('üíß Ê∂¶ÊªëÂâÇÊïàÊûú: ÈÄüÂ∫¶ÊèêÂçá 30%', 'success');
            } else {
                config.actionDelay = baseDelay;
            }
            
            let safetyScore = 100;
            
            if (config.length > 100) safetyScore -= 20;
            else if (config.length > 50) safetyScore -= 10;
            
            if (config.diameter > 6) safetyScore -= 25;
            else if (config.diameter > 4) safetyScore -= 15;
            else if (config.diameter > 3) safetyScore -= 5;
            
            if (config.experience === 'beginner' && config.diameter > 4) safetyScore -= 10;
            
            if (config.useLube) {
                safetyScore += 20;
            } else {
                safetyScore -= 25;
            }
            
            config.safetyScore = Math.max(0, Math.min(100, safetyScore));
            
            displayCalculationResults();
            displaySafetyAlert();
            saveToHistory();
            
            document.getElementById('startBtn').disabled = false;
            showLog(`‚úÖ ËÆ°ÁÆóÂÆåÊàê - È¢ëÁéá: ${config.actionDelay.toFixed(2)}Áßí/Ê¨°`, 'success');
        }
        
        function displayCalculationResults() {
            const totalTime = (config.totalCount * config.actionDelay / 60).toFixed(1);
            
            let html = `
                <div class="calculation-result">
                    <h3 style="color: #319795; margin-bottom: 15px;">üìã ËÆ°ÁÆóÁªìÊûú</h3>
                    <div class="result-item">
                        <span>Âä®‰ΩúÈ¢ëÁéá:</span>
                        <span class="result-value">${config.actionDelay.toFixed(2)} Áßí/Ê¨°</span>
                    </div>
                    <div class="result-item">
                        <span>È¢ÑËÆ°ÊÄªÊó∂Èïø:</span>
                        <span class="result-value">${totalTime} ÂàÜÈíü</span>
                    </div>
                    <div class="result-item">
                        <span>ÊèíÂÖ•Ê¨°Êï∞:</span>
                        <span class="result-value">${config.totalCount / 2} Ê¨°</span>
                    </div>
                    <div class="result-item">
                        <span>ÂÆâÂÖ®ËØÑÂàÜ:</span>
                        <span class="result-value" style="color: ${getSafetyColor()}">${config.safetyScore}/100</span>
                    </div>
                </div>
            `;
            
            document.getElementById('calculationResult').innerHTML = html;
            document.getElementById('calculationResult').classList.remove('hidden');
        }
        
        function getSafetyColor() {
            if (config.safetyScore >= 80) return '#48bb78';
            if (config.safetyScore >= 60) return '#ecc94b';
            if (config.safetyScore >= 40) return '#ed8936';
            return '#f56565';
        }
        
        function getSafetyLevel() {
            if (config.safetyScore >= 80) return 'high';
            if (config.safetyScore >= 50) return 'medium';
            return 'low';
        }
        
        function displaySafetyAlert() {
            const level = getSafetyLevel();
            let icon = '‚úÖ';
            let title = 'ÂÆâÂÖ®Á≠âÁ∫ß: ‰ºòÁßÄ';
            let message = 'ÂΩìÂâçÈÖçÁΩÆÈùûÂ∏∏ÂÆâÂÖ®„ÄÇ';
            
            if (level === 'medium') {
                icon = '‚ö†Ô∏è';
                title = 'ÂÆâÂÖ®Á≠âÁ∫ß: ‰∏≠Á≠â';
                message = 'Âª∫ËÆÆ‰ΩøÁî®Ê∂¶ÊªëÂâÇÔºåÁºìÊÖ¢ËøõË°å„ÄÇ';
            } else if (level === 'low') {
                icon = 'üö®';
                title = 'ÂÆâÂÖ®Á≠âÁ∫ß: ËæÉ‰Ωé';
                message = 'Âº∫ÁÉàÂª∫ËÆÆ‰ΩøÁî®Ê∂¶ÊªëÂâÇÔºÅËØ∑ÊûÅÂ∫¶ÁºìÊÖ¢ËøõË°å„ÄÇ';
            }
            
            const html = `
                <div class="safety-alert ${level}">
                    <span class="safety-icon">${icon}</span>
                    <div>
                        <strong>${title}</strong><br>
                        ${message}
                    </div>
                </div>
            `;
            document.getElementById('safetyAlert').innerHTML = html;
            document.getElementById('safetyAlert').classList.remove('hidden');
        }
        
        async function startSession() {
            if (config.actionDelay === 0) {
                showLog('‚ùå ËØ∑ÂÖàËøõË°åÊô∫ËÉΩËÆ°ÁÆó', 'info');
                return;
            }
            
            session = {
                isRunning: true,
                isPaused: false,
                currentCycle: 0,
                insertions: 0,
                startTime: performance.now(),
                pauseTime: 0,
                totalPauseTime: 0,
                intervalId: null,
                timerInterval: null,
                motivationShown: 0
            };
            
            document.getElementById('startBtn').disabled = true;
            document.getElementById('controlButtons').classList.remove('hidden');
            document.getElementById('healthReport').classList.add('hidden');
            
            clearLog();
            showLog('üöÄ ‰ºöËØùÂºÄÂßãÔºÅ', 'success');
            
            startTimer();
            runSession();
        }
        
        async function runSession() {
            while (session.currentCycle < config.totalCount && session.isRunning) {
                if (session.isPaused) {
                    await new Promise(resolve => setTimeout(resolve, 100));
                    continue;
                }
                
                session.currentCycle++;
                
                if (session.currentCycle % 2 === 1) {
                    session.insertions++;
                    const lubeText = config.useLube ? ' [Ê∂¶ÊªëÈ°∫ÁïÖ]' : '';
                    showLog(`‚ô• ‚û§‚û§‚û§ Á¨¨ ${session.insertions} Ê¨°ÊèíÂÖ•${lubeText}`, 'insert');
                    
                    if (config.showMotivation && session.insertions % 3 === 0) {
                        const randomMsg = MOTIVATION_MESSAGES[Math.floor(Math.random() * MOTIVATION_MESSAGES.length)];
                        await sleep(1000);
                        showLog(randomMsg, 'motivation');
                    }
                } else {
                    showLog(`‚ô• ‚üµ‚üµ‚üµ ÂÆåÂÖ®ÊãîÂá∫`, 'withdraw');
                }
                
                updateStats();
                await sleep(config.actionDelay * 1000);
            }
            
            if (session.isRunning) {
                completeSession();
            }
        }
        
        function pauseSession() {
            session.isPaused = !session.isPaused;
            const pauseBtn = document.getElementById('pauseText');
            
            if (session.isPaused) {
                session.pauseTime = performance.now();
                pauseBtn.textContent = 'ÁªßÁª≠';
                showLog('‚è∏Ô∏è ‰ºöËØùÂ∑≤ÊöÇÂÅú', 'info');
            } else {
                session.totalPauseTime += performance.now() - session.pauseTime;
                pauseBtn.textContent = 'ÊöÇÂÅú';
                showLog('‚ñ∂Ô∏è ‰ºöËØùÁªßÁª≠...', 'info');
            }
        }
        
        function stopSession() {
            session.isRunning = false;
            clearInterval(session.timerInterval);
            document.getElementById('controlButtons').classList.add('hidden');
            document.getElementById('startBtn').disabled = false;
            showLog('‚èπÔ∏è ‰ºöËØùÂ∑≤ÂÅúÊ≠¢', 'info');
            updateStats();
        }
        
        function completeSession() {
            session.isRunning = false;
            clearInterval(session.timerInterval);
            
            const duration = Math.floor((performance.now() - session.startTime - session.totalPauseTime) / 1000);
            
            showCelebration();
            showLog(`üéâ ‰ºöËØùÂÆåÊàêÔºÅ`, 'success');
            showLog(`üìä ÊÄªËÆ° ${session.insertions} Ê¨°ÊèíÂÖ•ÔºåÁî®Êó∂ ${formatTime(duration)}`, 'success');
            
            history.push({
                date: new Date().toLocaleString('zh-CN'),
                insertions: session.insertions,
                duration: duration,
                usedLube: config.useLube
            });
            
            saveSessionHistory();
            updateHistoryChart();
            displayHealthReport();
            
            document.getElementById('controlButtons').classList.add('hidden');
            document.getElementById('startBtn').disabled = false;
        }
        
        function displayHealthReport() {
            const html = `
                <div class="health-report">
                    <h3>üè• ‰ºöËØùÂêéÂÅ•Â∫∑Ê£ÄÊü•</h3>
                    
                    <div class="health-item">
                        <strong>ËÇõÈó®ËßÇÂØüÔºö</strong>
                        ${config.useLube ? '‰ΩøÁî®‰∫ÜÊ∂¶ÊªëÂâÇÔºåÂ∫îËØ•ËæÉ‰∏∫ÊπøÊ∂¶„ÄÇ' : '‚ö†Ô∏è Êú™‰ΩøÁî®Ê∂¶ÊªëÂâÇÔºåÈúÄ‰ªîÁªÜÊ£ÄÊü•„ÄÇ'}
                    </div>
                    
                    <div class="health-item">
                        <strong>Âá∫Ë°ÄÊ£ÄÊü•Ôºö</strong>
                        Â∞ëÈáèË°Ä‰∏ùÂ±û‰∫éÊ≠£Â∏∏„ÄÇÂ¶ÇÂá∫Ë°ÄÈáèËæÉÂ§öËØ∑Á´ãÂç≥ÂÅúÊ≠¢Âπ∂Âí®ËØ¢ÂåªÁîü„ÄÇ
                    </div>
                    
                    <div class="health-item">
                        <strong>ËÇ†Ê∂≤ÂàÜÊ≥åÔºö</strong>
                        ÈÄÇÈáèËÇ†Ê∂≤ÂàÜÊ≥åÊòØÊ≠£Â∏∏ÁöÑÁîüÁêÜÂèçÂ∫î„ÄÇ
                    </div>
                    
                    <div class="care-tips">
                        <h4>üí° Êä§ÁêÜ‰∏éÊ∏ÖÊ¥ÅÂª∫ËÆÆ</h4>
                        <ul>
                            <li>Áî®Ê∏©Ê∞¥ËΩªÊüîÊ∏ÖÊ¥óËÇõÈó®Âë®Âõ¥</li>
                            <li>ÈÅøÂÖç‰ΩøÁî®Âà∫ÊøÄÊÄßÊ∏ÖÊ¥ÅÂâÇ</li>
                            <li>Áé©ÂÖ∑‰ΩøÁî®ÂêéÁ´ãÂç≥Ê∏ÖÊ¥óÊ∂àÊØí</li>
                            <li>Âª∫ËÆÆ‰ºëÊÅØ24-48Â∞èÊó∂</li>
                            <li>Â¶ÇÊúâÊåÅÁª≠ÁñºÁóõËØ∑Âí®ËØ¢ÂåªÁîü</li>
                        </ul>
                    </div>
                </div>
            `;
            
            document.getElementById('healthReport').innerHTML = html;
            document.getElementById('healthReport').classList.remove('hidden');
        }
        
        function showCelebration() {
            const celebration = document.createElement('div');
            celebration.className = 'celebration';
            celebration.textContent = 'üéâ';
            document.body.appendChild(celebration);
            setTimeout(() => celebration.remove(), 1000);
        }
        
        function startTimer() {
            session.timerInterval = setInterval(() => {
                if (!session.isPaused && session.isRunning) {
                    const elapsed = Math.floor((performance.now() - session.startTime - session.totalPauseTime) / 1000);
                    document.getElementById('timer').textContent = formatTime(elapsed);
                }
            }, 1000);
        }
        
        function updateStats() {
            const progressPercent = (session.currentCycle / config.totalCount * 100).toFixed(1);
            document.getElementById('progress').textContent = progressPercent + '%';
            document.getElementById('progressBar').style.width = progressPercent + '%';
            document.getElementById('insertCount').textContent = session.insertions;
            
            const remaining = (config.totalCount - session.currentCycle) * config.actionDelay;
            const mins = Math.floor(remaining / 60);
            const secs = Math.floor(remaining % 60);
            document.getElementById('remaining').textContent = `${mins.toString().padStart(2, '0')}:${secs.toString().padStart(2, '0')}`;
        }
        
        function updateHistoryChart() {
            const chartContainer = document.getElementById('historyChart');
            chartContainer.innerHTML = '';
            
            if (history.length === 0) return;
            
            const maxInsertions = Math.max(...history.map(h => h.insertions));
            const recentHistory = history.slice(-10);
            
            recentHistory.forEach((h, i) => {
                const bar = document.createElement('div');
                bar.className = 'chart-bar';
                const height = (h.insertions / maxInsertions) * 100;
                bar.style.height = height + '%';
                
                if (h.usedLube) {
                    bar.style.background = 'linear-gradient(to top, #48bb78, #38a169)';
                } else {
                    bar.style.background = 'linear-gradient(to top, #fc8181, #f56565)';
                }
                
                bar.title = `${h.date}\n${h.insertions} Ê¨°\n${formatTime(h.duration)}\n${h.usedLube ? '‚úÖ Ê∂¶Êªë' : '‚ùå Êó†Ê∂¶Êªë'}`;
                chartContainer.appendChild(bar);
            });
        }
        
        function showLog(message, type = 'info') {
            const log = document.getElementById('logContainer');
            const entry = document.createElement('div');
            const icons = {
                insert: 'üíó',
                withdraw: 'üíô',
                info: '‚ÑπÔ∏è',
                success: '‚úÖ',
                motivation: 'üí¨'
            };
            
            entry.className = `log-entry log-${type}`;
            entry.innerHTML = `
                <span class="log-icon">${icons[type] || '‚ÑπÔ∏è'}</span>
                <span>${new Date().toLocaleTimeString('zh-CN')} - ${message}</span>
            `;
            
            log.appendChild(entry);
            log.scrollTop = log.scrollHeight;
        }
        
        function clearLog() {
            document.getElementById('logContainer').innerHTML = '';
        }
        
        function formatTime(seconds) {
            const h = Math.floor(seconds / 3600).toString().padStart(2, '0');
            const m = Math.floor((seconds % 3600) / 60).toString().padStart(2, '0');
            const s = (seconds % 60).toString().padStart(2, '0');
            return `${h}:${m}:${s}`;
        }
        
        function sleep(ms) {
            return new Promise(resolve => setTimeout(resolve, ms));
        }
/* === üöÄ Á©∂ÊûÅÊÄßËÉΩ‰∏éÈò≤Ê≥ÑÊºèË°•‰∏Å v2.0 === */
(function() {
    console.log("‚ö° Á©∂ÊûÅ‰ºòÂåñË°•‰∏ÅÂ∑≤Ê≥®ÂÖ•...");

    // 1. „ÄêBlob ÂØπË±°ÁõëÊéß„ÄëÈò≤Ê≠¢‰∏ãËΩΩÂõæÁâá‰∫ßÁîüÁöÑ‰∏¥Êó∂Êñá‰ª∂Â†ÜÁßØÂÜÖÂ≠ò
    const activeObjectUrls = new Set();
    const originalCreateObjectURL = window.URL.createObjectURL;
    const originalRevokeObjectURL = window.URL.revokeObjectURL;

    if (originalCreateObjectURL && originalRevokeObjectURL) {
        window.URL.createObjectURL = function(blob) {
            const url = originalCreateObjectURL.call(window.URL, blob);
            activeObjectUrls.add(url);
            return url;
        };

        window.URL.revokeObjectURL = function(url) {
            originalRevokeObjectURL.call(window.URL, url);
            activeObjectUrls.delete(url);
        };
    }

    // 2. „ÄêÊô∫ËÉΩÊó•ÂøóÊà™Êñ≠„ÄëÊâπÈáèÂà†Èô§ËäÇÁÇπÔºåÂáèÂ∞ëÊµèËßàÂô®ÈáçÁªòÊ¨°Êï∞
    const originalShowLog = window.showLog;
    if (typeof originalShowLog === 'function') {
        window.showLog = function(message, type) {
            const logContainer = document.getElementById('logContainer');
            // ÂΩìÊó•ÂøóË∂ÖËøá 60 Êù°Êó∂Ôºå‰∏ÄÊ¨°ÊÄßÂà†ÊéâÂâç 20 Êù°ÔºàÊØîÊØèÊù°Âà†‰∏ÄÊ¨°Êõ¥ÁúÅÊÄßËÉΩÔºâ
            if (logContainer && logContainer.childNodes.length > 60) {
                while (logContainer.childNodes.length > 40) {
                    logContainer.removeChild(logContainer.firstChild);
                }
            }
            originalShowLog(message, type);
        };
    }

    // 3. „ÄêÊö¥ÂäõÊ∏ÖÁêÜÂçèËÆÆ„ÄëÈÄÄÂá∫Êó∂ÊâßË°å‚ÄúÁÑ¶ÂúüÊîøÁ≠ñ‚Äù
    const originalExitApp = window.exitApp;
    if (typeof originalExitApp === 'function') {
        window.exitApp = function() {
            console.log("üßπ ÊâßË°åÊ∑±Â∫¶Ê∏ÖÁêÜ...");

            // A. ÂÅúÊ≠¢‰∏öÂä°ÈÄªËæë
            if (window.session) {
                if (window.session.isRunning && typeof window.stopSession === 'function') {
                    window.stopSession();
                }
                // Êö¥ÂäõÊ∏ÖÈô§ÊâÄÊúâÂ∑≤Áü•ÂÆöÊó∂Âô® ID
                clearInterval(window.session.timerInterval);
                clearInterval(window.session.intervalId);
            }

            // B. Âº∫Âà∂ÂÅúÊ≠¢ÊâãÊüÑËΩÆËØ¢ (ÊûÅÂÖ∂ÈáçË¶ÅÔºåÁúÅ CPU)
            if (window.GamepadController && window.GamepadController.updateInterval) {
                clearInterval(window.GamepadController.updateInterval);
                window.GamepadController.updateInterval = null;
                console.log("üéÆ ÊâãÊüÑËΩÆËØ¢Â∑≤Âº∫Âà∂ÊåÇËµ∑");
            }

            // C. ÈáäÊîæÊâÄÊúâÊú™ÂõûÊî∂ÁöÑ Blob URL (Èò≤Ê≠¢‰∏ãËΩΩÂõæÁâáÂØºËá¥ÁöÑÂÜÖÂ≠òÊ≥ÑÊºè)
            if (activeObjectUrls.size > 0) {
                console.log(`üóëÔ∏è ÈáäÊîæ‰∫Ü ${activeObjectUrls.size} ‰∏™ÊÆãÁïôÂØπË±°ÈìæÊé•`);
                for (const url of activeObjectUrls) {
                    originalRevokeObjectURL.call(window.URL, url);
                }
                activeObjectUrls.clear();
            }

            // D. Ê∏ÖÁêÜÈáçËØïÈòüÂàó
            if (window.ImageLoadManager && window.ImageLoadManager.retryingImages) {
                window.ImageLoadManager.retryingImages.clear();
            }

            // E. Âº∫Âà∂ÂûÉÂúæÂõûÊî∂ËØ±ÂØº (Ê∏ÖÁ©∫ÈáçÊï∞ÊçÆÂèòÈáè)
            if (window.history && window.history.length > 500) {
                 // Ê≥®ÊÑèÔºöËøôÈáåÊòØÊåáÊµèËßàÂô®‰ºöËØùÂéÜÂè≤ÔºåÈÄöÂ∏∏Êó†Ê≥ï‰øÆÊîπÔºåÊ≠§Â§Ñ‰ªÖ‰∏∫Á§∫‰æãÈÄªËæëÔºå
                 // ÂÆûÈôÖ‰∏äÊàë‰ª¨ÂèØ‰ª•Ê∏ÖÁ©∫Â∫îÁî®ÂÜÖÁöÑ history Êï∞ÁªÑ
                 if (Array.isArray(window.historyList)) { // ÂÅáËÆæ‰Ω†‰ª£Á†ÅÈáåÂ≠òËÆ∞ÂΩïÁöÑÊï∞ÁªÑÂè´Ëøô‰∏™
                     window.historyList = []; 
                 }
            }

            // ÊâßË°åÂéüË∑ØËøîÂõû
            originalExitApp();
        };
    }

    // 4. „ÄêÊâãÊüÑÂî§ÈÜí„ÄëËøõÂÖ• App Êó∂ËÆ∞ÂæóÊääÊâãÊüÑÊ£ÄÊµãÈáçÊñ∞ÂºÄËµ∑Êù•
    const originalEnterApp = window.enterApp;
    if (typeof originalEnterApp === 'function') {
        window.enterApp = function() {
            if (window.GamepadController) {
                // ÈáçÊñ∞ÂêØÂä®ÊâãÊüÑËΩÆËØ¢
                window.GamepadController.startUpdate();
            }
            originalEnterApp();
        }
    }

})();
<script>
(function() {
    console.log("üêí Ê≠£Âú®Âä†ËΩΩÊô∫ËÉΩËøêÂä®Ê£ÄÊµãÁ≥ªÁªüÂ¢ûÂº∫Ë°•‰∏Å...");

    // ==========================================
    // 1. ÂÆâÂÖ®‰øÆÂ§ç: Èò≤Ê≠¢ XSS ÊîªÂáª (Log System)
    // ==========================================
    const originalAddLog = window.addLog;
    
    // HTML ËΩ¨‰πâÂ∑•ÂÖ∑
    const escapeHTML = (str) => {
        if (typeof str !== 'string') return str;
        return str.replace(/[&<>'"]/g, 
            tag => ({
                '&': '&amp;',
                '<': '&lt;',
                '>': '&gt;',
                "'": '&#39;',
                '"': '&quot;'
            }[tag]));
    };

    // Âä´ÊåÅ addLog ÂáΩÊï∞
    window.addLog = function(level, message, detail = '') {
        // Âú®Â≠òÂÖ• logs Êï∞ÁªÑÂâçÊ∏ÖÊ¥óÊï∞ÊçÆÔºåÂΩªÂ∫ïÈòªÊñ≠ HTML Ê≥®ÂÖ•
        const safeMessage = escapeHTML(message);
        const safeDetail = escapeHTML(detail);
        return originalAddLog.call(this, level, safeMessage, safeDetail);
    };

    // ==========================================
    // 2. Á®≥ÂÆöÊÄß‰øÆÂ§ç: ËµÑÊ∫êÊ∏ÖÁêÜ‰∏éÂÜÖÂ≠ò‰øùÊä§
    // ==========================================
    const originalStart = window.startDetection;
    const originalStop = window.stopDetection;

    window.stopDetection = function() {
        // ÊâßË°åÂéüÂáΩÊï∞
        originalStop.call(this);
        
        // Â¢ûÂº∫Ê∏ÖÁêÜÔºöÁ°Æ‰øùÊâÄÊúâËΩ®ÈÅìÂÆåÂÖ®ÂÅúÊ≠¢ÔºåÈò≤Ê≠¢Êüê‰∫õÁßªÂä®Á´ØÊµèËßàÂô®Âç≥‰Ωø srcObject=null ‰ªçÂç†Áî®Áõ∏Êú∫
        if (window.video && window.video.srcObject) {
            const tracks = window.video.srcObject.getTracks();
            tracks.forEach(track => track.stop());
            window.video.srcObject = null;
        }
        
        // Âº∫Âà∂ÂûÉÂúæÂõûÊî∂Âª∫ËÆÆ (Ëß£Èô§Â§ßÂØπË±°ÂºïÁî®)
        window.previousImageData = null;
    };

    // ==========================================
    // 3. Ê∏∏ÊàèÊâãÊüÑÊéßÂà∂Á≥ªÁªü (Gamepad System)
    // ==========================================
    
    // Ê†∑ÂºèÊ≥®ÂÖ•
    const style = document.createElement('style');
    style.innerHTML = `
        #gamepad-cursor {
            position: fixed;
            top: 50%;
            left: 50%;
            width: 20px;
            height: 20px;
            background: rgba(255, 255, 255, 0.9);
            border: 2px solid var(--primary-color);
            border-radius: 50%;
            box-shadow: 0 0 15px rgba(0,0,0,0.4);
            pointer-events: none;
            z-index: 99999;
            transform: translate(-50%, -50%);
            display: none;
            transition: opacity 0.2s;
            mix-blend-mode: hard-light;
        }
        #gamepad-cursor::after {
            content: '';
            position: absolute;
            top: 50%;
            left: 50%;
            width: 4px;
            height: 4px;
            background: var(--danger-color);
            border-radius: 50%;
            transform: translate(-50%, -50%);
        }
        #gamepad-cursor.active {
            transform: translate(-50%, -50%) scale(0.9);
            background: var(--primary-color);
            border-color: white;
        }
        /* ÁÇπÂáªÊ≥¢Á∫πÁâπÊïà */
        .cursor-ripple {
            position: fixed;
            border-radius: 50%;
            background: rgba(102, 126, 234, 0.4);
            transform: scale(0);
            animation: ripple 0.5s ease-out;
            pointer-events: none;
            z-index: 99998;
        }
        @keyframes ripple {
            to { transform: scale(3); opacity: 0; }
        }
    `;
    document.head.appendChild(style);

    // ÂàõÂª∫ÂÖâÊ†áÂÖÉÁ¥†
    const cursor = document.createElement('div');
    cursor.id = 'gamepad-cursor';
    document.body.appendChild(cursor);

    // Áä∂ÊÄÅÂèòÈáè
    let cursorX = window.innerWidth / 2;
    let cursorY = window.innerHeight / 2;
    let isCursorVisible = false;
    let lastAF = null;
    let lastButtonState = false; // AÈîÆÁä∂ÊÄÅ
    
    // ÈÖçÁΩÆ
    const DEAD_ZONE = 0.15;
    const CURSOR_SPEED = 12;
    const SCROLL_SPEED = 15;

    // ËæÖÂä©ÔºöÊ®°ÊãüÁÇπÂáª‰∫ã‰ª∂
    function simulateClick(x, y) {
        // ÂàõÂª∫Ê≥¢Á∫π
        const ripple = document.createElement('div');
        ripple.className = 'cursor-ripple';
        ripple.style.left = (x - 25) + 'px';
        ripple.style.top = (y - 25) + 'px';
        ripple.style.width = '50px';
        ripple.style.height = '50px';
        document.body.appendChild(ripple);
        setTimeout(() => ripple.remove(), 550);

        // Ëé∑ÂèñÁõÆÊ†áÂÖÉÁ¥†
        const element = document.elementFromPoint(x, y);
        if (element) {
            // ‰ºòÂÖàËß¶Âèë click
            element.click();
            
            // ÈíàÂØπ range input (ÊªëÂùó) ÁöÑÁâπÊÆäÂ§ÑÁêÜ
            if (element.tagName === 'INPUT' && element.type === 'range') {
                element.focus();
                // Â∞ùËØïËß¶Âèë input ‰∫ã‰ª∂Êõ¥Êñ∞ÊªëÂùó UI
                // Ê≥®ÊÑèÔºöÁî±‰∫éÂÆâÂÖ®ÈôêÂà∂ÔºåÂÆåÂÖ®Ê®°ÊãüÊãñÊãΩÂæàÈöæÔºåËøôÈáå‰ªÖÂÅöÁÇπÂáªËß¶Âèë
                element.dispatchEvent(new Event('input', { bubbles: true }));
                element.dispatchEvent(new Event('change', { bubbles: true }));
            }
        }
    }

    // Ê†∏ÂøÉÂæ™ÁéØ
    function gameLoop() {
        const gamepads = navigator.getGamepads ? navigator.getGamepads() : [];
        const gp = gamepads[0] || gamepads[1] || gamepads[2] || gamepads[3]; // ÈÅçÂéÜÂØªÊâæ‰ªªÊÑèËøûÊé•ÁöÑÊâãÊüÑ

        if (gp) {
            // 1. Â§ÑÁêÜÂÖâÊ†áÊòæÈöêÔºöÂè™ÊúâÂä®‰∫ÜÊâçÊòæÁ§∫
            const hasInput = Math.abs(gp.axes[0]) > DEAD_ZONE || Math.abs(gp.axes[1]) > DEAD_ZONE || gp.buttons.some(b => b.pressed);
            
            if (!isCursorVisible && hasInput) {
                isCursorVisible = true;
                cursor.style.display = 'block';
                // ÂàùÂßã‰ΩçÁΩÆÈáçÁΩÆÂà∞Â±èÂπï‰∏≠ÂøÉ
                cursorX = window.innerWidth / 2;
                cursorY = window.innerHeight / 2;
            }

            if (isCursorVisible) {
                // 2. Â∑¶ÊëáÊùÜÊéßÂà∂ÂÖâÊ†áÁßªÂä® (Axes 0, 1)
                const axisX = gp.axes[0];
                const axisY = gp.axes[1];

                if (Math.abs(axisX) > DEAD_ZONE) cursorX += axisX * CURSOR_SPEED;
                if (Math.abs(axisY) > DEAD_ZONE) cursorY += axisY * CURSOR_SPEED;

                // ËæπÁïåÈôêÂà∂
                cursorX = Math.max(0, Math.min(window.innerWidth, cursorX));
                cursorY = Math.max(0, Math.min(window.innerHeight, cursorY));

                // Êõ¥Êñ∞ËßÜËßâ
                cursor.style.left = cursorX + 'px';
                cursor.style.top = cursorY + 'px';

                // 3. AÈîÆÁÇπÂáª (Button 0 - Xbox A / PS X)
                const btnA = gp.buttons[0];
                if (btnA.pressed && !lastButtonState) {
                    cursor.classList.add('active');
                    simulateClick(cursorX, cursorY);
                } else if (!btnA.pressed && lastButtonState) {
                    cursor.classList.remove('active');
                }
                lastButtonState = btnA.pressed;

                // 4. RT ÁºìÊÖ¢Âêë‰∏äÁøªÈ°µ (Button 7 / Axis)
                // Xbox: RT is Button 7 (Analog). PS: R2 is Button 7.
                const btnRT = gp.buttons[7];
                const rtValue = (typeof btnRT === 'object') ? btnRT.value : btnRT;
                
                if (btnRT && (btnRT.pressed || rtValue > 0.1)) {
                    window.scrollBy({
                        top: -SCROLL_SPEED * (rtValue || 0.5),
                        behavior: 'auto'
                    });
                }

                // 5. RB ÁºìÊÖ¢ÂæÄ‰∏ãÁøªÈ°µ (Button 5 - RB / R1)
                const btnRB = gp.buttons[5];
                if (btnRB && btnRB.pressed) {
                    window.scrollBy({
                        top: SCROLL_SPEED,
                        behavior: 'auto'
                    });
                }
            }
        }

        lastAF = requestAnimationFrame(gameLoop);
    }

    // ÂêØÂä®ÁõëÂê¨
    window.addEventListener("gamepadconnected", (e) => {
        addLog('success', 'Â§ñÈÉ®ËÆæÂ§áÂ∑≤ËøûÊé•', `Ê£ÄÊµãÂà∞Ê∏∏ÊàèÊâãÊüÑ: ${e.gamepad.id}`);
        showToast('üéÆ ÊâãÊüÑÂ∑≤ËøûÊé•');
        // Á°Æ‰øùÂæ™ÁéØÂè™ÂêØÂä®‰∏ÄÊ¨°
        if (!lastAF) gameLoop();
    });

    window.addEventListener("gamepaddisconnected", (e) => {
        addLog('warning', 'Â§ñÈÉ®ËÆæÂ§áÊñ≠ÂºÄ', 'Ê∏∏ÊàèÊâãÊüÑËøûÊé•‰∏¢Â§±');
        showToast('üö´ ÊâãÊüÑÂ∑≤Êñ≠ÂºÄ');
        // ÂèØÈÄâÔºöÊñ≠ÂºÄÂêéÈöêËóèÂÖâÊ†á
        cursor.style.display = 'none';
        isCursorVisible = false;
    });

    // È°µÈù¢Âä†ËΩΩÊó∂Ëã•Â∑≤ÊúâÊâãÊüÑËøûÊé•ÔºåÁõ¥Êé•ÂêØÂä®
    if (navigator.getGamepads && (navigator.getGamepads()[0] || navigator.getGamepads()[1])) {
        gameLoop();
    }

})();
</script>
</body>
</html>
